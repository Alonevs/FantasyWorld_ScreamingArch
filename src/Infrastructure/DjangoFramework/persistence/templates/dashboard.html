{% extends "layouts/base.html" %}
{% load static %}
{% load rbac_tags %}

{% block title %}ECLAI | Dashboard{% endblock %}

{% block content %}
    <div class="max-w-7xl mx-auto pb-24 px-4 pt-6">
        
        <form id="bulk-delete-form" method="POST" action="{% url 'borrar_propuestas_masivo' %}">
            {% csrf_token %}
            
            <!-- FILTER BAR (UNIFIED CONTROL CENTER) -->
            <div class="mb-8 bg-gray-900/50 p-4 rounded-xl border border-white/5 backdrop-blur-sm flex flex-col md:flex-row gap-4 items-center justify-between">
                <div class="flex items-center gap-2 w-full md:w-auto">
                    <span class="text-2xl">üéõÔ∏è</span>
                    <h2 class="text-lg font-bold text-white">Centro de Control</h2>
                </div>

                <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                    <!-- 1. SEARCH -->
                    <div class="relative group">
                        <span class="absolute left-3 top-2.5 text-gray-500 group-focus-within:text-blue-400">üîç</span>
                        <input type="text" name="q" value="{{ search_query|default:'' }}" 
                               form="filter-form"
                               placeholder="Buscar por nombre..." 
                               class="bg-black/40 border border-white/10 rounded-lg py-2 pl-9 pr-4 text-sm text-white w-full md:w-64 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all">
                    </div>

                    <!-- 2. FILTER BY USER (Jurisdiction) -->
                    <select name="author" form="filter-form" class="bg-black/40 border border-white/10 rounded-lg py-2 px-3 text-sm text-gray-300 focus:border-blue-500 outline-none cursor-pointer hover:bg-white/5 transition-colors [&>option]:bg-gray-900 [&>option]:text-gray-300">
                        <option value="">üë§ Todos los Autores</option>
                        {% for user in available_authors %}
                            <option value="{{ user.id }}" {% if current_author == user.id %}selected{% endif %}>
                                {{ user.username }} {% if user == request.user %}(T√∫){% endif %}
                            </option>
                        {% endfor %}
                    </select>

                    <!-- 3. FILTER BY TYPE -->
                    <select name="type" form="filter-form" class="bg-black/40 border border-white/10 rounded-lg py-2 px-3 text-sm text-gray-300 focus:border-blue-500 outline-none cursor-pointer hover:bg-white/5 transition-colors [&>option]:bg-gray-900 [&>option]:text-gray-300">
                        <option value="">üìÇ Todo el Contenido</option>
                        <option value="WORLD" {% if current_type == 'WORLD' %}selected{% endif %}>üåç Mundos</option>
                        <option value="NARRATIVE" {% if current_type == 'NARRATIVE' %}selected{% endif %}>üìñ Narrativas</option>
                        <option value="IMAGE" {% if current_type == 'IMAGE' %}selected{% endif %}>üñºÔ∏è Im√°genes</option>
                    </select>

                    <!-- SUBMIT -->
                    <button type="submit" form="filter-form" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg text-sm transition shadow-lg">
                        Filtrar
                    </button>
                    
                    {% if search_query or current_author or current_type %}
                    <a href="{% url 'dashboard' %}" class="bg-red-900/40 hover:bg-red-900/60 text-red-300 py-2 px-3 rounded-lg text-sm transition border border-red-800/50 flex items-center justify-center">
                        ‚úï
                    </a>
                    {% endif %}
                </div>
            </div>
            
            <!-- Hidden Form for GET Filters -->
            <form id="filter-form" method="GET" action="{% url 'dashboard' %}"></form>





            <!-- METRICS SUMMARY (KPIs) -->
            {% include "components/_dashboard_metrics.html" %}

            <!-- INBOX (PENDING) -->
            <div class="mb-12" x-data="{ selectionCount: 0 }" @change="selectionCount = document.querySelectorAll('.pending-check:checked').length">
                
                <form id="bulk-approve-form" method="post" action="{% url 'aprobar_propuestas_masivo' %}">{% csrf_token %}</form>

                <h2 class="text-2xl font-bold text-white mb-6 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <span>üì¨ Propuestas Pendientes</span>
                        <span class="text-xs bg-blue-900/50 text-blue-300 px-3 py-1 rounded-full border border-blue-800">{{ total_pending_count }}</span>
                    </div>

                    <div class="flex items-center gap-2">
                        <!-- BULK VIEW (Images only) -->
                        <button type="submit" form="bulk-approve-form" 
                                formaction="{% url 'batch_revisar_imagenes' %}"
                                class="text-xs bg-indigo-900/30 hover:bg-indigo-600 text-indigo-400 hover:text-white px-3 py-1.5 rounded border border-indigo-900/50 transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                :disabled="selectionCount === 0"
                                title="Ver im√°genes seleccionadas">
                            <span>üëÅÔ∏è</span> Ver (<span x-text="selectionCount"></span>)
                        </button>

                        <!-- BULK APPROVE BUTTON -->
                        {% if request.user.is_superuser or request.user.profile.rank == 'ADMIN' %}
                        <button type="submit" form="bulk-approve-form" 
                                class="text-xs bg-green-900/30 hover:bg-green-600 text-green-400 hover:text-white px-3 py-1.5 rounded border border-green-900/50 transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                :disabled="selectionCount === 0"
                                title="Aprobar seleccionados"
                                onclick="return confirm('¬øAprobar todas las propuestas seleccionadas?')">
                            <span>‚úÖ</span> Aprobar (<span x-text="selectionCount"></span>)
                        </button>
                        {% endif %}
                        <!-- BULK AGREGADO: RECHAZAR/BORRAR PROPUESTA -->
                        {% if request.user.is_superuser or request.user.profile.rank == 'ADMIN' %}
                        <button type="submit" form="bulk-approve-form" 
                                formaction="{% url 'borrar_propuestas_masivo' %}"
                                class="text-xs bg-red-900/30 hover:bg-red-600 text-red-400 hover:text-white px-3 py-1.5 rounded border border-red-900/50 transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                :disabled="selectionCount === 0"
                                title="Rechazar/Borrar seleccionados"
                                onclick="return confirm('¬øRECHAZAR/BORRAR todas las propuestas seleccionadas? (Se eliminar√°n de la lista)')">
                            <span>‚úï</span> Rechazar (<span x-text="selectionCount"></span>)
                        </button>
                        {% endif %}
                    </div>
                </h2>
                <p class="text-gray-500 mb-6 text-sm">Propuestas de tu equipo que requieren revisi√≥n y aprobaci√≥n.</p>

                {% if pending and grouped_inbox %}

                    <div class="space-y-6">
                        {% for group in grouped_inbox %}
                        <div x-data="{ expanded: true }" class="flex flex-col bg-[#0f111a] border border-gray-800 rounded-xl overflow-hidden shadow-lg transition-all duration-300">
                            
                            <!-- TOP: AUTHOR HEADER (HORIZONTAL) -->
                            <div @click="expanded = !expanded" class="w-full bg-gray-900/80 p-3 flex items-center justify-between border-b border-gray-800 cursor-pointer hover:bg-gray-800/80 transition-colors select-none">
                                <div class="flex items-center gap-3">
                                    <div class="relative">
                                        <div class="w-10 h-10 rounded-full bg-indigo-900 flex items-center justify-center text-sm text-white font-bold shadow-lg ring-2 ring-indigo-500/30">
                                            {% if group.author %}{{ group.author.username|slice:":1"|upper }}{% else %}?{% endif %}
                                        </div>
                                        <span class="absolute -bottom-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-blue-600 text-[10px] text-white font-mono border border-gray-900">
                                            {{ group.count }}
                                        </span>
                                    </div>
                                    <div class="flex flex-col leading-tight">
                                        <span class="text-blue-400 font-bold text-sm" title="{% if group.author %}{{ group.author.username }}{% else %}Sistema{% endif %}">
                                            {% if group.author %}{{ group.author.username }}{% else %}Sistema{% endif %}
                                        </span>
                                        <span class="text-xs text-gray-500 font-mono">
                                            {{ group.proposals|length }} propuestas pendientes
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Toggle Icon -->
                                <button class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10 text-gray-400 transition-transform duration-300" :class="{'rotate-180': expanded}">
                                    ‚ñº
                                </button>
                            </div>

                            <!-- BOTTOM: PROPOSALS LIST -->
                            <div class="flex-1 divide-y divide-gray-800/50 bg-black/20">
                                {% for item in group.proposals %}
                                <!-- Item Container: 5 items always visible, others toggle -->
                                <div {% if forloop.counter > 5 %}x-show="expanded" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 -translate-y-2" x-transition:enter-end="opacity-100 translate-y-0" x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100 translate-y-0" x-transition:leave-end="opacity-0 -translate-y-2"{% endif %} class="p-4 hover:bg-white/5 transition-colors flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 group">
                                    <!-- CHECKBOX -->
                                    <div class="flex items-center justify-center pt-1 pl-1">
                                        <input type="checkbox" form="bulk-approve-form" 
                                               name="{% if item.type == 'WORLD' %}selected_ids{% elif item.type == 'NARRATIVE' %}selected_narr_ids{% else %}selected_img_ids{% endif %}" 
                                               value="{{ item.id }}" 
                                               class="pending-check w-4 h-4 rounded border-gray-600 bg-gray-700 text-green-500 focus:ring-green-500/50 cursor-pointer transition">
                                    </div>

                                    <!-- INFO -->
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <!-- TYPE BADGE -->
                                            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold border opacity-80
                                                {% if item.type == 'WORLD' %} bg-blue-900/20 text-blue-400 border-blue-900/50
                                                {% elif item.type == 'NARRATIVE' %} bg-purple-900/20 text-purple-400 border-purple-900/50
                                                {% elif item.type == 'IMAGE' %} bg-pink-900/20 text-pink-400 border-pink-900/50
                                                {% else %} bg-gray-800 text-gray-400 border-gray-700 {% endif %}">
                                                {{ item.type_label }}
                                            </span>
                                            
                                            <a href="{% if item.type == 'IMAGE' %}{% url 'revisar_imagen' item.id %}{% else %}{% url 'review_proposal' item.type item.id %}{% endif %}" class="text-gray-200 font-bold hover:text-blue-400 hover:underline truncate transition-colors text-sm">
                                                {{ item.target_name|default:"(Sin Nombre)" }}
                                            </a>
                                            <span class="text-[10px] text-gray-600 font-mono">v{{ item.version_number }}</span>
                                        </div>
                                        
                                        <div class="flex items-center gap-2 text-xs text-gray-500">
                                            {% if item.change_log %}
                                            <span class="italic text-gray-400">"{{ item.change_log|truncatechars:60 }}"</span>
                                            {% endif %}
                                            
                                            <!-- Time Ago (New) -->
                                            <span class="ml-auto text-[10px] text-gray-600 font-mono">{{ item.created_at|timesince }} ago</span>
                                        </div>
                                    </div>

                                    <!-- QUICK ACTIONS -->
                                    <div class="flex items-center gap-2 shrink-0 opacity-80 group-hover:opacity-100 transition-opacity">
                                        
                                        {% if item.action == 'DELETE' %}
                                            <!-- DELETE LOGIC: Green=Keep (Reject Proposal), Red=Delete (Approve Proposal) -->
                                            
                                            <!-- Green: MANTENER (Reject deletion) -->
                                            <form method="post" action="{% if item.type == 'WORLD' %}{% url 'rechazar_propuesta' item.id %}{% elif item.type == 'NARRATIVE' %}{% url 'rechazar_narrativa' item.id %}{% elif item.type == 'IMAGE' %}{% url 'rechazar_imagen' item.id %}{% endif %}">
                                                {% csrf_token %}
                                                <button type="submit" class="text-green-500 hover:text-white hover:bg-green-600 px-3 py-1.5 rounded text-xs font-bold transition-all border border-green-900/30 hover:border-green-500 shadow-lg shadow-green-900/10 flex items-center gap-1" title="Mantener (Rechazar borrado)" onclick="return confirm('¬øMantener este elemento y cancelar el borrado?')">
                                                    <span>üõ°Ô∏è</span> Mantener
                                                </button>
                                            </form>
                                            
                                            <!-- RESTORE BUTTON (Active only) -->
                                        <form method="post" action="{% if item.type == 'WORLD' %}{% url 'aprobar_version' item.id %}{% elif item.type == 'NARRATIVE' %}{% url 'aprobar_narrativa' item.id %}{% elif item.type == 'IMAGE' %}{% url 'aprobar_imagen' item.id %}{% endif %}">
                                            {% csrf_token %}
                                            <button type="submit" class="text-red-500 hover:text-white hover:bg-red-600 px-3 py-1.5 rounded text-xs font-bold transition-all border border-red-900/30 hover:border-red-500 shadow-lg shadow-red-900/10 flex items-center gap-1" title="Confirmar Borrado Definitivo" onclick="return confirm('‚ö†Ô∏è ¬øCONFIRMAR BORRADO? Esta acci√≥n eliminar√° el elemento.')">
                                                <span>üíÄ</span> Borrar
                                            </button>
                                        </form>

                                        {% else %}
                                            <!-- STANDARD LOGIC: Green=Approve, Red=Reject -->
                                            
                                            <!-- Approve (Step 1) -->
                                            <!-- Approve (Step 1) -->
                                            {% if request.user|can_approve:item %}
                                            <form method="post" action="{% if item.type == 'WORLD' %}{% url 'aprobar_version' item.id %}{% elif item.type == 'NARRATIVE' %}{% url 'aprobar_narrativa' item.id %}{% elif item.type == 'IMAGE' %}{% url 'aprobar_imagen' item.id %}{% endif %}">
                                                {% csrf_token %}
                                                <button type="submit" class="text-green-500 hover:text-white hover:bg-green-600 px-3 py-1.5 rounded text-xs font-bold transition-all border border-green-900/30 hover:border-green-500 shadow-lg shadow-green-900/10" title="Aprobar" onclick="return confirm('¬øAprobar esta propuesta?')">
                                                    Aprobar
                                                </button>
                                            </form>
                                            {% endif %}
                                            
                                            <!-- Review (Images in New Tab) -->
                                            <a href="{% url 'review_proposal' item.type item.id %}" {% if item.type == 'IMAGE' %}target="_blank"{% endif %} class="flex items-center gap-2 bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs font-bold px-3 py-2 rounded border border-gray-700 transition-all shadow-lg" title="Ver detalle">
                                                <span>üëÅÔ∏è</span> <span class="hidden sm:inline">Ver</span>
                                            </a>

                                            <!-- Reject (New) -->
                                            <!-- Reject (New) -->
                                            {% if request.user|can_approve:item %}
                                            <form method="post" action="{% if item.type == 'WORLD' %}{% url 'rechazar_propuesta' item.id %}{% elif item.type == 'NARRATIVE' %}{% url 'rechazar_narrativa' item.id %}{% elif item.type == 'IMAGE' %}{% url 'rechazar_imagen' item.id %}{% endif %}">
                                                {% csrf_token %}
                                                <button type="submit" class="text-red-500 hover:text-white hover:bg-red-600 px-3 py-1.5 rounded text-xs font-bold transition-all border border-red-900/30 hover:border-red-500 shadow-lg shadow-red-900/10" onclick="return confirm('¬øRechazar definitivamente?')">
                                                    ‚úï
                                                </button>
                                            </form>
                                            {% endif %}
                                        {% endif %}

                                        <!-- Review Button for DELETE? Usually helpful to see what is being deleted.
                                             If in DELETE mode, I replaced the block, so button missing.
                                             I should add "Ver" button to DELETE block too. -->
                                        {% if item.action == 'DELETE' %}
                                            <a href="{% url 'review_proposal' item.type item.id %}" {% if item.type == 'IMAGE' %}target="_blank"{% endif %} class="flex items-center gap-2 bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs font-bold px-3 py-2 rounded border border-gray-700 transition-all shadow-lg" title="Ver detalle">
                                                <span>üëÅÔ∏è</span>
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-12 bg-card border border-dashed border-gray-800 rounded-xl">
                        <div class="text-4xl mb-4 opacity-50">üì≠</div>
                        <h3 class="text-lg font-bold text-gray-400 mb-1">Buz√≥n vac√≠o</h3>
                        <p class="text-gray-600 text-sm">No hay propuestas de tu equipo pendientes de revisi√≥n.</p>
                    </div>
                {% endif %}
            </div>

            <!-- APROBADAS (READY TO PUBLISH/LIVE) -->
            {% if approved %}
            <div class="mb-16" x-data="{ selectionCount: 0 }" @change="selectionCount = document.querySelectorAll('.approved-check:checked').length">
                
                <form id="bulk-archive-approved-form" method="post" action="{% url 'archivar_propuestas_masivo' %}">{% csrf_token %}</form>

                <h2 class="text-2xl font-bold text-green-400 mb-4 flex justify-between items-center">
                     <div class="flex items-center gap-3">
                        <span>‚úÖ Aprobadas (Listas para Live)</span>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <!-- BULK VIEW (Images only) -->
                        <button type="submit" form="bulk-archive-approved-form" 
                                formaction="{% url 'batch_revisar_imagenes' %}"
                                class="text-xs bg-indigo-900/30 hover:bg-indigo-600 text-indigo-400 hover:text-white px-3 py-1.5 rounded border border-indigo-900/50 transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                :disabled="selectionCount === 0"
                                title="Ver im√°genes seleccionadas">
                            <span>üëÅÔ∏è</span> Ver (<span x-text="selectionCount"></span>)
                        </button>

                        <!-- BULK PUBLISH & ARCHIVE -->
                        {% if request.user.is_superuser or request.user.profile.rank == 'ADMIN' %}
                        <button type="submit" form="bulk-archive-approved-form" 
                                formaction="{% url 'archivar_propuestas_masivo' %}"
                                class="text-xs bg-yellow-900/30 hover:bg-yellow-600 text-yellow-500 hover:text-white px-3 py-1.5 rounded border border-yellow-900/50 transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                :disabled="selectionCount === 0"
                                title="Archivar seleccionados"
                                onclick="return confirm('¬øArchivar propuestas seleccionadas? (Se mover√°n al historial sin publicar)')">
                            <span>üì¶</span> Archivar (<span x-text="selectionCount"></span>)
                        </button>

                        <button type="submit" form="bulk-archive-approved-form" 
                                formaction="{% url 'publicar_propuestas_masivo' %}"
                                class="text-xs bg-blue-900/30 hover:bg-blue-600 text-blue-400 hover:text-white px-3 py-1.5 rounded border border-blue-900/50 transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                :disabled="selectionCount === 0"
                                title="Publicar seleccionados a LIVE"
                                onclick="return confirm('¬øPUBLICAR seleccionados a LIVE? (Se archivar√°n las versiones actuales)')">
                            <span>üöÄ</span> Publicar (<span x-text="selectionCount"></span>)
                        </button>
                        {% endif %}
                    </div>
                </h2>
                <div id="approved-list" class="space-y-6">
                    {% if grouped_approved %}
                        {% for group in grouped_approved %}
                        <div x-data="{ expanded: false }" class="flex flex-col bg-[#0f111a] border border-gray-800 rounded-xl overflow-hidden shadow-lg transition-all duration-300 opacity-90 hover:opacity-100">
                            
                            <!-- TOP: AUTHOR HEADER (HORIZONTAL) -->
                            <div @click="expanded = !expanded" class="w-full bg-gray-900/80 p-3 flex items-center justify-between border-b border-gray-800 cursor-pointer hover:bg-gray-800/80 transition-colors select-none">
                                <div class="flex items-center gap-3">
                                    <div class="relative">
                                        <div class="w-10 h-10 rounded-full bg-indigo-900 flex items-center justify-center text-sm text-white font-bold shadow-lg ring-2 ring-indigo-500/30">
                                            {% if group.author %}{{ group.author.username|slice:":1"|upper }}{% else %}?{% endif %}
                                        </div>
                                        <span class="absolute -bottom-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-blue-600 text-[10px] text-white font-mono border border-gray-900">
                                            {{ group.count }}
                                        </span>
                                    </div>
                                    <div class="flex flex-col leading-tight">
                                        <span class="text-blue-400 font-bold text-sm" title="{% if group.author %}{{ group.author.username }}{% else %}Sistema{% endif %}">
                                            {% if group.author %}{{ group.author.username }}{% else %}Sistema{% endif %}
                                        </span>
                                        <span class="text-xs text-gray-500 font-mono">
                                            {{ group.proposals|length }} aprobadas, listas para live
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Toggle Icon -->
                                <button class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10 text-gray-400 transition-transform duration-300" :class="{'rotate-180': expanded}">
                                    ‚ñº
                                </button>
                            </div>

                            <!-- BOTTOM: PROPOSALS LIST -->
                            <div class="flex-1 divide-y divide-gray-800/50 bg-black/20">
                                {% for item in group.proposals %}
                                <!-- Item Container: 5 visible -->
                                <div {% if forloop.counter > 5 %}x-show="expanded" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 -translate-y-2" x-transition:enter-end="opacity-100 translate-y-0" x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100 translate-y-0" x-transition:leave-end="opacity-0 -translate-y-2"{% endif %} class="p-4 hover:bg-white/5 transition-colors flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 group">
                                    <!-- CHECKBOX -->
                                    <div class="flex items-center justify-center pt-1 pl-1">
                                        <input type="checkbox" form="bulk-archive-approved-form" 
                                               name="{% if item.type == 'WORLD' %}selected_ids{% elif item.type == 'NARRATIVE' %}selected_narr_ids{% else %}selected_img_ids{% endif %}" 
                                               value="{{ item.id }}" 
                                               class="approved-check w-4 h-4 rounded border-gray-600 bg-gray-700 text-yellow-500 focus:ring-yellow-500/50 cursor-pointer transition">
                                    </div>

                                    <!-- INFO -->
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold border opacity-80
                                                {% if item.type == 'WORLD' %} bg-blue-900/20 text-blue-400 border-blue-900/50
                                                {% elif item.type == 'NARRATIVE' %} bg-purple-900/20 text-purple-400 border-purple-900/50
                                                {% elif item.type == 'IMAGE' %} bg-pink-900/20 text-pink-400 border-pink-900/50
                                                {% else %} bg-gray-800 text-gray-400 border-gray-700 {% endif %}">
                                                {{ item.type_label }}
                                            </span>
                                            
                                            <a href="{% url 'review_proposal' item.type item.id %}" class="text-white font-bold hover:text-green-400 hover:underline truncate transition-colors text-sm">
                                                {{ item.target_name|default:"(Sin Nombre)" }}
                                            </a>
                                            <span class="text-[10px] text-green-500 font-mono border border-green-500/30 px-1 rounded bg-green-900/20">READY</span>
                                            
                                            <!-- Time Ago -->
                                            <span class="ml-auto text-[10px] text-gray-600 font-mono">{{ item.created_at|timesince }} ago</span>
                                        </div>
                                        

                                    </div>

                                    <!-- QUICK ACTIONS (APPROVED) -->
                                    <div class="flex items-center gap-2 shrink-0">
                                         <!-- Preview -->
                                        <a href="{% if item.type == 'IMAGE' %}{% url 'revisar_imagen' item.id %}{% else %}{% url 'review_proposal' item.type item.id %}{% endif %}" class="flex items-center gap-2 bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs font-bold px-3 py-2 rounded border border-gray-700 transition-all shadow-lg" title="Ver detalle sin publicar">
                                            <span>üëÅÔ∏è</span> <span class="hidden sm:inline">Ver</span>
                                        </a>

                                         <!-- Archive -->
                                        <form method="post" action="{% if item.type == 'WORLD' %}{% url 'archivar_propuesta' item.id %}{% elif item.type == 'NARRATIVE' %}{% url 'archivar_narrativa' item.id %}{% elif item.type == 'IMAGE' %}{% url 'archivar_imagen' item.id %}{% endif %}">
                                            {% csrf_token %}
                                            <button type="submit" class="flex items-center gap-2 bg-gray-800 hover:bg-yellow-900/30 text-yellow-500 hover:text-yellow-300 text-xs font-bold px-3 py-2 rounded border border-gray-700 hover:border-yellow-700/50 transition-all shadow-lg" title="Archivar (Quitar de la lista)" onclick="return confirm('¬øArchivar esta propuesta? (Podr√°s verla en el historial)')">
                                                <span>üì¶</span>
                                            </button>
                                        </form>

                                         <!-- Publish (Step 2) -->
                                        {% if user|can_publish:item %}
                                        <form method="post" action="{% if item.type == 'WORLD' %}{% url 'publicar_version' item.id %}{% elif item.type == 'IMAGE' %}{% url 'publicar_imagen' item.id %}{% else %}{% url 'publicar_narrativa' item.id %}{% endif %}">
                                            {% csrf_token %}
                                            <button type="submit" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold px-4 py-2 rounded shadow-[0_0_15px_rgba(37,99,235,0.3)] transition-all hover:-translate-y-0.5" onclick="return confirm('¬øPUBLICAR v{{ item.version_number }} EN LIVE? (Se archivar√° la versi√≥n actual)')">
                                                <span>üöÄ</span> Publicar LIVE
                                            </button>
                                        </form>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-gray-600 text-sm italic">No hay propuestas aprobadas listas para publicar.</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
    
            <!-- RECHAZADAS (REJECTED) -->
            {% if rejected %}
            <div class="mb-16" x-data="{ selectionCount: 0 }" @change="selectionCount = document.querySelectorAll('.rejected-check:checked').length">
                
                <form id="bulk-rejected-form" method="post" action="{% url 'borrar_propuestas_masivo' %}">{% csrf_token %}</form>

                <h2 class="text-2xl font-bold text-red-400 mb-4 flex justify-between items-center">
                     <div class="flex items-center gap-3">
                        <span>‚ùå Rechazadas (√öltimas 10)</span>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <!-- BULK RESTORE -->
                        <button type="submit" form="bulk-rejected-form" 
                                formaction="{% url 'borrar_propuestas_masivo' %}" 
                                name="action_type" value="restore" 
                                class="text-xs bg-blue-900/30 hover:bg-blue-600 text-blue-400 hover:text-white px-3 py-1.5 rounded border border-blue-900/50 transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                :disabled="selectionCount === 0"
                                onclick="return confirm('¬øRestaurar seleccionados a PENDIENTES?')">
                            <span>üîÑ</span> Restaurar (<span x-text="selectionCount"></span>)
                        </button>

                        <!-- BULK HARD DELETE (Superuser only) -->
                        {% if request.user.is_superuser %}
                        <button type="submit" form="bulk-rejected-form" 
                                formaction="{% url 'borrar_propuestas_masivo' %}" 
                                name="action_type" value="hard_delete" 
                                class="text-xs bg-red-900/30 hover:bg-red-600 text-red-500 hover:text-white px-3 py-1.5 rounded border border-red-900/50 transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-red-900/20"
                                :disabled="selectionCount === 0"
                                onclick="return confirm('‚ö†Ô∏è PELIGRO ‚ö†Ô∏è\n\n¬øBORRAR DEFINITIVAMENTE del registro?\n\nEsta acci√≥n NO se puede deshacer.')">
                            <span>üíÄ</span> Borrar (<span x-text="selectionCount"></span>)
                        </button>
                        {% endif %}
                    </div>
                </h2>

                <div class="space-y-6">
                    {% if grouped_rejected %}
                        {% for group in grouped_rejected %}
                        <div x-data="{ expanded: true }" class="flex flex-col bg-[#0f111a] border border-gray-800 rounded-xl overflow-hidden shadow-lg transition-all duration-300 opacity-80 hover:opacity-100">
                            
                            <!-- TOP: AUTHOR HEADER (HORIZONTAL) -->
                            <div @click="expanded = !expanded" class="w-full bg-gray-900/80 p-3 flex items-center justify-between border-b border-gray-800 cursor-pointer hover:bg-gray-800/80 transition-colors select-none">
                                <div class="flex items-center gap-3">
                                    <div class="relative">
                                        <div class="w-10 h-10 rounded-full bg-red-900/20 flex items-center justify-center text-sm text-red-400 font-bold shadow-lg ring-1 ring-red-500/30">
                                            {% if group.author %}{{ group.author.username|slice:":1"|upper }}{% else %}?{% endif %}
                                        </div>
                                        <span class="absolute -bottom-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-red-600 text-[10px] text-white font-mono border border-gray-900">
                                            {{ group.count }}
                                        </span>
                                    </div>
                                    <div class="flex flex-col leading-tight">
                                        <span class="text-red-400 font-bold text-sm" title="{% if group.author %}{{ group.author.username }}{% else %}Sistema{% endif %}">
                                            {% if group.author %}{{ group.author.username }}{% else %}Sistema{% endif %}
                                        </span>
                                        <span class="text-xs text-gray-500 font-mono">
                                            {{ group.proposals|length }} rechazadas
                                        </span>
                                    </div>
                                </div>
                                
                                <button class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10 text-gray-400 transition-transform duration-300" :class="{'rotate-180': expanded}">
                                    ‚ñº
                                </button>
                            </div>

                            <!-- BOTTOM: PROPOSALS LIST -->
                            <div x-show="expanded" class="flex-1 divide-y divide-gray-800/50 bg-black/20">
                                {% for item in group.proposals %}
                                <div class="p-4 hover:bg-white/5 transition-colors flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 group">
                                    <!-- CHECKBOX -->
                                    <div class="flex items-center justify-center pt-1 pl-1">
                                        <input type="checkbox" form="bulk-rejected-form" 
                                               name="{% if item.type == 'WORLD' %}selected_ids{% elif item.type == 'NARRATIVE' %}selected_narr_ids{% else %}selected_img_ids{% endif %}" 
                                               value="{{ item.id }}" 
                                               class="rejected-check w-4 h-4 rounded border-gray-600 bg-gray-700 text-red-500 focus:ring-red-500/50 cursor-pointer transition">
                                    </div>

                                    <!-- INFO -->
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold border opacity-60 grayscale
                                                {% if item.type == 'WORLD' %} bg-blue-900/20 text-blue-400 border-blue-900/50
                                                {% elif item.type == 'NARRATIVE' %} bg-purple-900/20 text-purple-400 border-purple-900/50
                                                {% elif item.type == 'IMAGE' %} bg-pink-900/20 text-pink-400 border-pink-900/50
                                                {% else %} bg-gray-800 text-gray-400 border-gray-700 {% endif %}">
                                                {{ item.type_label }}
                                            </span>
                                            
                                            <a href="{% url 'review_proposal' item.type item.id %}" class="text-gray-400 font-bold hover:text-white hover:underline truncate transition-colors text-sm line-through decoration-red-900/50">
                                                {{ item.target_name|default:"(Sin Nombre)" }}
                                            </a>
                                            <span class="text-[10px] text-red-500 font-mono border border-red-900/30 px-1 rounded bg-red-900/10">REJECTED</span>
                                        </div>
                                        
                                        <div class="flex items-center gap-2 text-xs text-gray-600 italic">
                                            <span>v{{ item.version_number }}</span>
                                            <span>-</span>
                                            <span>{{ item.created_at|timesince }} ago</span>
                                        </div>
                                    </div>

                                    <!-- QUICK ACTIONS -->
                                    <div class="flex items-center gap-2 shrink-0 opacity-60 group-hover:opacity-100 transition-opacity">
                                        
                                        <!-- Review -->
                                        <a href="{% url 'review_proposal' item.type item.id %}" class="flex items-center gap-2 bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs font-bold px-3 py-2 rounded border border-gray-700 transition-all shadow-lg" title="Ver detalle">
                                            <span>üëÅÔ∏è</span>
                                        </a>

                                        <!-- Restore Button -->
                                        <form method="post" action="{% if item.type == 'WORLD' %}{% url 'restaurar_version' item.id %}{% elif item.type == 'NARRATIVE' %}{% url 'restaurar_narrativa' item.id %}{% elif item.type == 'IMAGE' %}{% url 'restaurar_imagen' item.id %}{% endif %}">
                                            {% csrf_token %}
                                            <button type="submit" class="flex items-center gap-2 bg-blue-900/20 hover:bg-blue-600 text-blue-500 hover:text-white text-xs font-bold px-3 py-2 rounded border border-blue-900/50 transition-all shadow-lg" title="Restaurar a Pendientes" onclick="return confirm('¬øRestaurar esta propuesta a PENDIENTES?')">
                                                <span>üîÑ</span>
                                            </button>
                                        </form>

                                        {% if request.user.is_superuser %}
                                        <!-- Delete Forever -->
                                        <form method="post" action="{% if item.type == 'WORLD' %}{% url 'borrar_propuesta' item.id %}{% elif item.type == 'NARRATIVE' %}{% url 'borrar_narrativa_version' item.id %}{% elif item.type == 'IMAGE' %}{% url 'borrar_imagen_definitivo' item.id %}{% endif %}">
                                            {% csrf_token %}
                                            <button type="submit" class="flex items-center gap-2 bg-red-900/20 hover:bg-red-600 text-red-500 hover:text-white text-xs font-bold px-3 py-2 rounded border border-red-900/50 transition-all shadow-lg" title="ELIMINAR DEFINITIVAMENTE" onclick="return confirm('‚ö†Ô∏è IRREVERSIBLE: ¬øBorrar definitivamente?')">
                                                <span>üíÄ</span>
                                            </button>
                                        </form>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-gray-600 text-sm italic">No hay propuestas rechazadas recientes.</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
    
            <!-- ARCHIVADAS (HISTORIAL) -->
            <details class="group mt-8 mb-4 bg-gray-900/20 rounded-xl border border-gray-800/50 overflow-hidden">
                <summary class="flex justify-between items-center p-4 cursor-pointer hover:bg-gray-800/50 transition list-none select-none">
                    <h2 class="text-xl font-bold text-gray-500 flex items-center gap-3">
                        <span>üìú Historial (Versiones Archivadas)</span>
                        <span class="text-xs bg-gray-800 text-gray-500 px-2 py-1 rounded-full border border-gray-700">{{ archived|length }}</span>
                    </h2>
                    <span class="text-gray-500 transform group-open:rotate-180 transition">‚ñº</span>
                </summary>

                <div class="p-4 border-t border-gray-800/50 bg-black/20 space-y-4" x-data="{ selectionCount: 0 }" @change="selectionCount = document.querySelectorAll('.archive-check:checked').length">
                    <!-- BULK FORM DEFINITION -->
                    <form id="bulk-archive-form" method="post" action="{% url 'borrar_propuestas_masivo' %}">{% csrf_token %}</form>

                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs text-gray-500 italic">Selecciona varios para borrar de una vez.</span>
                        
                        {% if request.user.is_superuser %}
                        <div class="flex gap-2">
                            <!-- EXECUTE DELETE -->
                            <button type="submit" form="bulk-archive-form" 
                                    class="text-xs bg-red-900/30 hover:bg-red-600 text-red-400 hover:text-white px-3 py-1.5 rounded border border-red-900/50 transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                    :disabled="selectionCount === 0"
                                    onclick="return confirm('‚ö†Ô∏è EST√ÅS A PUNTO DE BORRAR ELEMENTOS DEFINITIVAMENTE.\n\n¬øProceder?')">
                                <span>üíÄ</span> Borrar (<span x-text="selectionCount"></span>)
                            </button>
                        </div>
                        {% endif %}
                    </div>

                    {% if grouped_archived %}
                        {% for group in grouped_archived %}
                        <!-- AUTHOR GROUP CARD -->
                        <div x-data="{ expanded: false }" class="flex flex-col bg-[#0f111a] border border-gray-800 rounded-xl overflow-hidden shadow-lg transition-all duration-300 opacity-80 hover:opacity-100">
                            
                            <!-- HEADER -->
                            <div @click="expanded = !expanded" class="w-full bg-gray-900/60 p-3 flex items-center justify-between border-b border-gray-800 cursor-pointer hover:bg-gray-800/80 transition-colors select-none">
                                <div class="flex items-center gap-3">
                                    <div class="relative">
                                        <div class="w-8 h-8 rounded-full bg-gray-800 flex items-center justify-center text-xs text-gray-500 font-bold">
                                            {% if group.author %}{{ group.author.username|slice:":1"|upper }}{% else %}?{% endif %}
                                        </div>
                                    </div>
                                    <div class="flex flex-col leading-tight">
                                        <span class="text-gray-400 font-bold text-sm">
                                            {% if group.author %}{{ group.author.username }}{% else %}Sistema{% endif %}
                                        </span>
                                        <span class="text-[10px] text-gray-600 font-mono">
                                            {{ group.count }} archivados
                                        </span>
                                    </div>
                                </div>
                                <button class="w-6 h-6 flex items-center justify-center rounded-full text-gray-600 transition-transform duration-300" :class="{'rotate-180': expanded}">‚ñº</button>
                            </div>

                            <!-- LIST -->
                            <div class="divide-y divide-gray-800/30">
                                {% for item in group.proposals %}
                                <div class="p-3 hover:bg-white/5 transition flex flex-col sm:flex-row gap-3" {% if forloop.counter > 5 %}x-show="expanded"{% endif %}>
                                    
                                    <!-- CHECKBOX (Superuser Only) -->
                                    {% if request.user.is_superuser %}
                                    <div class="flex items-center justify-center pt-1 pl-1">
                                        <input type="checkbox" form="bulk-archive-form" 
                                               name="{% if item.type == 'WORLD' %}selected_ids{% elif item.type == 'NARRATIVE' %}selected_narr_ids{% else %}selected_img_ids{% endif %}" 
                                               value="{{ item.id }}" 
                                               class="archive-check w-4 h-4 rounded border-gray-600 bg-gray-700 text-red-500 focus:ring-red-500/50 cursor-pointer transition">
                                    </div>
                                    {% endif %}

                                    <!-- INFO -->
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="px-1.5 py-0.5 rounded text-[10px] font-bold border 
                                                {% if item.type == 'WORLD' %}bg-blue-900/20 text-blue-400 border-blue-900/30
                                                {% elif item.type == 'NARRATIVE' %}bg-purple-900/20 text-purple-400 border-purple-900/30
                                                {% elif item.type == 'IMAGE' %}bg-pink-900/20 text-pink-400 border-pink-900/30{% endif %}">
                                                {{ item.type_label }}
                                            </span>
                                            <h4 class="text-gray-400 font-bold text-sm truncate decoration-slice decoration-gray-700 line-through opacity-70">
                                                {{ item.target_name }}
                                            </h4>
                                        </div>
                                        <p class="text-xs text-gray-500 truncate mb-1">{{ item.target_desc|default:"Sin descripci√≥n" }}</p>
                                        <div class="flex items-center gap-2 text-[10px] text-gray-600 font-mono">
                                            <span>v{{ item.version_number }}</span>
                                            <span>‚Ä¢</span>
                                            <span x-data="{ timeAgo: '' }" x-init="timeAgo = new Date('{{ item.created_at|date:'Y-m-d H:i:s' }}').toLocaleDateString()">
                                                <span x-text="timeAgo"></span>
                                            </span>
                                            {% if item.change_log %}
                                            <span>‚Ä¢</span>
                                            <span class="italic text-gray-700 max-w-[150px] truncate" title="{{ item.change_log }}">{{ item.change_log }}</span>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- ACTIONS -->
                                    <div class="flex items-center gap-2 shrink-0">
                                         <!-- Preview -->
                                         <a href="{% url 'review_proposal' item.type item.id %}" {% if item.type == 'IMAGE' %}target="_blank"{% endif %} class="text-gray-600 hover:text-gray-300 transition" title="Ver Snapshot">
                                            üëÅÔ∏è
                                        </a>
                                        
                                        <!-- RESTORE -->
                                        <form method="post" action="{% if item.type == 'WORLD' %}{% url 'restaurar_version' item.id %}{% elif item.type == 'NARRATIVE' %}{% url 'restaurar_narrativa' item.id %}{% elif item.type == 'IMAGE' %}{% url 'restaurar_imagen' item.id %}{% endif %}">
                                            {% csrf_token %}
                                            <button type="submit" class="flex items-center gap-1.5 bg-blue-900/20 hover:bg-blue-600 text-blue-500 hover:text-white text-xs font-bold px-3 py-1.5 rounded border border-blue-900/50 transition-all shadow-lg" title="Restaurar a Pendientes" onclick="return confirm('¬øRestaurar esto a Pendientes?')">
                                                <span>üîÑ</span> Restaurar
                                            </button>
                                        </form>

                                        <!-- DELETE FOREVER (Superuser Only) -->
                                        {% if request.user.is_superuser %}
                                        <form method="post" action="{% if item.type == 'WORLD' %}{% url 'borrar_propuesta' item.id %}{% elif item.type == 'NARRATIVE' %}{% url 'borrar_narrativa_version' item.id %}{% elif item.type == 'IMAGE' %}{% url 'borrar_imagen_definitivo' item.id %}{% endif %}">
                                            {% csrf_token %}
                                            <button type="submit" class="flex items-center gap-1.5 bg-red-900/20 hover:bg-red-600 text-red-500 hover:text-white text-xs font-bold px-3 py-1.5 rounded border border-red-900/50 transition-all shadow-lg" title="ELIMINAR DEFINITIVAMENTE" onclick="return confirm('‚ö†Ô∏è PELIGRO ‚ö†Ô∏è\n\n¬øEst√°s seguro de ELIMINAR DEFINITIVAMENTE este registro del historial?\n\nEsta acci√≥n NO SE PUEDE DESHACER.')">
                                                <span>üíÄ</span>
                                            </button>
                                        </form>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <!-- PREVIEW (Collapsed State: Show summary only?) User asked for grouped style. -->
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-gray-600 italic text-center py-4">No hay historial de versiones archivadas.</p>
                    {% endif %}
                </div>
            </details>

            <!-- EVENT LOG (AUDIT) -->
            <h2 class="text-2xl font-bold text-blue-400 mt-12 mb-4">üìã Registro de Actividad (Audit Log)</h2>
            
            <div class="space-y-4">
                <details class="group bg-card border border-blue-900/30 rounded-xl overflow-hidden shadow-lg">
                    <summary class="flex justify-between items-center p-4 cursor-pointer bg-blue-900/20 hover:bg-blue-900/30 transition list-none">
                        <span class="font-bold text-blue-200 flex items-center gap-2">üåç Cambios en MUNDOS <span class="text-xs bg-blue-900 text-blue-300 px-2 rounded-full">{{ logs_world|length }}</span></span>
                        <span class="text-blue-400 transform group-open:rotate-180 transition">‚ñº</span>
                    </summary>
                    <div class="overflow-x-auto">
                        {% include "components/_log_table.html" with logs=logs_world color="blue" %}
                    </div>
                </details>

                <details class="group bg-card border border-purple-900/30 rounded-xl overflow-hidden shadow-lg">
                    <summary class="flex justify-between items-center p-4 cursor-pointer bg-purple-900/20 hover:bg-purple-900/30 transition list-none">
                        <span class="font-bold text-purple-200 flex items-center gap-2">üìñ Cambios en NARRATIVAS <span class="text-xs bg-purple-900 text-purple-300 px-2 rounded-full">{{ logs_narrative|length }}</span></span>
                        <span class="text-purple-400 transform group-open:rotate-180 transition">‚ñº</span>
                    </summary>
                    <div class="overflow-x-auto">
                        {% include "components/_log_table.html" with logs=logs_narrative color="purple" %}
                    </div>
                </details>

                <details class="group bg-card border border-pink-900/30 rounded-xl overflow-hidden shadow-lg">
                    <summary class="flex justify-between items-center p-4 cursor-pointer bg-pink-900/20 hover:bg-pink-900/30 transition list-none">
                        <span class="font-bold text-pink-200 flex items-center gap-2">üñºÔ∏è Cambios en IM√ÅGENES <span class="text-xs bg-pink-900 text-pink-300 px-2 rounded-full">{{ logs_image|length }}</span></span>
                        <span class="text-pink-400 transform group-open:rotate-180 transition">‚ñº</span>
                    </summary>
                    <div class="overflow-x-auto">
                        {% include "components/_log_table.html" with logs=logs_image color="pink" %}
                    </div>
                </details>

                <details class="group bg-card border border-gray-800 rounded-xl overflow-hidden shadow-lg">
                    <summary class="flex justify-between items-center p-4 cursor-pointer bg-gray-900/50 hover:bg-gray-800 transition list-none">
                        <span class="font-bold text-gray-400 flex items-center gap-2">‚öôÔ∏è Otros Eventos <span class="text-xs bg-gray-800 text-gray-300 px-2 rounded-full">{{ logs_other|length }}</span></span>
                        <span class="text-gray-500 transform group-open:rotate-180 transition">‚ñº</span>
                    </summary>
                    <div class="overflow-x-auto">
                        {% include "components/_log_table.html" with logs=logs_other color="gray" %}
                    </div>
                </details>
            </div>

        </form>
    </div>
{% endblock %}

{% block modals %}

{% endblock %}
