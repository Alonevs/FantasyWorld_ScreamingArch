{% extends "layouts/base.html" %}
{% load static %}
{% load rbac_tags %}

{% block title %}ECLAI | Dashboard{% endblock %}

{% block content %}
    <div class="max-w-7xl mx-auto pb-24 px-4 pt-6">
        
        <form id="bulk-delete-form" method="POST" action="{% url 'borrar_propuestas_masivo' %}">
            {% csrf_token %}
            






            <!-- METRICS SUMMARY (KPIs) -->
            {% include "components/_dashboard_metrics.html" %}

            <!-- INBOX (PENDING) -->
            <div class="mb-12" x-data="{ selectionCount: 0 }" @change="selectionCount = document.querySelectorAll('.pending-check:checked').length">
                
                <form id="bulk-approve-form" method="post" action="{% url 'aprobar_propuestas_masivo' %}">{% csrf_token %}</form>

                <h2 class="text-2xl font-bold text-white mb-6 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        {% if current_author %}
                            {% for u in available_authors %}
                                {% if u.id == current_author %}
                                    <span>üì¨ Buz√≥n de <span class="text-blue-400">{{ u.username }}</span></span>
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            <span>üì¨ Propuestas Pendientes (Global)</span>
                        {% endif %}
                        <span class="text-xs bg-blue-900/50 text-blue-300 px-3 py-1 rounded-full border border-blue-800">{{ total_pending_count }}</span>
                    </div>

                    <div class="flex items-center gap-2" x-show="selectionCount > 0" x-transition.opacity.duration.300ms style="display: none;">
                        <!-- BULK VIEW (Images only) -->
                        <button type="submit" form="bulk-approve-form" 
                                formaction="{% url 'batch_revisar_imagenes' %}"
                                class="text-xs bg-indigo-900/30 hover:bg-indigo-600 text-indigo-400 hover:text-white px-3 py-1.5 rounded border border-indigo-900/50 transition flex items-center gap-2"
                                title="Ver im√°genes seleccionadas">
                            <span>üëÅÔ∏è</span> Ver (<span x-text="selectionCount"></span>)
                        </button>

                        <!-- BULK APPROVE BUTTON -->
                        {% if request.user.is_superuser or request.user.profile.rank == 'ADMIN' %}
                        <button type="submit" form="bulk-approve-form" 
                                class="text-xs bg-green-900/30 hover:bg-green-600 text-green-400 hover:text-white px-3 py-1.5 rounded border border-green-900/50 transition flex items-center gap-2"
                                title="Aprobar seleccionados"
                                data-confirm="¬øAprobar todas las propuestas seleccionadas?">
                            <span>‚úÖ</span> Aprobar (<span x-text="selectionCount"></span>)
                        </button>
                        {% endif %}
                        
                        <!-- BULK REJECT -->
                        {% if request.user.is_superuser or request.user.profile.rank == 'ADMIN' %}
                        <button type="submit" form="bulk-approve-form" 
                                formaction="{% url 'borrar_propuestas_masivo' %}"
                                class="text-xs bg-red-900/30 hover:bg-red-600 text-red-400 hover:text-white px-3 py-1.5 rounded border border-red-900/50 transition flex items-center gap-2"
                                title="Rechazar seleccionados"
                                data-confirm="¬øRECHAZAR todas las propuestas seleccionadas? (Se eliminar√°n de la lista)"
                                data-destructive="true">
                            <span>‚úï</span> Rechazar (<span x-text="selectionCount"></span>)
                        </button>
                        {% endif %}
                    </div>
                </h2>
                <p class="text-gray-500 mb-6 text-sm">Propuestas de tu equipo que requieren revisi√≥n y aprobaci√≥n.</p>

                {% if pending and grouped_inbox %}

                    <div class="space-y-6">
                        {% for group in grouped_inbox %}
                        <div x-data="{ expanded: true }" class="flex flex-col bg-[#0f111a] border border-gray-800 rounded-xl overflow-hidden shadow-lg transition-all duration-300">
                            
                            <!-- TOP: AUTHOR HEADER (HORIZONTAL) -->
                            <div @click="expanded = !expanded" class="w-full bg-gray-900/80 p-3 flex items-center justify-between border-b border-gray-800 cursor-pointer hover:bg-gray-800/80 transition-colors select-none">
                                <div class="flex items-center gap-3">
                                    <div class="flex flex-col leading-tight">
                                        <div class="flex items-center gap-2">
                                            <span class="text-blue-400 font-bold text-sm" title="{% if group.author %}{{ group.author.username }}{% else %}Sistema{% endif %}">
                                                {% if group.author %}{{ group.author.username }}{% else %}Sistema{% endif %}
                                            </span>
                                            <span class="bg-blue-600/20 text-blue-400 text-[10px] px-1.5 py-0.5 rounded border border-blue-500/30 font-mono">
                                                {{ group.count }}
                                            </span>
                                        </div>
                                        <span class="text-[10px] text-gray-500 font-mono mt-0.5">
                                            propuestas pendientes
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Toggle Icon -->
                                <button class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10 text-gray-400 transition-transform duration-300" :class="{'rotate-180': expanded}">
                                    ‚ñº
                                </button>
                            </div>

                            <!-- BOTTOM: PROPOSALS LIST -->
                            <div x-show="expanded" class="flex-1 divide-y divide-gray-800/50 bg-black/20">
                                {% for item in group.proposals %}
                                <!-- Item Container -->
                                <div class="p-4 hover:bg-white/5 transition-colors flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 group">
                                    <!-- CHECKBOX -->
                                    <div class="flex items-center justify-center pt-1 pl-1">
                                        <input type="checkbox" form="bulk-approve-form" 
                                               name="{% if item.type == 'WORLD' %}selected_ids{% elif item.type == 'NARRATIVE' %}selected_narr_ids{% else %}selected_img_ids{% endif %}" 
                                               value="{{ item.id }}" 
                                               class="pending-check w-4 h-4 rounded border-gray-600 bg-gray-700 text-green-500 focus:ring-green-500/50 cursor-pointer transition">
                                    </div>

                                    <!-- INFO -->
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <!-- TYPE BADGE -->
                                            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold border opacity-80
                                                {% if item.type == 'WORLD' %} bg-blue-900/20 text-blue-400 border-blue-900/50
                                                {% elif item.type == 'NARRATIVE' %} bg-purple-900/20 text-purple-400 border-purple-900/50
                                                {% elif item.type == 'IMAGE' %} bg-pink-900/20 text-pink-400 border-pink-900/50
                                                {% else %} bg-gray-800 text-gray-400 border-gray-700 {% endif %}">
                                                {{ item.type_label }}
                                            </span>
                                            
                                            <a href="{% if item.type == 'IMAGE' %}{% url 'revisar_imagen' item.id %}{% else %}{% url 'review_proposal' item.type item.id %}{% endif %}" class="text-gray-200 font-bold hover:text-blue-400 hover:underline truncate transition-colors text-sm">
                                                {{ item.target_name|default:"(Sin Nombre)" }}
                                            </a>
                                            <span class="text-[10px] text-gray-600 font-mono">v{{ item.version_number }}</span>
                                        </div>
                                        
                                        <div class="flex items-center gap-2 text-xs text-gray-500">
                                            {% if item.change_log %}
                                            <span class="italic text-gray-400">"{{ item.change_log|truncatechars:60 }}"</span>
                                            {% endif %}
                                            
                                            <!-- Time Ago (New) -->
                                            <span class="ml-auto text-[10px] text-gray-600 font-mono">{{ item.created_at|timesince }} ago</span>
                                        </div>
                                    </div>

                                    <!-- QUICK ACTIONS -->
                                    <div class="flex items-center gap-2 shrink-0 opacity-80 group-hover:opacity-100 transition-opacity">
                                        
                                        {% if item.action == 'DELETE' %}
                                            <!-- DELETE LOGIC: Green=Keep (Reject Proposal), Red=Delete (Approve Proposal) -->
                                            
                                            <!-- Green: MANTENER (Reject deletion) -->
                                            <form method="post" action="{% if item.type == 'WORLD' %}{% url 'archivar_propuesta' item.id %}{% elif item.type == 'NARRATIVE' %}{% url 'archivar_narrativa' item.id %}{% elif item.type == 'IMAGE' %}{% url 'archivar_imagen' item.id %}{% endif %}?next={{ request.get_full_path|urlencode }}">
                                                {% csrf_token %}
                                                <input type="hidden" name="admin_feedback" value="">
                                                <button type="button" 
                                                        onclick="submitWithFeedback(this.form, 'üõ°Ô∏è ¬øPor qu√© mantener?', 'Indica el motivo para mantener este elemento activo:')"
                                                        class="text-green-500 hover:text-white hover:bg-green-600 px-3 py-1.5 rounded text-xs font-bold transition-all border border-green-900/30 hover:border-green-500 shadow-lg shadow-green-900/10 flex items-center gap-1" title="Mantener (Rechazar borrado)">
                                                    <span>üõ°Ô∏è</span> Mantener
                                                </button>
                                            </form>
                                            
                                            <!-- RESTORE BUTTON (Active only) -->
                                        <form method="post" action="{% if item.type == 'WORLD' %}{% url 'aprobar_version' item.id %}{% elif item.type == 'NARRATIVE' %}{% url 'aprobar_narrativa' item.id %}{% elif item.type == 'IMAGE' %}{% url 'aprobar_imagen' item.id %}{% endif %}?next={{ request.get_full_path|urlencode }}">
                                            {% csrf_token %}
                                            <button type="submit" class="text-red-500 hover:text-white hover:bg-red-600 px-3 py-1.5 rounded text-xs font-bold transition-all border border-red-900/30 hover:border-red-500 shadow-lg shadow-red-900/10 flex items-center gap-1" title="Confirmar Borrado Definitivo" data-confirm="‚ö†Ô∏è ¬øCONFIRMAR BORRADO? Esta acci√≥n eliminar√° el elemento." data-destructive="true">
                                                <span>üíÄ</span> Borrar
                                            </button>
                                        </form>

                                        {% else %}
                                            <!-- STANDARD LOGIC: Green=Approve, Red=Reject -->
                                            
                                            <!-- Approve (Step 1) -->
                                            {% if request.user|can_approve:item %}
                                            <form method="post" action="{% if item.type == 'WORLD' %}{% url 'aprobar_version' item.id %}{% elif item.type == 'NARRATIVE' %}{% url 'aprobar_narrativa' item.id %}{% elif item.type == 'IMAGE' %}{% url 'aprobar_imagen' item.id %}{% endif %}?next={{ request.get_full_path|urlencode }}">
                                                {% csrf_token %}
                                                <button type="submit" class="text-green-500 hover:text-white hover:bg-green-600 px-3 py-1.5 rounded text-xs font-bold transition-all border border-green-900/30 hover:border-green-500 shadow-lg shadow-green-900/10" title="Aprobar" data-confirm="¬øAprobar esta propuesta?">
                                                    Aprobar
                                                </button>
                                            </form>
                                            {% endif %}
                                            
                                            <!-- Review (Images in New Tab) -->
                                            <a href="{% url 'review_proposal' item.type item.id %}" {% if item.type == 'IMAGE' %}target="_blank"{% endif %} class="flex items-center gap-2 bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs font-bold px-3 py-2 rounded border border-gray-700 transition-all shadow-lg" title="Ver detalle">
                                                <span>üëÅÔ∏è</span> <span class="hidden sm:inline">Ver</span>
                                            </a>

                                            <!-- Reject (With Reason) -->
                                            {% if request.user|can_approve:item %}
                                            <form method="post" action="{% if item.type == 'WORLD' %}{% url 'rechazar_propuesta' item.id %}{% elif item.type == 'NARRATIVE' %}{% url 'rechazar_narrativa' item.id %}{% elif item.type == 'IMAGE' %}{% url 'rechazar_imagen' item.id %}{% endif %}?next={{ request.get_full_path|urlencode }}">
                                                {% csrf_token %}
                                                <input type="hidden" name="admin_feedback" value="">
                                                <button type="button" 
                                                        onclick="submitWithFeedback(this.form, '‚úï Rechazar Propuesta', 'Motivo del rechazo (opcional):')"
                                                        class="text-red-500 hover:text-white hover:bg-red-600 px-3 py-1.5 rounded text-xs font-bold transition-all border border-red-900/30 hover:border-red-500 shadow-lg shadow-red-900/10" title="Rechazar">
                                                    ‚úï
                                                </button>
                                            </form>
                                            {% endif %}
                                        {% endif %}

                                        <!-- Review Button for DELETE? Usually helpful to see what is being deleted.
                                             If in DELETE mode, I replaced the block, so button missing.
                                             I should add "Ver" button to DELETE block too. -->
                                        {% if item.action == 'DELETE' %}
                                            <a href="{% url 'review_proposal' item.type item.id %}" {% if item.type == 'IMAGE' %}target="_blank"{% endif %} class="flex items-center gap-2 bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs font-bold px-3 py-2 rounded border border-gray-700 transition-all shadow-lg" title="Ver detalle">
                                                <span>üëÅÔ∏è</span>
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-12 bg-card border border-dashed border-gray-800 rounded-xl">
                        <div class="text-4xl mb-4 opacity-50">üì≠</div>
                        <h3 class="text-lg font-bold text-gray-400 mb-1">Buz√≥n vac√≠o</h3>
                        <p class="text-gray-600 text-sm">No hay propuestas de tu equipo pendientes de revisi√≥n.</p>
                    </div>
                {% endif %}
            </div>

            <!-- APROBADAS (READY TO PUBLISH/LIVE) -->
            {% if approved %}
            <div class="mb-16" x-data="{ selectionCount: 0 }" @change="selectionCount = document.querySelectorAll('.approved-check:checked').length">
                
                <form id="bulk-archive-approved-form" method="post" action="{% url 'archivar_propuestas_masivo' %}">{% csrf_token %}</form>

                <h2 class="text-2xl font-bold text-green-400 mb-4 flex justify-between items-center">
                     <div class="flex items-center gap-3">
                        <span>‚úÖ Aprobadas (Listas para Live)</span>
                    </div>
                    
                    <div class="flex items-center gap-2" x-data="{ hasDeletions: false }" @change="hasDeletions = !![...document.querySelectorAll('.approved-check:checked')].find(el => el.dataset.action === 'DELETE')">
                        <!-- BULK VIEW (Images only) -->
                        <button type="submit" form="bulk-archive-approved-form" 
                                formaction="{% url 'batch_revisar_imagenes' %}"
                                class="text-xs bg-indigo-900/30 hover:bg-indigo-600 text-indigo-400 hover:text-white px-3 py-1.5 rounded border border-indigo-900/50 transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                :disabled="selectionCount === 0"
                                title="Ver im√°genes seleccionadas">
                            <span>üëÅÔ∏è</span> Ver (<span x-text="selectionCount"></span>)
                        </button>

                        <!-- BULK PUBLISH & ARCHIVE -->
                        {% if request.user.is_superuser or request.user.profile.rank == 'ADMIN' %}
                        <button type="submit" form="bulk-archive-approved-form" 
                                formaction="{% url 'archivar_propuestas_masivo' %}"
                                class="text-xs bg-yellow-900/30 hover:bg-yellow-600 text-yellow-500 hover:text-white px-3 py-1.5 rounded border border-yellow-900/50 transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                :disabled="selectionCount === 0"
                                title="Archivar seleccionados"
                                data-confirm="¬øArchivar propuestas seleccionadas? (Se mover√°n al historial sin publicar)">
                            <span>üì¶</span> Archivar (<span x-text="selectionCount"></span>)
                        </button>

                        <button type="submit" form="bulk-archive-approved-form" 
                                formaction="{% url 'publicar_propuestas_masivo' %}"
                                class="text-xs px-3 py-1.5 rounded border transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed shadow-[0_0_15px_rgba(59,130,246,0.1)]"
                                :class="hasDeletions ? 'bg-red-900/30 hover:bg-red-600 text-red-500 hover:text-white border-red-900/50' : 'bg-blue-900/30 hover:bg-blue-600 text-blue-400 hover:text-white border-blue-900/50'"
                                :disabled="selectionCount === 0"
                                title="Publicar/Ejecutar seleccionados"
                                data-confirm="¬øPROCEDER con las propuestas seleccionadas? (Publicar o Ejecutar Borrado)">
                            <span x-text="hasDeletions ? 'üíÄ' : 'üöÄ'">üöÄ</span> 
                            <span x-text="hasDeletions ? 'Borrar' : 'Publicar'">Publicar</span> 
                            (<span x-text="selectionCount"></span>)
                        </button>
                        {% endif %}
                    </div>
                </h2>
                <div id="approved-list" class="space-y-6">
                    {% if grouped_approved %}
                        {% for group in grouped_approved %}
                        <div x-data="{ expanded: false }" class="flex flex-col bg-[#0f111a] border border-gray-800 rounded-xl overflow-hidden shadow-lg transition-all duration-300 opacity-90 hover:opacity-100">
                            
                            <!-- TOP: AUTHOR HEADER (HORIZONTAL) -->
                            <div @click="expanded = !expanded" class="w-full bg-gray-900/80 p-3 flex items-center justify-between border-b border-gray-800 cursor-pointer hover:bg-gray-800/80 transition-colors select-none">
                                <div class="flex items-center gap-3">
                                    <div class="flex flex-col leading-tight">
                                        <div class="flex items-center gap-2">
                                            <span class="text-blue-400 font-bold text-sm" title="{% if group.author %}{{ group.author.username }}{% else %}Sistema{% endif %}">
                                                {% if group.author %}{{ group.author.username }}{% else %}Sistema{% endif %}
                                            </span>
                                            <span class="bg-green-600/20 text-green-400 text-[10px] px-1.5 py-0.5 rounded border border-green-500/30 font-mono">
                                                {{ group.count }}
                                            </span>
                                        </div>
                                        <span class="text-[10px] text-gray-500 font-mono mt-0.5">
                                            aprobadas, listas para live
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Toggle Icon -->
                                <button class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10 text-gray-400 transition-transform duration-300" :class="{'rotate-180': expanded}">
                                    ‚ñº
                                </button>
                            </div>

                            <!-- BOTTOM: PROPOSALS LIST -->
                            <div x-show="expanded" class="flex-1 divide-y divide-gray-800/50 bg-black/20">
                                {% for item in group.proposals %}
                                <!-- Item Container -->
                                <div class="p-4 hover:bg-white/5 transition-colors flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 group">
                                    <!-- CHECKBOX -->
                                    <div class="flex items-center justify-center pt-1 pl-1">
                                        <input type="checkbox" form="bulk-archive-approved-form" 
                                               name="{% if item.type == 'WORLD' %}selected_ids{% elif item.type == 'NARRATIVE' %}selected_narr_ids{% else %}selected_img_ids{% endif %}" 
                                               value="{{ item.id }}" 
                                               data-action="{{ item.action|default:'UPDATE' }}"
                                               class="approved-check w-4 h-4 rounded border-gray-600 bg-gray-700 text-yellow-500 focus:ring-yellow-500/50 cursor-pointer transition">
                                    </div>

                                    <!-- INFO -->
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold border opacity-80
                                                {% if item.type == 'WORLD' %} bg-blue-900/20 text-blue-400 border-blue-900/50
                                                {% elif item.type == 'NARRATIVE' %} bg-purple-900/20 text-purple-400 border-purple-900/50
                                                {% elif item.type == 'IMAGE' %} bg-pink-900/20 text-pink-400 border-pink-900/50
                                                {% else %} bg-gray-800 text-gray-400 border-gray-700 {% endif %}">
                                                {{ item.type_label }}
                                            </span>
                                            
                                            <a href="{% url 'review_proposal' item.type item.id %}" class="text-white font-bold hover:text-green-400 hover:underline truncate transition-colors text-sm">
                                                {{ item.target_name|default:"(Sin Nombre)" }}
                                            </a>
                                            <span class="text-[10px] text-green-500 font-mono border border-green-500/30 px-1 rounded bg-green-900/20">READY</span>
                                            
                                            <!-- Time Ago -->
                                            <span class="ml-auto text-[10px] text-gray-600 font-mono">{{ item.created_at|timesince }} ago</span>
                                        </div>
                                        

                                    </div>

                                    <!-- QUICK ACTIONS (APPROVED) -->
                                    <div class="flex items-center gap-2 shrink-0">
                                         <!-- Preview -->
                                        <a href="{% if item.type == 'IMAGE' %}{% url 'revisar_imagen' item.id %}{% else %}{% url 'review_proposal' item.type item.id %}{% endif %}" class="flex items-center gap-2 bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs font-bold px-3 py-2 rounded border border-gray-700 transition-all shadow-lg" title="Ver detalle sin publicar">
                                            <span>üëÅÔ∏è</span> <span class="hidden sm:inline">Ver</span>
                                        </a>

                                         <form method="post" action="{% if item.type == 'WORLD' %}{% url 'archivar_propuesta' item.id %}{% elif item.type == 'NARRATIVE' %}{% url 'archivar_narrativa' item.id %}{% elif item.type == 'IMAGE' %}{% url 'archivar_imagen' item.id %}{% endif %}">
                                            {% csrf_token %}
                                            <input type="hidden" name="admin_feedback" value="">
                                            {% if item.action == 'DELETE' %}
                                                <button type="button" 
                                                        onclick="submitWithFeedback(this.form, 'üõ°Ô∏è Mantener Elemento', 'Indica por qu√© has decidido NO efectuar el borrado:')"
                                                        class="flex items-center gap-2 bg-green-900/30 hover:bg-green-600 text-green-500 hover:text-white text-xs font-bold px-3 py-2 rounded border border-green-900/50 hover:border-green-500 transition-all shadow-lg" title="Mantener (Cancelar Borrado)">
                                                    <span>üõ°Ô∏è</span> <span class="hidden sm:inline">Mantener</span>
                                                </button>
                                            {% else %}
                                                <button type="submit" class="flex items-center gap-2 bg-gray-800 hover:bg-yellow-900/30 text-yellow-500 hover:text-yellow-300 text-xs font-bold px-3 py-2 rounded border border-gray-700 hover:border-yellow-700/50 transition-all shadow-lg" title="Archivar (Sin publicar)" data-confirm="¬øArchivar esta propuesta sin publicar?">
                                                    <span>üì¶</span>
                                                </button>
                                            {% endif %}
                                        </form>

                                         <!-- Publish (Step 2) -->
                                        {% if user|can_publish:item %}
                                        <form method="post" action="{% if item.type == 'WORLD' %}{% url 'publicar_version' item.id %}{% elif item.type == 'IMAGE' %}{% url 'publicar_imagen' item.id %}{% else %}{% url 'publicar_narrativa' item.id %}{% endif %}">
                                            {% csrf_token %}
                                            {% if item.action == 'DELETE' %}
                                                <button type="submit" class="flex items-center gap-2 bg-red-600 hover:bg-red-500 text-white text-xs font-bold px-4 py-2 rounded shadow-[0_0_15px_rgba(220,38,38,0.3)] transition-all hover:-translate-y-0.5" data-confirm="‚ö†Ô∏è ¬øEFECTUAR BORRADO DEFINITIVO EN LIVE?" data-destructive="true">
                                                    <span>üíÄ</span> Borrar LIVE
                                                </button>
                                            {% else %}
                                                <button type="submit" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold px-4 py-2 rounded shadow-[0_0_15px_rgba(37,99,235,0.3)] transition-all hover:-translate-y-0.5" data-confirm="¬øPUBLICAR v{{ item.version_number }} EN LIVE? (Se archivar√° la versi√≥n actual)">
                                                    <span>üöÄ</span> Publicar LIVE
                                                </button>
                                            {% endif %}
                                        </form>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-gray-600 text-sm italic">No hay propuestas aprobadas listas para publicar.</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
    
            <!-- RECHAZADAS (REJECTED) -->
            {% if rejected %}
            <div class="mb-16" x-data="{ selectionCount: 0 }" @change="selectionCount = document.querySelectorAll('.rejected-check:checked').length">
                
                <form id="bulk-rejected-form" method="post" action="{% url 'borrar_propuestas_masivo' %}">{% csrf_token %}</form>

                <h2 class="text-2xl font-bold text-red-400 mb-4 flex justify-between items-center">
                     <div class="flex items-center gap-3">
                        <span>‚ùå Rechazadas (√öltimas 10)</span>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <!-- BULK RESTORE -->
                        <button type="submit" form="bulk-rejected-form" 
                                formaction="{% url 'borrar_propuestas_masivo' %}" 
                                name="action_type" value="restore" 
                                class="text-xs bg-blue-900/30 hover:bg-blue-600 text-blue-400 hover:text-white px-3 py-1.5 rounded border border-blue-900/50 transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                :disabled="selectionCount === 0"
                                data-confirm="¬øRestaurar seleccionados a PENDIENTES?">
                            <span>üîÑ</span> Restaurar (<span x-text="selectionCount"></span>)
                        </button>

                        <!-- BULK HARD DELETE (Superuser + Admin) -->
                        {% if request.user.is_superuser or request.user.profile.rank == 'ADMIN' %}
                        <button type="submit" form="bulk-rejected-form" 
                                formaction="{% url 'borrar_propuestas_masivo' %}" 
                                name="action_type" value="hard_delete" 
                                class="text-xs bg-red-900/30 hover:bg-red-600 text-red-500 hover:text-white px-3 py-1.5 rounded border border-red-900/50 transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-red-900/20"
                                :disabled="selectionCount === 0"
                                data-confirm="‚ö†Ô∏è PELIGRO ‚ö†Ô∏è ¬øBORRAR DEFINITIVAMENTE? Esta acci√≥n NO se puede deshacer."
                                data-destructive="true">
                            <span>üíÄ</span> Borrar (<span x-text="selectionCount"></span>)
                        </button>
                        {% endif %}
                    </div>
                </h2>

                <div class="space-y-6">
                    {% if grouped_rejected %}
                        {% for group in grouped_rejected %}
                        <div x-data="{ expanded: true }" class="flex flex-col bg-[#0f111a] border border-gray-800 rounded-xl overflow-hidden shadow-lg transition-all duration-300 opacity-80 hover:opacity-100">
                            
                            <!-- TOP: AUTHOR HEADER (HORIZONTAL) -->
                            <div @click="expanded = !expanded" class="w-full bg-gray-900/80 p-3 flex items-center justify-between border-b border-gray-800 cursor-pointer hover:bg-gray-800/80 transition-colors select-none">
                                <div class="flex items-center gap-3">
                                    <div class="flex flex-col leading-tight">
                                        <div class="flex items-center gap-2">
                                            <span class="text-red-400 font-bold text-sm" title="{% if group.author %}{{ group.author.username }}{% else %}Sistema{% endif %}">
                                                {% if group.author %}{{ group.author.username }}{% else %}Sistema{% endif %}
                                            </span>
                                            <span class="bg-red-600/20 text-red-400 text-[10px] px-1.5 py-0.5 rounded border border-red-500/30 font-mono">
                                                {{ group.count }}
                                            </span>
                                        </div>
                                        <span class="text-[10px] text-gray-500 font-mono mt-0.5">
                                            rechazadas
                                        </span>
                                    </div>
                                </div>
                                
                                <button class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10 text-gray-400 transition-transform duration-300" :class="{'rotate-180': expanded}">
                                    ‚ñº
                                </button>
                            </div>

                            <!-- BOTTOM: PROPOSALS LIST -->
                            <div x-show="expanded" class="flex-1 divide-y divide-gray-800/50 bg-black/20">
                                {% for item in group.proposals %}
                                <div class="p-4 hover:bg-white/5 transition-colors flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 group">
                                    <!-- CHECKBOX -->
                                    <div class="flex items-center justify-center pt-1 pl-1">
                                        <input type="checkbox" form="bulk-rejected-form" 
                                               name="{% if item.type == 'WORLD' %}selected_ids{% elif item.type == 'NARRATIVE' %}selected_narr_ids{% else %}selected_img_ids{% endif %}" 
                                               value="{{ item.id }}" 
                                               class="rejected-check w-4 h-4 rounded border-gray-600 bg-gray-700 text-red-500 focus:ring-red-500/50 cursor-pointer transition">
                                    </div>

                                    <!-- INFO -->
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold border opacity-60 grayscale
                                                {% if item.type == 'WORLD' %} bg-blue-900/20 text-blue-400 border-blue-900/50
                                                {% elif item.type == 'NARRATIVE' %} bg-purple-900/20 text-purple-400 border-purple-900/50
                                                {% elif item.type == 'IMAGE' %} bg-pink-900/20 text-pink-400 border-pink-900/50
                                                {% else %} bg-gray-800 text-gray-400 border-gray-700 {% endif %}">
                                                {{ item.type_label }}
                                            </span>
                                            
                                            <a href="{% url 'review_proposal' item.type item.id %}" class="text-gray-400 font-bold hover:text-white hover:underline truncate transition-colors text-sm line-through decoration-red-900/50">
                                                {{ item.target_name|default:"(Sin Nombre)" }}
                                            </a>
                                            <span class="text-[10px] text-red-500 font-mono border border-red-900/30 px-1 rounded bg-red-900/10">REJECTED</span>
                                        </div>
                                        
                                        <!-- REASON DISPLAY -->
                                        {% if item.admin_feedback %}
                                        <div class="bg-blue-900/10 border-l-2 border-blue-500 pl-2 py-1 mb-1 text-xs text-blue-300 italic">
                                            üí¨ Admin: "{{ item.admin_feedback }}"
                                        </div>
                                        {% endif %}

                                        {% if item.change_log and item.type != 'IMAGE' %}
                                        <div class="bg-red-900/10 border-l-2 border-red-900 pl-2 py-1 mb-1 text-xs text-red-300 italic">
                                            "{{ item.change_log }}"
                                        </div>
                                        {% endif %}
                                        
                                        <div class="flex items-center gap-2 text-xs text-gray-600 italic">
                                            <span>v{{ item.version_number }}</span>
                                            <span>-</span>
                                            <span>{{ item.created_at|timesince }} ago</span>
                                        </div>
                                    </div>

                                    <!-- QUICK ACTIONS -->
                                    <div class="flex items-center gap-2 shrink-0 opacity-60 group-hover:opacity-100 transition-opacity">
                                        
                                        <!-- Review -->
                                        <a href="{% url 'review_proposal' item.type item.id %}" class="flex items-center gap-2 bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs font-bold px-3 py-2 rounded border border-gray-700 transition-all shadow-lg" title="Ver detalle">
                                            <span>üëÅÔ∏è</span>
                                        </a>

                                        <!-- Retouch Button (Replaces Restore for Content) -->
                                        <!-- Retouch Button (Smart Routing) -->
                                        {% if item.type == 'WORLD' and item.target_link %}
                                            <a href="{% url 'editar_mundo' item.target_link %}?src_version={{ item.id }}" class="flex items-center gap-2 bg-blue-900/20 hover:bg-blue-600 text-blue-500 hover:text-white text-xs font-bold px-3 py-2 rounded border border-blue-900/50 transition-all shadow-lg" title="‚úèÔ∏è RETOCAR (Editar propuesta rechazada)">
                                                <span>‚úèÔ∏è</span>
                                            </a>
                                        {% elif item.type == 'NARRATIVE' and item.target_link %}
                                            <a href="{% url 'leer_narrativa' item.target_link %}?src_version={{ item.id }}&edit=true" class="flex items-center gap-2 bg-purple-900/20 hover:bg-purple-600 text-purple-500 hover:text-white text-xs font-bold px-3 py-2 rounded border border-purple-900/50 transition-all shadow-lg" title="‚úèÔ∏è RETOCAR (Editar narrativa rechazada)">
                                                <span>‚úèÔ∏è</span>
                                            </a>
                                        {% else %}
                                             <!-- Generic Restore for Images/Others -->
                                            <form method="post" action="{% if item.type == 'IMAGE' %}{% url 'restaurar_imagen' item.id %}{% else %}{% url 'restaurar_version' item.id %}{% endif %}">
                                                {% csrf_token %}
                                                <button type="submit" class="flex items-center gap-2 bg-blue-900/20 hover:bg-blue-600 text-blue-500 hover:text-white text-xs font-bold px-3 py-2 rounded border border-blue-900/50 transition-all shadow-lg" title="Restaurar a Pendientes" data-confirm="¬øRestaurar a Pendientes?">
                                                    <span>üîÑ</span>
                                                </button>
                                            </form>
                                        {% endif %}

                                        <!-- Delete Forever (Admins + Superusers) -->
                                        {% if request.user.is_superuser or request.user.profile.rank == 'ADMIN' %}
                                        <form method="post" action="{% if item.type == 'WORLD' %}{% url 'borrar_propuesta' item.id %}{% elif item.type == 'NARRATIVE' %}{% url 'borrar_narrativa_version' item.id %}{% elif item.type == 'IMAGE' %}{% url 'borrar_imagen_definitivo' item.id %}{% endif %}">
                                            {% csrf_token %}
                                            <button type="submit" class="flex items-center gap-2 bg-red-900/20 hover:bg-red-600 text-red-500 hover:text-white text-xs font-bold px-3 py-2 rounded border border-red-900/50 transition-all shadow-lg" title="ELIMINAR DEFINITIVAMENTE" data-confirm="‚ö†Ô∏è IRREVERSIBLE: ¬øBorrar definitivamente?" data-destructive="true">
                                                <span>üíÄ</span>
                                            </button>
                                        </form>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-gray-600 text-sm italic">No hay propuestas rechazadas recientes.</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
    
            <!-- ARCHIVADAS (HISTORIAL) -->
            <details class="group mt-8 mb-4 bg-gray-900/20 rounded-xl border border-gray-800/50 overflow-hidden">
                <summary class="flex justify-between items-center p-4 cursor-pointer hover:bg-gray-800/50 transition list-none select-none">
                    <h2 class="text-xl font-bold text-gray-500 flex items-center gap-3">
                        <span>üìú Historial (Versiones Archivadas)</span>
                        <span class="text-xs bg-gray-800 text-gray-500 px-2 py-1 rounded-full border border-gray-700">{{ archived|length }}</span>
                    </h2>
                    <span class="text-gray-500 transform group-open:rotate-180 transition">‚ñº</span>
                </summary>

                <div class="p-4 border-t border-gray-800/50 bg-black/20 space-y-4" x-data="{ selectionCount: 0 }" @change="selectionCount = document.querySelectorAll('.archive-check:checked').length">
                    <!-- BULK FORM DEFINITION -->
                    <form id="bulk-archive-form" method="post" action="{% url 'borrar_propuestas_masivo' %}">{% csrf_token %}</form>

                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs text-gray-500 italic">Selecciona varios para borrar de una vez.</span>
                        
                        {% if request.user.is_superuser %}
                        <div class="flex gap-2">
                            <!-- EXECUTE DELETE -->
                            <button type="submit" form="bulk-archive-form" 
                                    class="text-xs bg-red-900/30 hover:bg-red-600 text-red-400 hover:text-white px-3 py-1.5 rounded border border-red-900/50 transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                    :disabled="selectionCount === 0"
                                    data-confirm="‚ö†Ô∏è EST√ÅS A PUNTO DE BORRAR ELEMENTOS DEFINITIVAMENTE. ¬øProceder?"
                                    data-destructive="true">
                                <span>üíÄ</span> Borrar (<span x-text="selectionCount"></span>)
                            </button>
                        </div>
                        {% endif %}
                    </div>

                    {% if grouped_archived %}
                        {% for group in grouped_archived %}
                        <!-- AUTHOR GROUP CARD -->
                        <div x-data="{ expanded: false }" class="flex flex-col bg-[#0f111a] border border-gray-800 rounded-xl overflow-hidden shadow-lg transition-all duration-300 opacity-80 hover:opacity-100">
                            
                            <!-- HEADER -->
                            <div @click="expanded = !expanded" class="w-full bg-gray-900/60 p-3 flex items-center justify-between border-b border-gray-800 cursor-pointer hover:bg-gray-800/80 transition-colors select-none">
                                <div class="flex items-center gap-3">
                                    <div class="flex flex-col leading-tight">
                                        <div class="flex items-center gap-2">
                                            <span class="text-gray-400 font-bold text-sm">
                                                {% if group.author %}{{ group.author.username }}{% else %}Sistema{% endif %}
                                            </span>
                                            <span class="bg-gray-800 text-gray-500 text-[10px] px-1.5 py-0.5 rounded border border-gray-700 font-mono">
                                                {{ group.count }}
                                            </span>
                                        </div>
                                        <span class="text-[10px] text-gray-600 font-mono mt-0.5">
                                            archivados
                                        </span>
                                    </div>
                                </div>
                                <button class="w-6 h-6 flex items-center justify-center rounded-full text-gray-600 transition-transform duration-300" :class="{'rotate-180': expanded}">‚ñº</button>
                            </div>

                            <!-- LIST -->
                            <div x-show="expanded" class="divide-y divide-gray-800/30">
                                {% for item in group.proposals %}
                                <div class="p-3 hover:bg-white/5 transition flex flex-col sm:flex-row gap-3">
                                    
                                    <!-- CHECKBOX (Superuser Only) -->
                                    {% if request.user.is_superuser %}
                                    <div class="flex items-center justify-center pt-1 pl-1">
                                        <input type="checkbox" form="bulk-archive-form" 
                                               name="{% if item.type == 'WORLD' %}selected_ids{% elif item.type == 'NARRATIVE' %}selected_narr_ids{% else %}selected_img_ids{% endif %}" 
                                               value="{{ item.id }}" 
                                               class="archive-check w-4 h-4 rounded border-gray-600 bg-gray-700 text-red-500 focus:ring-red-500/50 cursor-pointer transition">
                                    </div>
                                    {% endif %}

                                    <!-- INFO -->
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="px-1.5 py-0.5 rounded text-[10px] font-bold border 
                                                {% if item.type == 'WORLD' %}bg-blue-900/20 text-blue-400 border-blue-900/30
                                                {% elif item.type == 'NARRATIVE' %}bg-purple-900/20 text-purple-400 border-purple-900/30
                                                {% elif item.type == 'IMAGE' %}bg-pink-900/20 text-pink-400 border-pink-900/30{% endif %}">
                                                {{ item.type_label }}
                                            </span>
                                            <h4 class="text-gray-400 font-bold text-sm truncate box-decoration-slice decoration-gray-700 line-through opacity-70">
                                                {{ item.target_name }}
                                            </h4>
                                        </div>
                                        <p class="text-xs text-gray-500 truncate mb-1">{{ item.target_desc|default:"Sin descripci√≥n" }}</p>
                                        <div class="flex items-center gap-2 text-[10px] text-gray-600 font-mono">
                                            <span>v{{ item.version_number }}</span>
                                            <span>‚Ä¢</span>
                                            <span x-data="{ timeAgo: '' }" x-init="timeAgo = new Date('{{ item.created_at|date:'Y-m-d H:i:s' }}').toLocaleDateString()">
                                                <span x-text="timeAgo"></span>
                                            </span>
                                            {% if item.change_log %}
                                            <span>‚Ä¢</span>
                                            <span class="italic text-gray-700 max-w-[150px] truncate" title="{{ item.change_log }}">{{ item.change_log }}</span>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- ACTIONS -->
                                    <div class="flex items-center gap-2 shrink-0">
                                         <!-- Preview -->
                                         <a href="{% url 'review_proposal' item.type item.id %}" {% if item.type == 'IMAGE' %}target="_blank"{% endif %} class="text-gray-600 hover:text-gray-300 transition" title="Ver Snapshot">
                                            üëÅÔ∏è
                                        </a>
                                        
                                        <!-- RESTORE -->
                                        <form method="post" action="{% if item.type == 'WORLD' %}{% url 'restaurar_version' item.id %}{% elif item.type == 'NARRATIVE' %}{% url 'restaurar_narrativa' item.id %}{% elif item.type == 'IMAGE' %}{% url 'restaurar_imagen' item.id %}{% endif %}">
                                            {% csrf_token %}
                                            <button type="submit" class="flex items-center gap-1.5 bg-blue-900/20 hover:bg-blue-600 text-blue-500 hover:text-white text-xs font-bold px-3 py-1.5 rounded border border-blue-900/50 transition-all shadow-lg" title="Restaurar a Pendientes" data-confirm="¬øRestaurar esto a Pendientes?">
                                                <span>üîÑ</span> Restaurar
                                            </button>
                                        </form>

                                        <!-- DELETE FOREVER (Superuser Only) -->
                                        {% if request.user.is_superuser %}
                                        <form method="post" action="{% if item.type == 'WORLD' %}{% url 'borrar_propuesta' item.id %}{% elif item.type == 'NARRATIVE' %}{% url 'borrar_narrativa_version' item.id %}{% elif item.type == 'IMAGE' %}{% url 'borrar_imagen_definitivo' item.id %}{% endif %}">
                                            {% csrf_token %}
                                            <button type="submit" class="flex items-center gap-1.5 bg-red-900/20 hover:bg-red-600 text-red-500 hover:text-white text-xs font-bold px-3 py-1.5 rounded border border-red-900/50 transition-all shadow-lg" 
                                                    title="ELIMINAR DEFINITIVAMENTE" 
                                                    data-confirm="‚ö†Ô∏è PELIGRO ‚ö†Ô∏è\n\n¬øEst√°s seguro de ELIMINAR DEFINITIVAMENTE este registro del historial?\n\nEsta acci√≥n NO SE PUEDE DESHACER." 
                                                    data-destructive="true">
                                                <span>üíÄ</span>
                                            </button>
                                        </form>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <!-- PREVIEW (Collapsed State: Show summary only?) User asked for grouped style. -->
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-gray-600 italic text-center py-4">No hay historial de versiones archivadas.</p>
                    {% endif %}
                </div>
            </details>

            <!-- EVENT LOG (AUDIT) -->
            <h2 class="text-2xl font-bold text-blue-400 mt-12 mb-4">üìã Registro de Actividad (Audit Log)</h2>
            
            <div class="space-y-4">
                <details class="group bg-card border border-blue-900/30 rounded-xl overflow-hidden shadow-lg">
                    <summary class="flex justify-between items-center p-4 cursor-pointer bg-blue-900/20 hover:bg-blue-900/30 transition list-none">
                        <span class="font-bold text-blue-200 flex items-center gap-2">üåç Cambios en MUNDOS <span class="text-xs bg-blue-900 text-blue-300 px-2 rounded-full">{{ logs_world|length }}</span></span>
                        <span class="text-blue-400 transform group-open:rotate-180 transition">‚ñº</span>
                    </summary>
                    <div class="overflow-x-auto">
                        {% include "components/_log_table.html" with logs=logs_world color="blue" %}
                    </div>
                </details>

                <details class="group bg-card border border-purple-900/30 rounded-xl overflow-hidden shadow-lg">
                    <summary class="flex justify-between items-center p-4 cursor-pointer bg-purple-900/20 hover:bg-purple-900/30 transition list-none">
                        <span class="font-bold text-purple-200 flex items-center gap-2">üìñ Cambios en NARRATIVAS <span class="text-xs bg-purple-900 text-purple-300 px-2 rounded-full">{{ logs_narrative|length }}</span></span>
                        <span class="text-purple-400 transform group-open:rotate-180 transition">‚ñº</span>
                    </summary>
                    <div class="overflow-x-auto">
                        {% include "components/_log_table.html" with logs=logs_narrative color="purple" %}
                    </div>
                </details>

                <details class="group bg-card border border-pink-900/30 rounded-xl overflow-hidden shadow-lg">
                    <summary class="flex justify-between items-center p-4 cursor-pointer bg-pink-900/20 hover:bg-pink-900/30 transition list-none">
                        <span class="font-bold text-pink-200 flex items-center gap-2">üñºÔ∏è Cambios en IM√ÅGENES <span class="text-xs bg-pink-900 text-pink-300 px-2 rounded-full">{{ logs_image|length }}</span></span>
                        <span class="text-pink-400 transform group-open:rotate-180 transition">‚ñº</span>
                    </summary>
                    <div class="overflow-x-auto">
                        {% include "components/_log_table.html" with logs=logs_image color="pink" %}
                    </div>
                </details>

                <details class="group bg-card border border-gray-800 rounded-xl overflow-hidden shadow-lg">
                    <summary class="flex justify-between items-center p-4 cursor-pointer bg-gray-900/50 hover:bg-gray-800 transition list-none">
                        <span class="font-bold text-gray-400 flex items-center gap-2">‚öôÔ∏è Otros Eventos <span class="text-xs bg-gray-800 text-gray-300 px-2 rounded-full">{{ logs_other|length }}</span></span>
                        <span class="text-gray-500 transform group-open:rotate-180 transition">‚ñº</span>
                    </summary>
                    <div class="overflow-x-auto">
                        {% include "components/_log_table.html" with logs=logs_other color="gray" %}
                    </div>
                </details>
            </div>

        </form>
    </div>
{% endblock %}

{% block modals %}
<script>
async function submitWithFeedback(form, title, promptText) {
    if (!window.CaosModal) {
        // Fallback if CaosModal is not loaded (should not happen)
        let r = prompt(promptText);
        if (r !== null) {
            form.admin_feedback.value = r;
            form.submit();
        }
        return;
    }

    const result = await CaosModal.prompt(title, promptText, 'Escribe aqu√≠ tu mensaje...', 'Enviar');

    if (result !== null) {
        form.admin_feedback.value = result;
        form.submit();
    }
}
</script>
{% endblock %}
