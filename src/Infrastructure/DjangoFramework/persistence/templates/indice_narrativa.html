{% extends "layouts/base.html" %}
{% load static %}

{% block title %}Biblioteca | {{ world.name }}{% endblock %}

{% block extra_head %}
<style>
    /* Estilos especÃ­ficos que no estÃ¡n en base */
    .lore-card { transition: 0.2s; }
    .lore-card:hover { transform: translateX(5px); }
</style>
{% endblock %}

{% block content %}
    <div class="container mx-auto px-4 md:px-8 max-w-[1400px] mt-8">
        <!-- TITLE SECTION -->
        <div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <h1 class="text-4xl font-extrabold tracking-tight text-white flex items-center gap-3">
                <span class="text-accent underline decoration-accent/30 underline-offset-8 decoration-2">BIBLIOTECA</span>
            </h1>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <!-- MAIN CONTENT -->
        <div class="col-span-1 lg:col-span-3">
            <h1 class="text-3xl font-bold text-accent mb-2">
                {{ world.name }} 
                <span class="text-sm text-gray-600 ml-2">ARCHIVO</span>
                {% if viewing_period and not viewing_period.is_current %}
                    <span class="text-sm bg-indigo-900/50 text-indigo-300 px-3 py-1 rounded-full border border-indigo-700 ml-3">
                        ðŸ“… {{ viewing_period.title }}
                    </span>
                {% endif %}
            </h1>
            <div class="h-1 w-full bg-gray-800 mb-8"></div>
            
            {% if lores %}
                <h2 class="text-xl font-bold text-indigo-400 mb-4 pb-2 border-b border-gray-800">ðŸ“œ Lores & Fundamentos</h2>
                <div class="space-y-2 mb-8">
                    {% for l in lores %}
                        {% include "components/_narrativa_tree_item.html" with node=l %}
                    {% endfor %}
                </div>
            {% endif %}

            {% if historias %}
                <h2 class="text-xl font-bold text-indigo-400 mb-4 pb-2 border-b border-gray-800">ðŸ“– Historias & CapÃ­tulos</h2>
                <div class="space-y-2 mb-8">
                    {% for h in historias %}
                        {% include "components/_narrativa_tree_item.html" with node=h %}
                    {% endfor %}
                </div>
            {% endif %}

            {% if not lores and not historias %}
                <div class="text-center py-16 border-2 border-dashed border-gray-800 rounded-xl text-gray-500">
                    <p class="mb-4 text-4xl">ðŸ“š</p>
                    <p>La biblioteca estÃ¡ vacÃ­a.</p>
                </div>
            {% endif %}
        </div>

        <!-- SIDEBAR -->
        <div class="col-span-1">
            {% if user.is_superuser or is_admin_role or is_author or allow_proposals %}
            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-800 sticky top-24">
                <h3 class="text-white font-bold mb-4">Crear RÃ¡pido</h3>
                
                <a href="{% url 'pre_crear_root' world.id 'L' %}?period={{ current_period_slug }}" class="block w-full py-3 mb-3 bg-purple-700 hover:bg-purple-600 text-white font-bold text-center rounded-lg transition shadow-lg">
                    + ðŸ“œ LORE
                </a>
                <a href="{% url 'pre_crear_root' world.id 'H' %}?period={{ current_period_slug }}" class="block w-full py-3 bg-blue-700 hover:bg-blue-600 text-white font-bold text-center rounded-lg transition shadow-lg">
                    + ðŸ“– HISTORIA
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        function toggleNarrative(event, nid, hasChildren) {
            event.stopPropagation(); 
            if (!hasChildren) return;
            const childrenDiv = document.getElementById('children-' + nid);
            const chevron = document.getElementById('chevron-' + nid);

            if (childrenDiv.style.display === 'none' || childrenDiv.classList.contains('hidden')) {
                childrenDiv.style.display = 'block';
                childrenDiv.classList.remove('hidden');
                if(chevron) chevron.style.transform = 'rotate(90deg)';
            } else {
                childrenDiv.style.display = 'none';
                childrenDiv.classList.add('hidden');
                if(chevron) chevron.style.transform = 'rotate(0deg)';
            }
        }
        function navigateToNarrative(url) {
            window.location.href = url;
        }
    </script>
    </div>
{% endblock %}