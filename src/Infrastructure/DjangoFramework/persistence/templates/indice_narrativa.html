{% extends "layouts/base.html" %}
{% load static %}

{% block title %}Biblioteca | {{ world.name }}{% endblock %}

{% block extra_head %}
<style>
    /* Estilos espec√≠ficos que no est√°n en base */
    .lore-card { transition: 0.2s; }
    .lore-card:hover { transform: translateX(5px); }
</style>
{% endblock %}

{% block content %}
    <div class="container mx-auto px-4 md:px-8 max-w-[1400px]">
        <!-- TOP BAR -->
        <div class="flex justify-between items-center mb-6 bg-gray-900/80 p-4 rounded-xl border border-gray-800 backdrop-blur-md">
            <div class="text-xl font-bold tracking-widest text-white">BIBLIOTECA</div>
            <div class="flex gap-2">
                <a href="{% url 'ver_mundo' world.id %}" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm border border-gray-700 transition">‚¨Ö Volver al Mundo</a>
                <a href="{% url 'home' %}" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm border border-gray-700 transition">üè† Inicio</a>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <!-- MAIN CONTENT -->
        <div class="col-span-1 lg:col-span-3">
            <h1 class="text-3xl font-bold text-accent mb-2">{{ world.name }} <span class="text-sm text-gray-600 ml-2">ARCHIVO</span></h1>
            <div class="h-1 w-full bg-gray-800 mb-8"></div>
            
            {% if lores %}
                <h2 class="text-xl font-bold text-indigo-400 mb-4 pb-2 border-b border-gray-800">üìú Lores & Fundamentos</h2>
                <div class="space-y-2 mb-8">
                    {% for l in lores %}
                        {% include "components/_narrativa_tree_item.html" with node=l %}
                    {% endfor %}
                </div>
            {% endif %}

            {% if historias %}
                <h2 class="text-xl font-bold text-indigo-400 mb-4 pb-2 border-b border-gray-800">üìñ Historias & Cap√≠tulos</h2>
                <div class="space-y-2 mb-8">
                    {% for h in historias %}
                        {% include "components/_narrativa_tree_item.html" with node=h %}
                    {% endfor %}
                </div>
            {% endif %}

            {% if not lores and not historias %}
                <div class="text-center py-16 border-2 border-dashed border-gray-800 rounded-xl text-gray-500">
                    <p class="mb-4 text-4xl">üìö</p>
                    <p>La biblioteca est√° vac√≠a.</p>
                </div>
            {% endif %}
        </div>

        <!-- SIDEBAR -->
        <div class="col-span-1">
            {% if user.is_superuser or is_admin_role or is_author or allow_proposals %}
            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-800 sticky top-24">
                <h3 class="text-white font-bold mb-4">Crear R√°pido</h3>
                
                <a href="{% url 'pre_crear_root' world.id 'L' %}" class="block w-full py-3 mb-3 bg-purple-700 hover:bg-purple-600 text-white font-bold text-center rounded-lg transition shadow-lg">
                    + üìú LORE
                </a>
                <a href="{% url 'pre_crear_root' world.id 'H' %}" class="block w-full py-3 bg-blue-700 hover:bg-blue-600 text-white font-bold text-center rounded-lg transition shadow-lg">
                    + üìñ HISTORIA
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        function toggleNarrative(event, nid, hasChildren) {
            event.stopPropagation(); 
            if (!hasChildren) return;
            const childrenDiv = document.getElementById('children-' + nid);
            const chevron = document.getElementById('chevron-' + nid);

            if (childrenDiv.style.display === 'none' || childrenDiv.classList.contains('hidden')) {
                childrenDiv.style.display = 'block';
                childrenDiv.classList.remove('hidden');
                if(chevron) chevron.style.transform = 'rotate(90deg)';
            } else {
                childrenDiv.style.display = 'none';
                childrenDiv.classList.add('hidden');
                if(chevron) chevron.style.transform = 'rotate(0deg)';
            }
        }
        function navigateToNarrative(url) {
            window.location.href = url;
        }
    </script>
    </div>
{% endblock %}