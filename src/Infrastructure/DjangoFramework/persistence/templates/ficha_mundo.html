{% extends "layouts/base.html" %}
{% load static %}
{% load metadata_tags %}

{% block title %}ECLAI v0.1 | {{ name }}{% endblock %}

{% block extra_head %}
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
{% endblock %}

{% block content %}
    <div class="mt-8"></div>



    <!-- MAIN GRID -->
    <!-- MAIN GRID -->
    <div class="bg-card border {% if is_period_view %}border-indigo-500/70 shadow-[0_0_40px_-10px_rgba(79,70,229,0.3)]{% else %}border-gray-800{% endif %} rounded-2xl max-w-[1600px] mx-4 xl:mx-auto overflow-hidden shadow-2xl grid grid-cols-1 lg:grid-cols-4 mb-10 transition-all duration-500">
        
        <!-- HEADER SECTION -->
        <div class="col-span-1 lg:col-span-4 bg-linear-to-r from-indigo-950 to-gray-900 p-6 border-b border-indigo-900 flex flex-col md:flex-row justify-between items-start gap-4 relative">
            <div>
                <div class="flex items-center flex-wrap gap-2 text-xs text-gray-400 mb-4">
                    <a href="{% url 'home' %}" class="px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded-full text-gray-300 transition border border-gray-700 hover:border-accent">üè†</a>
                    {% for b in breadcrumbs %}
                        {% if b.id %}
                        <a href="{% url 'ver_mundo' b.id %}" class="px-3 py-1 rounded-full border transition whitespace-nowrap {% if b.id == jid %}bg-accent/20 border-accent text-accent font-bold{% else %}bg-gray-800 border-gray-700 text-gray-300 hover:bg-gray-700 hover:border-gray-500{% endif %}">
                            {{ b.label }}
                        </a>
                        <!-- Arrow only if not last -->
                        {% else %}
                        <span class="text-gray-600 font-bold">...</span>
                        {% endif %}
                    {% endfor %}
                </div>

                <div class="flex items-center gap-3 mb-2">
                    <h1 class="text-3xl lg:text-4xl font-bold text-white flex items-center gap-3">
                        {{ name }}
                        {% if is_period_view %}
                        <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-green-500/20 border border-green-500/50 text-green-300 text-xs font-bold uppercase tracking-wider shadow-lg shadow-green-900/40 backdrop-blur-sm animate-pulse">
                            üìÖ {{ viewing_period.title }}
                        </span>
                        {% endif %}
                    </h1>
                    
                    {% if user.is_authenticated %}
                        <!-- New Status Toggle (Consistent with Card) -->
                        <div class="inline-block">
                            {% if has_authority %}
                            <form action="{% url 'toggle_status' public_id %}" method="POST" class="inline-block">
                                {% csrf_token %}
                                <!-- No need for next, view handles referer -->
                                <button type="submit"  
                                    class="text-xs px-2 py-1 rounded border transition font-bold uppercase
                                    {% if status_str == 'LIVE' %}bg-green-900/30 border-green-700 text-green-400 hover:bg-green-900/50
                                    {% else %}bg-red-900/30 border-red-700 text-red-400 hover:bg-red-900/50{% endif %}">
                                    {% if status_str == 'LIVE' %}üåê LIVE{% else %}‚õî OFFLINE{% endif %}
                                </button>
                            </form>
                            {% else %}
                                <!-- Read Only Badge for non-authors -->
                                <span class="text-xs px-2 py-1 rounded border 
                                    {% if status_str == 'LIVE' %}bg-green-900/30 border-green-700 text-green-400
                                    {% else %}bg-red-900/30 border-red-700 text-red-400{% endif %}">
                                    {% if status_str == 'LIVE' %}üåê LIVE{% else %}‚õî OFFLINE{% endif %}
                                </span>
                            {% endif %}
                        </div>

                        <!-- Lock Icon: Clickable for Authority, Static for others -->
                        {% if has_authority %}
                            <a href="{% url 'toggle_lock' public_id %}" class="text-xs px-2 py-1 rounded border border-gray-600 bg-gray-800 text-gray-400 hover:bg-gray-700" title="{% if is_locked %}Desbloquear edici√≥n{% else %}Bloquear edici√≥n para otros usuarios{% endif %}">
                                {% if is_locked %}üîí{% else %}üîì{% endif %}
                            </a>
                        {% elif is_locked %}
                             <!-- Static Lock Status for others -->
                            <span class="text-xs px-2 py-1 rounded border border-gray-600 bg-gray-900 text-red-500 cursor-help" title="Mundo Bloqueado por el Autor">
                                üîí
                            </span>
                        {% endif %}
                    {% endif %}
                </div>

                {% if user.is_superuser %}
                <div class="text-xs font-mono text-gray-500 bg-black/30 px-2 py-1 rounded inline-block border border-gray-800">
                    <span class="text-accent font-bold uppercase mr-2">{{ hierarchy_label }}</span>
                    J-ID: {{ jid }} <span class="text-gray-600 mx-2">|</span> CODE: <span class="text-accent">{{ public_id }}</span>
                </div>
                {% endif %}
            </div>
            
            {% if not is_preview %}
            {% if can_edit %}
            <div class="flex flex-col items-end gap-2">
                <div class="flex gap-2">
                    <a href="{% url 'dashboard' %}" class="p-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg transition shadow-md flex items-center gap-2" title="Panel de Control">
                        üöÄ <span class="hidden sm:inline text-xs font-bold">DASHBOARD</span>
                    </a>
                    
                    {% if is_locked and not is_admin_role and not user.is_superuser %}
                        <!-- LOCKED: Edit Disabled -->
                        <button disabled class="p-2 bg-gray-800 text-gray-600 cursor-not-allowed rounded-lg border border-gray-700 opacity-50" title="Bloqueado por Administraci√≥n">
                            üîí EDITAR BLOQUEADO
                        </button>
                        <button disabled class="p-2 bg-gray-800 text-gray-600 cursor-not-allowed rounded-lg border border-gray-700 opacity-50" title="Bloqueado">
                            üóëÔ∏è
                        </button>
                    {% else %}
                        {% if is_period_view %}
                            <button onclick="openEditPeriodModal()" class="p-1 px-2 bg-indigo-900/20 hover:bg-indigo-600 text-indigo-400 hover:text-white rounded-lg transition border border-indigo-900/50 text-[10px]" title="Editar Per√≠odo: {{ viewing_period.title }}">
                                ‚úèÔ∏è <span class="hidden sm:inline font-bold">EDITAR PER√çODO</span>
                            </button>
                            {% if has_authority %}
                            <form action="{% url 'delete_period' viewing_period.id %}" method="POST" class="inline">
                                {% csrf_token %}
                                <button type="submit" 
                                        data-confirm="¬øEst√°s seguro de solicitar el borrado de este per√≠odo hist√≥rico?"
                                        class="p-1 px-2 bg-red-900/20 hover:bg-red-600 text-red-400 hover:text-white rounded-lg transition border border-red-900/50 flex items-center justify-center text-[10px]" 
                                        title="Borrar Per√≠odo">
                                    üóëÔ∏è
                                </button>
                            </form>
                            {% endif %}
                        {% else %}
                            <button onclick="openEditModal()" class="p-1 px-2 bg-blue-900/20 hover:bg-blue-600 text-blue-400 hover:text-white rounded-lg transition border border-blue-900/50 text-[10px]" title="Editar Mundo">
                                ‚úèÔ∏è <span class="hidden sm:inline font-bold">EDITAR ACTUAL</span>
                            </button>
                            {% if has_authority %}
                            <a href="{% url 'borrar_mundo' jid %}" 
                               data-confirm="¬øEst√°s seguro de solicitar el borrado de este mundo? Se enviar√° al Dashboard." 
                               data-title="Solicitar Borrado" 
                               data-destructive="true"
                               class="p-1 px-2 bg-red-900/20 hover:bg-red-600 text-red-400 hover:text-white rounded-lg transition border border-red-900/50 flex items-center justify-center text-[10px]" 
                               title="Borrar Mundo de forma Segura">
                                üóëÔ∏è
                            </a>
                            {% endif %}
                        {% endif %}
                    {% endif %}
                </div>

                {% if is_retouch_mode %}
                    <div class="bg-purple-900/90 text-purple-100 flex items-center gap-2 px-4 py-2 rounded-xl border text-sm font-bold shadow-lg transition-all duration-300 active:scale-95 text-center backdrop-blur w-auto animate-pulse border-accent">
                         <span class="font-bold">‚úèÔ∏è MODO RETOQUE</span>
                    </div>
                {% endif %}
                {% include "components/_period_selector.html" %}

            </div>
            {% endif %}
            {% endif %}
        </div>

        <!-- CONTENT AREA (Left Column) -->
        <div class="col-span-1 lg:col-span-3 p-6 lg:p-8 border-r border-gray-800">
            
            <!-- CHILD ENTITIES LIST (Single Collapsible) -->
            <!-- CHILDREN LIST -->
            {% if hijos %}
            <details class="group mb-8" open>
                <summary class="flex justify-between items-center bg-[#1a1a2e] p-4 rounded-t-lg cursor-pointer border border-gray-800 hover:border-gray-600 transition list-none">
                    <h3 class="text-accent font-bold tracking-wider text-sm uppercase flex items-center gap-2">
                        üåå {{ children_label|default:"ENTIDADES HIJAS" }} ({{ hijos|length }})
                    </h3>
                    <span class="text-gray-500 transform group-open:rotate-180 transition duration-300">‚ñº</span>
                </summary>
                <div class="p-4 border-l border-r border-b border-gray-800 rounded-b-lg bg-black/20 grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for h in hijos %}
                        {% include "components/_entity_card.html" with entity=h variant="horizontal" %}
                    {% endfor %}
                </div>
            </details>
            {% endif %}


            <!-- VISUAL DATABASE HEADER -->
            <div class="flex justify-between items-end mb-4 border-b border-gray-800 pb-2">
                <h3 class="text-accent font-bold tracking-wider text-sm uppercase">Visual Database</h3>
                {% if can_edit %}
                <div class="flex gap-2">
                    {% if has_authority %}
                    <button onclick="toggleSelectionMode()" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold rounded transition border border-gray-600 shadow" id="btn-manage-photos" title="Borrar varias fotos">
                        ‚öôÔ∏è GESTIONAR
                    </button>
                    {% endif %}
                    
                    <button onclick="openAiModal()" class="px-3 py-1 bg-accent hover:bg-accent-hover text-white text-xs font-bold rounded transition shadow-lg shadow-purple-900/20">üé® IA GENERATOR</button>
                    
                    <button onclick="document.getElementById('file-upload').click()" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold rounded transition flex items-center gap-1">
                        üìé <span class="hidden sm:inline">SUBIR</span>
                    </button>
                    
                    <form id="form-manual-upload" method="POST" action="{% url 'subir_imagen_manual' public_id %}" enctype="multipart/form-data" class="hidden">
                        {% csrf_token %}
                        <input id="file-upload" type="file" name="imagen_manual" accept="image/*" multiple onchange="openUploadModal(this)">
                        <input type="hidden" id="hidden-use-original" name="use_original_name">
                        <input type="hidden" id="hidden-custom-name" name="custom_name">
                        <input type="hidden" name="period" value="{{ current_period_slug }}">
                    </form>
                </div>
                {% endif %}
            </div>

            <!-- GALLERY STRIP -->
            <div class="flex gap-4 overflow-x-auto pb-4 mb-8 snap-x min-h-[140px]">
                {% for img in imagenes %}
                <div class="snap-start shrink-0 relative group w-40 h-56 img-item transition-all duration-300">
                    <!-- Checkbox Overlay -->
                    <div class="absolute top-2 left-2 z-30 hidden selection-checkbox transform scale-125">
                        <input type="checkbox" class="w-5 h-5 accent-red-600 cursor-pointer shadow-lg" onchange="toggleImageSelection('{{ img.filename|escapejs }}', this)">
                    </div>

                    <div class="w-full h-full rounded-lg overflow-hidden border border-gray-700 cursor-pointer hover:border-accent transition shadow-lg bg-black relative" 
                         data-url="{% static "persistence/img/" %}{{ img.url }}" 
                         data-filename="{{ img.filename|escapejs }}"
                         onclick="if(!selectionMode) openLightbox(this.dataset.url, this.dataset.filename)">
                        
                        {% if img.is_cover %}
                        <!-- Cover Badge -->
                        <div class="absolute top-2 left-2 z-30 px-2.5 py-1 bg-linear-to-r from-purple-600 to-indigo-600 text-[10px] font-black text-white rounded-md shadow-lg border border-white/20 uppercase tracking-wider backdrop-blur-md flex items-center gap-1">
                            <span>üåü</span> PORTADA
                        </div>
                        {% endif %}

                        <img src="{% static 'persistence/img/' %}{{ img.url }}" alt="{{ img.filename }}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500 opacity-90 group-hover:opacity-100">
                        
                        <!-- Metadata Overlay -->
                        <div class="absolute inset-x-0 bottom-0 bg-linear-to-t from-black via-black/80 to-transparent p-2 text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
                            <div class="font-bold text-white truncate">{{ img.author|default:"?" }}</div>
                            <div class="text-gray-400 text-[10px]">{{ img.date|default:"-" }}</div>
                        </div>
                    </div>
                    {% if can_edit %}
                    <button data-jid="{{ jid }}" data-filename="{{ img.filename|escapejs }}"
                            onclick="event.stopPropagation(); solicitarBorradoIndividual(this.dataset.jid, this.dataset.filename);" 
                            class="absolute top-1 right-1 bg-red-600/80 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition hover:bg-red-500 shadow-lg backdrop-blur z-20 batch-hide">‚úï</button>
                    {% endif %}
                </div>
                {% empty %}
                <div class="w-full flex flex-col items-center justify-center text-gray-500 py-4 border border-dashed border-gray-800 rounded-lg min-w-[200px]">
                    <span class="text-2xl mb-2">üñºÔ∏è</span>
                    <p class="text-xs">No hay im√°genes visualizadas.</p>
                </div>
                {% endfor %} 
            </div>
            
            <!-- PERIOD SELECTOR (New Timeline System) -->

            <!-- DESCRIPTION -->
            <div class="prose prose-invert max-w-none mt-8">
                <h3 class="text-white font-bold mb-2">Descripci√≥n</h3>
                <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-800 text-gray-300 leading-relaxed whitespace-pre-wrap">{{ description|default:"Sin descripci√≥n disponible." }}</div>
            </div>
            
        </div>
        
        <!-- SIDEBAR (Right Column) -->
        <div class="col-span-1 p-6 lg:p-8 bg-gray-900/30">
            <h3 class="text-gray-500 text-xs font-bold uppercase mb-4">Informaci√≥n</h3>
            
            <!-- Author with Avatar -->
            <div class="mb-6 pb-6 border-b border-gray-800">
                <div class="flex items-center gap-3 mb-4">
                    <img src="{{ author_avatar_url|default:'https://ui-avatars.com/api/?name=Alone&background=random&color=fff&size=64&bold=true' }}" 
                         alt="{{ author_name }}" 
                         class="w-12 h-12 rounded-full border-2 border-gray-700 bg-gray-800 object-cover shadow-sm">
                    <div class="flex-1">
                        <p class="text-[9px] text-gray-500 font-bold uppercase tracking-widest mb-1">Autor</p>
                        <p class="text-sm font-bold text-accent">{{ author_name }}</p>
                    </div>
                </div>
                
                <!-- Created Date with Calendar Icon -->
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-12 h-12 rounded-full bg-[#121216]/50 border border-gray-800 flex items-center justify-center text-gray-500 shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    </div>
                    <div class="flex-1">
                        <p class="text-[9px] text-gray-500 font-bold uppercase tracking-widest mb-1">Creado</p>
                        <p class="text-sm font-bold text-white font-mono">{{ created_at|date:"d/m/Y" }}</p>
                    </div>
                </div>
                
                <!-- Version Badge -->
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full bg-green-900/20 border border-green-700/50 flex items-center justify-center text-green-400 shrink-0 font-bold text-xs">
                        v{{ version_live }}
                    </div>
                    <div class="flex-1">
                        <p class="text-[9px] text-gray-500 font-bold uppercase tracking-widest mb-1">Versi√≥n</p>
                        <p class="text-sm font-bold text-green-400 font-mono">LIVE</p>
                    </div>
                </div>
            </div>
            
            <!-- Social Actions (Unified Component) -->
            <div class="mb-6 pb-6 border-b border-gray-800 flex justify-center">
                {% include 'components/_social_card.html' with entity_key=period_entity_key compact=False show_likes=True show_comments=True show_share=True %}
            </div>

            <div class="mt-8 space-y-2">
                <h3 class="text-gray-500 text-xs font-bold uppercase mb-4">Acciones</h3>
                <a href="{% url 'ver_narrativa_mundo' public_id %}?period={{ current_period_slug }}" class="w-full px-4 py-3 bg-[#0f111a] hover:bg-[#151520] border border-gray-800 hover:border-blue-500/30 text-gray-300 hover:text-white rounded-lg flex items-center gap-3 transition-all group mb-3 shadow-lg">
                    <span class="text-lg opacity-70 group-hover:opacity-100 group-hover:text-blue-400 transition-colors">üìñ</span>
                    <span class="font-bold text-xs uppercase tracking-wider">Narrativa</span>
                </a>
                
                <a href="{% url 'mapa_arbol' public_id %}" class="w-full px-4 py-3 bg-[#0f111a] hover:bg-[#151520] border border-gray-800 hover:border-green-500/30 text-gray-300 hover:text-white rounded-lg flex items-center gap-3 transition-all group shadow-lg">
                    <span class="text-lg opacity-70 group-hover:opacity-100 group-hover:text-green-400 transition-colors">üå≥</span>
                    <span class="font-bold text-xs uppercase tracking-wider">Mapa √Årbol</span>
                </a>
                

                
                <div class="mt-8 pt-4 border-t border-gray-800">
                    {% if can_edit %}
                    <button onclick="openCreateModal()" class="w-full px-4 py-3 bg-[#0f111a] hover:bg-[#151520] border border-gray-800 hover:border-purple-500/50 text-gray-300 hover:text-white rounded-lg flex items-center justify-center gap-3 transition-all group shadow-lg">
                        <span class="text-xl opacity-70 group-hover:opacity-100 group-hover:text-purple-400 transition-colors">‚ú®</span> 
                        <span class="font-bold text-xs uppercase tracking-wider">GENERAR ENTORNO</span>
                    </button>
                    {% endif %}

                    <!-- Metadata Viewer (HUD) -->
                    {% include 'partials/_metadata_viewer.html' %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block modals %}
    {% include "partials/_world_modals.html" %}
    {% include "partials/_world_scripts.html" %}
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Auto Open Period Edit Modal (URL param check)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('edit_period') === 'true') {
                 setTimeout(() => { if(typeof openEditPeriodModal === 'function') openEditPeriodModal(); }, 500);
            }

            // Auto Open Metadata Modal (URL param check)
            if (urlParams.get('edit_metadata') === 'true') {
                 setTimeout(() => { if(typeof openMetadataModal === 'function') openMetadataModal(); }, 600);
            }

            // If Retouch Mode (World), lock navigation
            const isRetouchMode = Boolean(parseInt("{{ is_retouch_mode|yesno:'1,0' }}"));
            if (isRetouchMode) {
                // Disable links in children grid and Images
                const grid = document.querySelector('.animate-wave');
                const gallery = document.querySelector('.snap-x');
                
                if(grid) { grid.style.pointerEvents = 'none'; grid.style.opacity = '0.5'; }
                if(gallery) { gallery.style.pointerEvents = 'none'; gallery.style.opacity = '0.5'; }
                
                // Disable Generator Button
                const genBtn = document.querySelector("button[onclick='openCreateModal()']");
                if(genBtn) {
                    genBtn.disabled = true;
                    genBtn.onclick = null;
                    genBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }
        });
    </script>

    {% if edit_mode %}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Auto Open Edit Modal (World)
            setTimeout(() => { if(typeof openEditModal === 'function') openEditModal(); }, 300);
        });
    </script>
    {% endif %}

    <!-- BATCH DELETE UI -->
    {% include "partials/_modals_batch_delete.html" %}
    
    <!-- TIMELINE SNAPSHOT MODAL -->
    {% include "partials/_modals_timeline.html" %}

    <!-- PERIOD MANAGEMENT -->
    {% include "partials/_modals_period_management.html" %}
    
    <!-- WORLD COMMENTS MODAL -->
    {% include "partials/_world_comments_modal.html" %}
    
    <!-- WORLD SOCIAL INTERACTIONS SCRIPT -->
    <script>
        // World entity key for social interactions
        // Period-specific entity key (changes for historical periods)
        const worldEntityKey = "{{ period_entity_key }}";
        
        // No custom logic needed for Social Component.
        // The socialModule handles everything via 'data-like-icon' attributes 
        // generated by _social_card.html
    </script>
{% endblock %}
