{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECLAI v5.0 | {{ name }}</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#0a0a12',
                        card: '#161625',
                        accent: '#d633ff',
                        'accent-hover': '#b02ce0',
                    }
                }
            }
        }
    </script>
    <style>
        /* Scrollbar personalizada */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a12; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #d633ff; }
        /* Ocultar scrollbar en galer√≠a pero permitir scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-dark text-gray-200 font-sans p-4 lg:p-8 min-h-screen">

    {% if messages %}
    <div id="toast-container" class="fixed top-10 left-1/2 -translate-x-1/2 z-50 w-auto min-w-[300px] space-y-2 pointer-events-none transition-opacity duration-500">
        {% for message in messages %}
        <div class="p-4 rounded-lg shadow-2xl font-bold text-white text-center pointer-events-auto backdrop-blur-md border border-white/20 
            {% if message.tags == 'success' %}bg-green-600/90{% elif 'info' in message.tags %}bg-blue-600/90{% else %}bg-red-600/90{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    <script>
        setTimeout(() => {
            const el = document.getElementById('toast-container');
            if(el) {
                el.style.opacity = '0';
                setTimeout(() => el.remove(), 500);
            }
        }, 2000);
    </script>
    {% endif %}

    <div class="flex justify-between items-center mb-6 bg-gray-900/80 p-4 rounded-xl border border-gray-800 backdrop-blur-md">
        <div class="text-xl font-bold tracking-widest text-white">
            ECLAI <span class="text-xs text-green-400 ml-2 bg-green-900/30 px-2 py-1 rounded border border-green-800">
                {% if user.is_authenticated %}üë§ {{ user.username|upper }}{% else %}üëª AN√ìNIMO{% endif %}
            </span>
        </div>
        <div class="flex gap-2">
            <button onclick="history.back()" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm border border-gray-700 transition">‚¨ÖÔ∏è Atr√°s</button>
            <a href="{% url 'home' %}" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm border border-gray-700 transition">üè† Inicio</a>
        </div>
    </div>

    <div class="bg-card border border-gray-800 rounded-2xl max-w-7xl mx-auto overflow-hidden shadow-2xl grid grid-cols-1 lg:grid-cols-4">
        
        <div class="col-span-1 lg:col-span-4 bg-gradient-to-r from-indigo-950 to-gray-900 p-6 border-b border-indigo-900 flex flex-col md:flex-row justify-between items-start gap-4">
            <div>
                <div class="flex items-center gap-2 text-xs text-gray-400 mb-2">
                    <a href="{% url 'home' %}" class="hover:text-accent">üè† Universo</a>
                    {% for b in breadcrumbs %}
                        <span>‚Ä∫</span>
                        <a href="{% url 'ver_mundo' b.id %}" class="{% if b.id == jid %}text-accent font-bold{% else %}hover:text-white{% endif %}">{{ b.label }}</a>
                    {% endfor %}
                </div>

                <div class="flex items-center gap-3 mb-2">
                    <h1 class="text-3xl lg:text-4xl font-bold text-white">{{ name }}</h1>
                    
                    {% if user.is_authenticated %}
                        <a href="{% url 'toggle_visibilidad' jid %}" class="text-xs px-2 py-1 rounded border transition {% if visible %}bg-green-900/30 border-green-700 text-green-400{% else %}bg-red-900/30 border-red-700 text-red-400{% endif %}">
                            {% if visible %}üåê P√öBLICO{% else %}üëª PRIVADO{% endif %}
                        </a>
                        
                        {% if user.is_superuser %}
                        <a href="{% url 'toggle_lock' jid %}" class="text-xs px-2 py-1 rounded border border-gray-600 bg-gray-800 text-gray-400 hover:bg-gray-700">
                            {% if is_locked %}üîì Desbloquear{% else %}üîí Bloquear{% endif %}
                        </a>
                        {% endif %}
                    {% endif %}

                    {% if is_locked %}<span title="Bloqueado" class="text-red-500 text-xl">üîí</span>{% endif %}
                </div>

                <div class="text-xs font-mono text-gray-500 bg-black/30 px-2 py-1 rounded inline-block border border-gray-800">
                    J-ID: {{ jid }} <span class="text-gray-600 mx-2">|</span> CODE: <span class="text-accent">{{ public_id }}</span>
                </div>
            </div>
            
            {% if not is_preview %}
            <div class="flex gap-2">
                <a href="{% url 'dashboard' %}" class="p-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg transition shadow-md flex items-center gap-2" title="Panel de Control">
                    üöÄ <span class="hidden sm:inline text-xs font-bold">DASHBOARD</span>
                </a>
                <a href="#" class="p-2 bg-gray-700 hover:bg-gray-600 text-gray-200 rounded-lg transition border border-gray-600" title="Historial (Pr√≥ximamente)">
                    üìú
                </a>
                <button onclick="openEditModal()" class="p-2 bg-blue-900/20 hover:bg-blue-600 text-blue-400 hover:text-white rounded-lg transition border border-blue-900/50" title="Editar">
                    ‚úèÔ∏è
                </button>
                <a href="{% url 'borrar_mundo' jid %}" onclick="return confirm('¬øBorrar mundo?')" class="p-2 bg-red-900/20 hover:bg-red-600 text-red-400 hover:text-white rounded-lg transition border border-red-900/50" title="Borrar">
                    üóëÔ∏è
                </a>
            </div>
            {% endif %}
        </div>

        <div class="col-span-1 lg:col-span-3 p-6 lg:p-8 border-r border-gray-800">
            
            <!-- LISTA DE HIJOS -->
            {% if hijos %}
            <div class="mb-8">
                <h3 class="text-accent font-bold tracking-wider text-sm uppercase mb-4">Entidades Contenidas</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for h in hijos %}
                    <a href="{% url 'ver_mundo' h.public_id %}" class="block bg-gray-900/50 hover:bg-gray-800 border border-gray-700 hover:border-accent rounded-lg p-3 transition flex items-center gap-3 group">
                        <div class="w-12 h-12 rounded bg-black border border-gray-800 overflow-hidden shrink-0">
                            {% if h.img %}
                            <img src="{% static 'persistence/img/'|add:h.img %}" class="w-full h-full object-cover">
                            {% else %}
                            <div class="w-full h-full flex items-center justify-center text-xl">ü™ê</div>
                            {% endif %}
                        </div>
                        <div>
                            <div class="font-bold text-gray-200 group-hover:text-white">{{ h.name }}</div>
                            <div class="text-xs text-gray-500 font-mono">{{ h.short }}</div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="flex justify-between items-end mb-4 border-b border-gray-800 pb-2">
                <h3 class="text-accent font-bold tracking-wider text-sm uppercase">Visual Database</h3>
                {% if not is_preview %}
                <div class="flex gap-2">
                    <button onclick="openAiModal()" class="px-3 py-1 bg-accent hover:bg-accent-hover text-white text-xs font-bold rounded transition shadow-lg shadow-purple-900/20">üé® IA GENERATOR</button>
                    <button onclick="document.getElementById('file-upload').click()" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold rounded transition">üìé SUBIR</button>
                    
                    <form id="form-manual-upload" method="POST" action="{% url 'subir_imagen_manual' public_id %}" enctype="multipart/form-data" class="hidden">
                        {% csrf_token %}
                        <input id="file-upload" type="file" name="imagen_manual" accept="image/*" onchange="openUploadModal(this)">
                        <input type="hidden" id="hidden-use-original" name="use_original_name">
                        <input type="hidden" id="hidden-custom-name" name="custom_name">
                    </form>
                </div>
                {% endif %}
            </div>

            <div class="flex gap-4 overflow-x-auto pb-4 mb-8 snap-x min-h-[140px]">
                {% for img in imagenes %}
                <div class="snap-start shrink-0 relative group w-40 h-56">
                    <div class="w-full h-full rounded-lg overflow-hidden border border-gray-700 cursor-pointer hover:border-accent transition shadow-lg bg-black" onclick="openLightbox('{% static '/persistence/img/'|add:img.url %}', '{{ img.filename }}')">
                        <img src="{% static 'persistence/img/'|add:img.url %}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500 opacity-90 group-hover:opacity-100">
                    </div>
                    {% if not is_preview %}
                    <a href="{% url 'borrar_foto' jid img.filename %}" class="absolute top-1 right-1 bg-red-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition hover:bg-red-500 shadow-lg" onclick="event.stopPropagation(); return confirm('¬øBorrar?')">‚úï</a>
                    {% endif %}
                </div>
                {% empty %}
                <div class="w-full flex flex-col items-center justify-center text-gray-500 py-4 border border-dashed border-gray-800 rounded-lg min-w-[200px]">
                    <span class="text-2xl mb-2">üñºÔ∏è</span>
                    <p class="text-xs">No hay im√°genes visualizadas.</p>
                </div>
                {% endfor %} </div>

            <div class="prose prose-invert max-w-none mt-8">
                <h3 class="text-white font-bold mb-2">Descripci√≥n</h3>
                <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-800 text-gray-300 leading-relaxed whitespace-pre-wrap">{{ description|default:"Sin descripci√≥n disponible." }}</div>
            </div>
            
        </div>
        
        <div class="col-span-1 p-6 lg:p-8 bg-gray-900/30">
            <h3 class="text-gray-500 text-xs font-bold uppercase mb-4">Metadatos</h3>
            <div class="space-y-3 text-sm text-gray-400">
                <div class="flex justify-between border-b border-gray-800 pb-2"><span>Creado:</span> <span class="text-white">{{ created_at|date:"d/m/Y" }}</span></div>
                <div class="flex justify-between border-b border-gray-800 pb-2"><span>Versi√≥n:</span> <span class="text-green-400 font-mono">LIVE (v{{ version_live }})</span></div>
                <div class="flex justify-between border-b border-gray-800 pb-2"><span>Autor:</span> <span class="text-accent">{{ author_live|default:user.username }}</span></div>
            </div>

            <div class="mt-8 space-y-2">
                <h3 class="text-gray-500 text-xs font-bold uppercase mb-4">Acciones</h3>
                <a href="{% url 'ver_narrativa_mundo' jid %}" class="block w-full px-4 py-2 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded flex items-center gap-2 transition border border-gray-700 text-sm">
                    üìñ Narrativa
                </a>
                <a href="{% url 'mapa_arbol' public_id %}" class="block w-full px-4 py-2 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded flex items-center gap-2 transition border border-gray-700 text-sm">
                    üå≥ Mapa √Årbol
                </a>
                <a href="{% url 'escanear_planeta' jid %}" class="block w-full px-4 py-2 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded flex items-center gap-2 transition border border-gray-700 text-sm">
                    üì° Esc√°ner
                </a>

                <!-- CREACI√ìN DE ENTIDADES (Sidebar) -->
                {% if not is_preview and not is_locked %}
                <div class="bg-gray-900/50 p-3 rounded-lg border border-gray-800 mt-4">
                    <h4 class="text-[10px] font-bold text-gray-500 uppercase mb-2">Crear Entidad</h4>
                    <form method="POST" class="flex flex-col gap-2" id="create-child-form">
                        {% csrf_token %}
                        <input type="text" name="child_name" placeholder="Nombre..." class="bg-black border border-gray-700 rounded p-1.5 text-xs text-white focus:border-accent focus:outline-none w-full" required>
                        
                        <input type="hidden" name="child_type" id="child_type" value="PLACE">
                        
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" name="use_ai" id="use_ai" class="accent-accent w-3 h-3">
                            <span class="text-[10px] text-gray-400">Lore + Mapa (IA)</span>
                        </label>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <button type="submit" onclick="document.getElementById('child_type').value='PLACE'" class="px-2 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white text-[10px] font-bold rounded transition text-center">
                                üåç LUGAR
                            </button>
                            <button type="submit" onclick="document.getElementById('child_type').value='ENTITY'; document.getElementById('use_ai').checked=true;" class="px-2 py-1.5 bg-purple-600 hover:bg-purple-500 text-white text-[10px] font-bold rounded transition text-center" title="Generar Criatura con IA">
                                üëæ CRIATURA
                            </button>
                        </div>
                    </form>
                </div>
                {% endif %}

                {% if user.is_superuser and jid|length == 12 %}
                <a href="{% url 'init_hemisferios' jid %}" class="block w-full px-4 py-2 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded flex items-center gap-2 transition border border-gray-700 text-sm mt-2" onclick="return confirm('¬øInicializar hemisferios?')">
                    üåê Init Hemisferios
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <div id="editModal" class="hidden fixed inset-0 bg-black/90 z-50 items-center justify-center backdrop-blur-sm">
        <div class="bg-card border border-indigo-500/50 rounded-2xl p-6 max-w-lg w-full shadow-2xl">
            <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">‚úèÔ∏è Editar Mundo</h2>
            
            <form method="POST" action="{% url 'editar_mundo' jid %}">
                {% csrf_token %}
                <div class="mb-4">
                    <label class="block text-xs text-gray-500 uppercase font-bold mb-1">Nombre</label>
                    <input type="text" name="name" value="{{ name }}" class="w-full bg-black border border-gray-700 rounded p-2 text-white focus:border-accent focus:outline-none">
                </div>
                <div class="mb-4">
                    <label class="block text-xs text-gray-500 uppercase font-bold mb-1">Descripci√≥n</label>
                    <textarea name="description" rows="5" class="w-full bg-black border border-gray-700 rounded p-2 text-white focus:border-accent focus:outline-none">{{ description }}</textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-xs text-gray-500 uppercase font-bold mb-1">Raz√≥n del cambio (Obligatorio)</label>
                    <input type="text" name="reason" placeholder="Ej: Correcci√≥n, expansi√≥n..." class="w-full bg-black border border-gray-700 rounded p-2 text-white focus:border-accent focus:outline-none" required>
                </div>
                <div class="mb-6 bg-gray-800/50 p-3 rounded border border-gray-700">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="use_ai_edit" class="accent-accent w-4 h-4">
                        <span class="text-sm text-gray-300">‚ú® Refinar descripci√≥n con IA</span>
                    </label>
                </div>
                <div class="flex gap-3">
                    <button type="button" onclick="closeEditModal()" class="flex-1 py-2 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg border border-gray-700 transition">Cancelar</button>
                    <button type="submit" class="flex-1 py-2 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg shadow-lg transition">üíæ GUARDAR CAMBIOS</button>
                </div>
            </form>
        </div>
    </div>

    <div id="aiModal" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center backdrop-blur-sm">
        <div class="bg-card border border-accent/50 rounded-2xl p-8 max-w-md w-full text-center shadow-[0_0_50px_rgba(214,51,255,0.2)]">
            <h2 class="text-2xl font-bold text-white mb-1">Generador Neural</h2>
            <p class="text-xs text-gray-400 mb-6 uppercase tracking-widest">Stable Diffusion + Llama 3</p>
            
            <div id="ai-step-1">
                <p class="text-gray-300 mb-6 text-sm">La IA leer√° la descripci√≥n de este mundo y generar√° una visualizaci√≥n √∫nica.</p>
                <button onclick="generatePreview()" class="w-full py-3 bg-accent hover:bg-accent-hover text-white font-bold rounded-lg mb-3 transition">‚ú® GENERAR AHORA</button>
                <button onclick="closeAiModal()" class="text-gray-500 hover:text-white text-sm underline">Cancelar</button>
            </div>

            <div id="ai-step-loading" class="hidden py-8">
                <div class="text-4xl animate-bounce mb-4">üîÆ</div>
                <p class="text-accent font-bold animate-pulse">So√±ando p√≠xeles...</p>
            </div>

            <div id="ai-step-result" class="hidden">
                <img id="ai-preview-img" class="w-full rounded-lg border border-gray-700 mb-4 shadow-xl">
                <div class="text-left mb-4">
                    <label class="text-xs text-gray-500 uppercase font-bold">T√≠tulo</label>
                    <input type="text" id="ai-img-title" placeholder="Ej: Paisaje Desolado..." class="w-full bg-black border border-gray-700 rounded p-2 mt-1 text-white focus:border-accent focus:outline-none">
                </div>
                <div class="flex gap-3">
                    <button onclick="discardAiImage()" class="flex-1 py-2 bg-gray-800 hover:bg-red-900/50 text-gray-300 hover:text-red-200 rounded-lg border border-gray-700 transition">Descartar</button>
                    <button onclick="saveAiImage()" class="flex-1 py-2 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg shadow-lg shadow-green-900/50 transition">üíæ GUARDAR</button>
                </div>
            </div>
        </div>
    </div>

    <div id="uploadModal" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center backdrop-blur-sm">
        <div class="bg-card border border-gray-700 rounded-2xl p-8 max-w-md w-full text-center">
            <h2 class="text-xl font-bold text-white mb-4">Confirmar Subida</h2>
            <div id="file-info" class="text-xs font-mono text-accent mb-2"></div>
            <img id="preview-img" class="w-full h-48 object-contain bg-black rounded border border-gray-800 mb-4 hidden">
            
            <div class="bg-gray-950 p-4 rounded-lg border border-gray-800 text-left mb-4">
                <label class="flex items-center gap-2 mb-3 cursor-pointer group">
                    <input type="checkbox" id="chk-original-name" onchange="toggleCustomName()" class="accent-accent w-4 h-4">
                    <span class="text-sm text-gray-300 group-hover:text-white transition">Usar nombre original</span>
                </label>
                <input type="text" id="inp-custom-name" placeholder="O escribe un nombre..." class="w-full bg-black border border-gray-700 rounded p-2 text-sm text-white focus:border-accent focus:outline-none transition">
            </div>

            <div id="scan-status" class="text-xs font-bold mb-4 tracking-widest h-4"></div>

            <div class="flex gap-3 justify-center">
                <button onclick="closeUploadModal()" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded text-gray-300">Cancelar</button>
                <button id="btn-confirm-upload" onclick="confirmUpload()" class="px-6 py-2 bg-green-600 hover:bg-green-500 text-white font-bold rounded shadow-lg hidden">üöÄ SUBIR</button>
            </div>
        </div>
    </div>

    <div id="lightbox" class="fixed inset-0 bg-black/95 z-50 hidden items-center justify-center p-4 lg:p-10" onclick="if(event.target === this) closeLightbox()">
        <div class="max-w-5xl w-full bg-gray-900 rounded-xl overflow-hidden border border-gray-800 flex flex-col lg:flex-row shadow-2xl h-[90vh] lg:h-auto">
            <div class="flex-1 bg-black flex items-center justify-center relative p-4">
                <img id="lb-img" class="max-w-full max-h-[80vh] object-contain shadow-2xl">
            </div>
            <div class="w-full lg:w-80 bg-gray-950 p-6 border-l border-gray-800 flex flex-col">
                <div class="mb-6 border-b border-gray-800 pb-4">
                    <div class="text-[10px] text-accent font-bold tracking-widest uppercase mb-1">Ficha de Imagen</div>
                    <div class="flex items-start justify-between gap-2 mb-2 group">
                        <h2 id="lb-title" class="text-xl font-bold text-white leading-tight break-words">Sin T√≠tulo</h2>
                        <button onclick="editImageTitle()" class="text-gray-600 hover:text-white transition p-1" title="Renombrar">‚úèÔ∏è</button>
                    </div>
                    <div class="text-xs text-gray-400 space-y-1">
                        <div class="flex justify-between"><span>Por:</span> <span id="lb-uploader" class="text-green-400 font-bold">-</span></div>
                        <div class="flex justify-between"><span>Fecha:</span> <span id="lb-date">-</span></div>
                    </div>
                </div>
                
                <div class="bg-black p-3 rounded border border-gray-800 text-[10px] font-mono text-gray-600 mb-auto">
                    <div class="flex justify-between"><span>ORIGEN:</span> <span id="lb-meta" class="text-yellow-600">-</span></div>
                    <div class="flex justify-between mt-1 break-all"><span>REF:</span> <span id="lb-name">-</span></div>
                </div>

                <div class="space-y-2 mt-4">
                    <button onclick="setAsCover()" class="w-full py-3 bg-yellow-700/50 hover:bg-yellow-600 text-yellow-100 font-bold rounded transition border border-yellow-900">‚≠ê PORTADA</button>
                    <button onclick="closeLightbox()" class="w-full py-3 bg-gray-800 hover:bg-gray-700 text-white rounded transition border border-gray-700">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const metadataRaw = '{{ metadata|default:"{}"|escapejs }}';
        let allMetadata = {};
        try { allMetadata = JSON.parse(metadataRaw); } catch(e) { console.error(e); }
        const galleryLog = allMetadata.gallery_log || {};
        let currentBase64 = null;
        let nsfwModel = null;

        // INIT
        window.addEventListener('load', async () => {
            try { if(typeof nsfwjs !== 'undefined') nsfwModel = await nsfwjs.load(); } catch(e){}
        });

        // EDIT LOGIC
        function openEditModal() {
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');
        }
        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
        }

        // IA LOGIC
        function openAiModal() {
            document.getElementById('aiModal').classList.remove('hidden');
            document.getElementById('aiModal').classList.add('flex');
            document.getElementById('ai-step-1').classList.remove('hidden');
            document.getElementById('ai-step-loading').classList.add('hidden');
            document.getElementById('ai-step-result').classList.add('hidden');
            document.getElementById('ai-img-title').value = "";
        }
        function closeAiModal() {
            document.getElementById('aiModal').classList.add('hidden');
            document.getElementById('aiModal').classList.remove('flex');
        }
        
        function generatePreview() {
            document.getElementById('ai-step-1').classList.add('hidden');
            document.getElementById('ai-step-loading').classList.remove('hidden');
            fetch("{% url 'api_preview_foto' jid %}")
                .then(r => r.json())
                .then(data => {
                    document.getElementById('ai-step-loading').classList.add('hidden');
                    if(data.status === 'ok') {
                        currentBase64 = data.image;
                        document.getElementById('ai-preview-img').src = "data:image/webp;base64," + data.image;
                        document.getElementById('ai-step-result').classList.remove('hidden');
                    } else alert("Error IA: " + data.message);
                }).catch(e => { alert("Error conexi√≥n"); closeAiModal(); });
        }
        
        function saveAiImage() {
            const t = document.getElementById('ai-img-title').value || "Generado por IA";
            if(!currentBase64) return;
            fetch("{% url 'api_save_foto' jid %}", {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
                body: JSON.stringify({ image: currentBase64, title: t })
            }).then(r => r.json()).then(d => {
                if(d.status === 'ok') location.reload();
                else alert("Error: " + d.message);
            });
        }
        function discardAiImage() { if(confirm("¬øDescartar?")) openAiModal(); }

        // UPLOAD LOGIC
        function openUploadModal(input) {
            if(!input.files[0]) return;
            const f = input.files[0];
            const modal = document.getElementById('uploadModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            document.getElementById('preview-img').src = URL.createObjectURL(f);
            document.getElementById('preview-img').classList.remove('hidden');
            document.getElementById('file-info').innerText = f.name;
            
            // Reset
            document.getElementById('chk-original-name').checked = false;
            document.getElementById('inp-custom-name').value = f.name.split('.')[0];
            toggleCustomName();
            
            // Scan fake
            const st = document.getElementById('scan-status');
            const btn = document.getElementById('btn-confirm-upload');
            st.innerText = "‚è≥ ANALIZANDO..."; st.style.color = "#aaa"; btn.classList.add('hidden');
            setTimeout(() => { st.innerText = "‚úÖ SEGURO"; st.style.color = "#4ade80"; btn.classList.remove('hidden'); }, 800);
        }
        
        function closeUploadModal() { 
            const modal = document.getElementById('uploadModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('file-upload').value=""; 
        }
        
        function toggleCustomName() {
            const chk = document.getElementById('chk-original-name');
            const inp = document.getElementById('inp-custom-name');
            inp.disabled = chk.checked;
            inp.style.opacity = chk.checked ? 0.5 : 1;
        }
        
        function confirmUpload() {
            document.getElementById('hidden-use-original').value = document.getElementById('chk-original-name').checked ? 'true' : 'false';
            document.getElementById('hidden-custom-name').value = document.getElementById('inp-custom-name').value;
            document.getElementById('form-manual-upload').submit();
        }

        // LIGHTBOX LOGIC
        function openLightbox(url, fn) {
            const lb = document.getElementById('lightbox');
            lb.classList.remove('hidden');
            lb.classList.add('flex');
            document.getElementById('lb-img').src = url;
            document.getElementById('lb-name').innerText = fn;
            
            const d = galleryLog[fn] || {};
            document.getElementById('lb-title').innerText = d.title || fn;
            document.getElementById('lb-uploader').innerText = d.uploader || "-";
            document.getElementById('lb-date').innerText = d.date || "-";
            document.getElementById('lb-title').dataset.filename = fn;
        }
        
        function closeLightbox() { 
            const lb = document.getElementById('lightbox');
            lb.classList.add('hidden');
            lb.classList.remove('flex');
        }
        
        function editImageTitle() {
            const el = document.getElementById('lb-title');
            const fn = el.dataset.filename;
            const nt = prompt("Nuevo t√≠tulo:", el.innerText);
            if(nt) {
                fetch("{% url 'api_update_image_metadata' jid %}", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
                    body: JSON.stringify({ filename: fn, title: nt })
                })
                .then(r => r.json())
                .then(d => {
                    if(d.status === 'ok') {
                        el.innerText = nt;
                        if(!galleryLog[fn]) galleryLog[fn] = {};
                        galleryLog[fn].title = nt;
                    } else alert(d.message);
                });
            }
        }
        
        function setAsCover() {
            const filename = document.getElementById('lb-name').innerText;
            if(filename !== "-") window.location.href = "{% url 'set_cover_image' jid '123456' %}".replace('123456', encodeURIComponent(filename));
        }
    </script>
</body>
</html>