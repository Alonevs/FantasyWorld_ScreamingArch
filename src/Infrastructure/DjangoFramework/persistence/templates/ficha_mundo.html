{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ECLAI v3.0 | {{ name }}</title>
    <style>
        
        body { background-color: #0a0a12; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; padding: 20px 40px; }
        
        /* SCROLLBARS GENERALES */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a12; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #d633ff; }

        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid #333; padding-bottom: 15px; background: #0e0e16; padding: 15px 20px; border-radius: 10px; }
        .logo { font-size: 1.5em; font-weight: bold; color: #fff; letter-spacing: 2px; }
        .nav-group { display: flex; gap: 10px; }
        .nav-btn { background: #333; color: #fff; padding: 8px 15px; border-radius: 5px; text-decoration: none; font-size: 0.9em; border: 1px solid #444; cursor: pointer; }
        .nav-btn:hover { background: #555; }
        .nav-btn.special { background: #d633ff; border-color: #d633ff; }
        .nav-btn.special:hover { background: #a569bd; }
        
        .card { background: #161625; border: 1px solid #2a2a40; border-radius: 15px; max-width: 1200px; margin: 0 auto; overflow: hidden; display: grid; grid-template-columns: 3fr 1fr; }
        .card-header { grid-column: 1 / -1; background: linear-gradient(90deg, #2b1a45 0%, #1a1a2e 100%); padding: 20px; border-bottom: 2px solid #4a3b69; display: flex; justify-content: space-between; align-items: flex-start; }
        
        /* LAYOUT PRINCIPAL */
        .main-content { 
            padding: 30px; 
            border-right: 1px solid #2a2a40; 
            min-width: 0; /* Vital para que el scroll funcione dentro de Grid/Flex */
        }
        .sidebar { padding: 30px; background: #13131f; font-size: 0.9em; min-width: 250px; }
        
        .breadcrumbs { margin-bottom: 10px; font-size: 0.85em; color: #888; display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }
        .crumb-item { background: #333; padding: 2px 8px; border-radius: 10px; text-decoration: none; color: #ccc; border: 1px solid #444; transition:0.2s; }
        .crumb-item:hover { background: #d633ff; color: #fff; border-color: #d633ff; }
        .crumb-separator { color: #666; }
        .crumb-active { color: #fff; font-weight: bold; border-color: #d633ff; background: rgba(214, 51, 255, 0.1); }

        .status-badge { padding: 4px 12px; border-radius: 4px; font-weight: bold; font-size: 0.8em; letter-spacing: 1px; text-transform: uppercase; display: inline-block; }
        .st-live { background: #2ecc71; color: #000; border: 1px solid #27ae60; }
        .st-draft { background: #f39c12; color: #000; border: 1px solid #d35400; }

        .actions { display: flex; gap: 10px; }
        .btn { padding: 5px 10px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.8em; text-decoration: none; color:#fff; border:none; }
        .btn-edit { background: #3498db; } .btn-del { background: #e74c3c; }
        
        /* --- GALER√çA CON SCROLL HORIZONTAL --- */
        .gallery { 
            display: flex; 
            gap: 15px; 
            overflow-x: auto;      /* Scroll lateral activado */
            white-space: nowrap;   /* No saltar de l√≠nea */
            padding-bottom: 15px;  /* Espacio para la barra */
            margin-bottom: 20px;
            
            /* Estilo Scrollbar Firefox */
            scrollbar-width: thin;
            scrollbar-color: #d633ff #0e0e16;
        }
        /* Estilo Scrollbar Chrome/Edge */
        .gallery::-webkit-scrollbar { height: 8px; }
        .gallery::-webkit-scrollbar-track { background: #0e0e16; border-radius: 4px; }
        .gallery::-webkit-scrollbar-thumb { background: #d633ff; border-radius: 4px; }
        .gallery::-webkit-scrollbar-thumb:hover { background: #a569bd; }

        .gallery-item { 
            position: relative; 
            display: inline-block; 
            flex: 0 0 auto; /* No encoger */
        }
        .gallery-item img { 
            width: 160px; 
            height: 220px; 
            object-fit: cover; 
            border-radius: 8px; 
            border: 2px solid #333; 
            transition: 0.2s;
        }
        .gallery-item:hover img { border-color: #d633ff; transform: scale(1.02); }
        
        .btn-delete-img { position: absolute; top: 5px; right: 5px; background: rgba(231, 76, 60, 0.9); color: white; width: 24px; height: 24px; border-radius: 50%; text-align: center; line-height: 24px; font-size: 12px; text-decoration: none; cursor: pointer; opacity: 0; transition: 0.2s; }
        .gallery-item:hover .btn-delete-img { opacity: 1; }

        .section-title { color: #a0a0ff; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px; margin-top: 25px; font-size: 1.1em; display: flex; justify-content: space-between; align-items: center; }
        .lore-box { background: #111; padding: 20px; border-left: 4px solid #d633ff; font-style: italic; color: #ccc; white-space: pre-wrap; margin-bottom: 10px; max-height: 300px; overflow-y: auto; }
        .metadata-box { background: #0e0e16; color: #0f0; font-family: 'Consolas', monospace; padding: 15px; border-radius: 5px; font-size: 0.8em; overflow-x: auto; border: 1px solid #333; }
        
        .children-list { display: grid; gap: 5px; }
        .child-link { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #1f1f33; text-decoration: none; color: #eee; border-radius: 6px; border: 1px solid #333; transition:0.2s; }
        .child-link:hover { border-color: #d633ff; transform: translateX(5px); }
        .child-index { font-family: 'Courier New', monospace; color: #d633ff; background: #000; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; }
        
        .vis-toggle { text-decoration: none; font-weight: bold; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; transition:0.3s; border:1px solid transparent; cursor:pointer; display:inline-block; }
        .vis-public { background: rgba(46, 204, 113, 0.1); color: #2ecc71; border-color: #2ecc71; }
        .vis-private { background: rgba(231, 76, 60, 0.1); color: #e74c3c; border-color: #e74c3c; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-row { display:flex; justify-content:space-between; border-bottom:1px solid #333; padding:5px 0; font-size:0.9em; }
        .label { color: #888; text-transform: uppercase; font-size:0.8em; }
        .value { font-family: 'Courier New', monospace; color: #fff; font-weight: bold; text-align:right; }

        /* RPG STATS */
        .rpg-card { background: #0e0e16; border: 1px solid #444; border-radius: 8px; padding: 20px; margin-bottom: 20px; position: relative; overflow: hidden; }
        .rpg-card::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, #d633ff, #2ecc71); }
        .rpg-header { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px; }
        .rpg-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; }
        .rpg-stat { background: #1f1f33; padding: 10px; border-radius: 5px; text-align: center; }
        .rpg-val { font-size: 1.1em; color: #fff; font-weight: bold; }
        .rpg-label { font-size: 0.7em; color: #aaa; text-transform: uppercase; display: block; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; justify-content: center; align-items: center; }
        .modal:target { display: flex; }
        .modal-content { background: #161625; padding: 30px; border-radius: 10px; width: 600px; border: 1px solid #d633ff; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .edit-form input, .edit-form textarea { width: 100%; background: #0a0a12; border: 1px solid #444; color: #fff; padding: 10px; margin-top: 5px; margin-bottom:15px; box-sizing:border-box; }
        
        .child-form { background: #1f1f33; padding: 15px; border-radius: 8px; margin-top: 20px; display: flex; gap: 10px; }
        .child-form input { background: #0a0a12; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 4px; flex-grow: 1; }
        .child-form button { background: #d633ff; color: #fff; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; }
        .child-form select { background: #000; color: #fff; border: 1px solid #444; padding: 8px; border-radius: 4px; }
    
    
        /* --- ESTILOS DATA GRID (NUEVO) --- */
        .data-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 10px; }
        .data-card { background: #13131e; border: 1px solid #333; border-radius: 6px; overflow: hidden; }
        .data-card-header { background: #1f1f33; padding: 8px 12px; border-bottom: 1px solid #333; font-weight: bold; color: #d633ff; text-transform: uppercase; font-size: 0.85em; letter-spacing: 1px; }
        .data-card-body { padding: 10px; }
        .data-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #2a2a40; padding: 6px 0; font-size: 0.9em; }
        .data-row:last-child { border-bottom: none; }
        .data-key { color: #888; text-transform: capitalize; }
        .data-val { color: #eee; font-weight: bold; text-align: right; }
        
        /* Listas dentro de tarjetas (ej: Lunas) */
        .data-list-item { background: #000; padding: 2px 8px; border-radius: 4px; border: 1px solid #444; font-size: 0.8em; display: inline-block; margin-top: 2px; }
    </style>

</head>
<body>
    <div class="top-bar">
        <div class="logo">ECLAI v3.0 // SYSTEM</div>
        <div class="nav-group">
            <button class="nav-btn" onclick="history.back()">‚¨ÖÔ∏è Atr√°s</button>
            <a href="{% url 'home' %}" class="nav-btn">üè† Inicio</a>
            <a href="{% url 'centro_control' %}" class="nav-btn special">üéõÔ∏è Gesti√≥n</a>
        </div>
    </div>

    {% if is_preview %}
    <div style="background:#f39c12; color:#fff; padding:15px; text-align:center; margin-bottom:20px; border-radius:8px; margin: 0 auto 20px auto; max-width: 1000px;">
        <h2>‚ö†Ô∏è MODO INSPECCI√ìN: VERSI√ìN {{ version_live }} (Propuesta)</h2>
        <p>Autor: <strong>{{ author }}</strong> | Raz√≥n: <em>{{ change_log }}</em></p>
        <div style="margin-top:10px;">
            <a href="{% url 'aprobar_version' version_id %}" class="btn" style="background:#27ae60;">‚úÖ APROBAR</a>
            <a href="{% url 'rechazar_version' version_id %}}" class="btn" style="background:#c0392b;">‚ùå RECHAZAR</a>
            <a href="{% url 'centro_control' %}" class="btn" style="background:#7f8c8d;">Cancelar</a>
        </div>
    </div>
    {% endif %}

    <div class="card">
        <div class="card-header">
            <div>
                <div class="breadcrumbs">
                    <a href="{% url 'home' %}" class="crumb-item">üè† Universo</a>
                    {% for b in breadcrumbs %}
                        <span class="crumb-separator">‚Ä∫</span>
                        <a href="{% url 'ver_mundo' b.id %}" class="crumb-item {% if b.id == jid %}crumb-active{% endif %}">
                            {{ b.label }}
                        </a>
                    {% endfor %}
                </div>
                
                <h1 style="margin:10px 0 5px 0;">{{ name }}</h1>
                
                <div style="margin-top:5px;">
                    {% if status == 'LIVE' %}
                        <span class="status-badge st-live">üü¢ LIVE v{{ version_live }} (Autor: {{ author_live }})</span>
                    {% else %}
                        <span class="status-badge st-draft">‚ö†Ô∏è {{ status|default:"DRAFT" }}</span>
                    {% endif %}
                </div>
            </div>
            
            {% if not is_preview %}
            <div class="actions">
                <a href="#editModal" class="btn btn-edit">‚úèÔ∏è Editar</a>
                <a href="{% url 'borrar_mundo' jid %}" class="btn btn-del" onclick="return confirm('¬øSeguro? Se borrar√°n hijos tambi√©n.')">üóëÔ∏è Borrar</a>
            </div>
            {% endif %}
        </div>

        <div class="main-content">
            {% if propuestas %}
            <div style="background:rgba(241, 196, 15, 0.1); border:1px solid #f1c40f; padding:15px; border-radius:8px; margin-bottom:20px;">
                <strong style="color:#f1c40f;">‚ö†Ô∏è Hay {{ propuestas|length }} revisi√≥n(es) pendiente(s)</strong>
                <div style="margin-top:5px; font-size:0.9em;">
                    <a href="{% url 'centro_control' %}" style="color:#d633ff;">Ir al Centro de Control</a> para aprobar.
                </div>
            </div>
            {% endif %}

            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <div class="section-title" style="margin:0;">Arte Visual</div>
                {% if not is_preview %}<a href="{% url 'generar_foto_extra' jid %}" class="btn" style="background:#9b59b6; font-size:0.7em;">üé® + FOTO IA</a>{% endif %}
            </div>
            <div class="gallery">
                {% for img in imagenes %} 
                <div class="gallery-item">
                    <img src="{% static 'persistence/img/'|add:img.url %}">
                    {% if not is_preview %}
                    <a href="{% url 'borrar_foto' jid img.filename %}" class="btn-delete-img" onclick="return confirm('¬øBorrar imagen?')">‚úï</a>
                    {% endif %}
                </div>
                {% empty %} 
                <div style="color:#555; padding:20px; border:1px dashed #444; width:100%; text-align:center;">No hay arte generado.</div> 
                {% endfor %}
            </div>

            {% if metadata_obj.peligro or metadata_obj.tipo %}
            <div class="rpg-card">
                <div class="rpg-header">
                    <span style="color:#2ecc71; font-weight:bold; font-family:monospace;">FICHA T√âCNICA</span>
                    <span style="font-size:0.8em; color:#666;">ID: {{ jid }}</span>
                </div>
                <div class="rpg-stats">
                    <div class="rpg-stat"><span class="rpg-label">Tipo</span><span class="rpg-val" style="color:#a0a0ff;">{{ metadata_obj.tipo }}</span></div>
                    <div class="rpg-stat"><span class="rpg-label">Tama√±o</span><span class="rpg-val">{{ metadata_obj.tamano }}</span></div>
                    <div class="rpg-stat"><span class="rpg-label">Peligro</span><span class="rpg-val" style="color:#e74c3c;">{{ metadata_obj.peligro }}/5</span></div>
                </div>
                {% if metadata_obj.rasgos %}
                <div style="margin-top:10px; color:#ccc; font-style:italic;">"{{ metadata_obj.rasgos }}"</div>
                {% endif %}
            </div>
            {% endif %}

            <div class="section-title">Descripci√≥n Conceptual</div>
            <div class="lore-box">{{ description|default:"Sin descripci√≥n definida." }}</div>
            
            
            <div class="section-title">Datos Analizados (Metadata)</div>
            
            {% if metadata_obj %}
            <div class="data-grid">
                {% for key, value in metadata_obj.items %}
                    {% if key != 'tipo_entidad' and key != 'biology' and key != 'stats' and key != 'visuals' %}
                    <div class="data-card">
                        <div class="data-card-header">{{ key }}</div>
                        <div class="data-card-body">
                            {% if key == 'fisica' or key == 'clima' or key == 'leyes_fundamentales' or key == 'geo_config' or key == 'climate_profile' %}
                                {% for subkey, subval in value.items %}
                                <div class="data-row">
                                    <span class="data-key">{{ subkey }}:</span>
                                    <span class="data-val">
                                        {% if subval|length > 0 and subval.0 %}
                                            {% if subval.append %} 
                                                {% for item in subval %}<span class="data-list-item">{{ item }}</span> {% endfor %}
                                            {% else %}
                                                {{ subval }}
                                            {% endif %}
                                        {% else %}
                                            {{ subval }}
                                        {% endif %}
                                    </span>
                                </div>
                                {% endfor %}
                            
                            {% else %}
                                <div style="color:#ccc; font-style:italic;">{{ value }}</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            {% else %}
                <div style="color:#555; font-style:italic; padding:10px;">Sin datos. Usa el bot√≥n ESCANEAR.</div>
            {% endif %}
            
            
        </div>

        <div class="sidebar">
            <div class="section-title" style="margin-top:0;">Ficha T√©cnica</div>
            
            <div class="stats-grid">
                <div class="stat-row"><span class="label">J-ID</span><span class="value">{{ jid }}</span></div>
                <div class="stat-row"><span class="label">CODE</span><span class="value" style="color:#d633ff">{{ code_entity }}</span></div>
                <div class="stat-row"><span class="label">Creado</span><span class="value" style="font-size:0.9em;">{{ created_at|date:"d/m/Y" }}</span></div>
                <div class="stat-row"><span class="label">Actualizado</span><span class="value" style="font-size:0.9em;">{{ updated_at|date:"d/m/Y" }}</span></div>
                <div class="stat-row" style="align-items:center;">
                    <span class="label">Visibilidad</span>
                    {% if not is_preview %}
                        <a href="{% url 'toggle_visibilidad' jid %}" class="vis-toggle {% if visible %}is-public{% else %}is-private{% endif %}">
                            {% if visible %}üåé P√öBLICA{% else %}üîí PRIVADA{% endif %}
                        </a>
                    {% else %}
                        <span class="vis-toggle {% if visible %}is-public{% else %}is-private{% endif %}">
                            {% if visible %}üåé P√öBLICA{% else %}üîí PRIVADA{% endif %}
                        </span>
                    {% endif %}
                </div>
            </div>

            
            
            <div style="margin: 20px 0; padding: 15px; background: #0f0f15; border: 1px solid #333; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong style="color:#d633ff; font-size:1.1em;">üìö Archivo Narrativo</strong>
                    <div style="font-size:0.8em; color:#aaa;">Lore, Historias, Eventos y Leyendas.</div>
                </div>
                <a href="{% url 'ver_narrativa_mundo' jid %}" class="btn" style="background:#d633ff; font-weight:bold; padding: 10px 20px;">ABRIR BIBLIOTECA ‚ûî</a>
            </div>
    
            <div class="section-title">Entidades Hijas</div>
            <div class="children-list">
                {% for h in hijos %}
                <a href="{% url 'ver_mundo' h.id %}" class="child-link">
                    <span><strong>{{ h.name }}</strong></span>
                    <span class="child-index">#{{ h.short }}</span>
                </a>
                {% empty %} <div style="color:#555; font-style:italic;">Sin hijos.</div> {% endfor %}
            </div>
            
            {% if not is_preview %}
            <form method="POST" class="child-form">
                {% csrf_token %}
                <div style="display:flex; gap:10px; width:100%; flex-direction:column;">
                    <input type="text" name="child_name" placeholder="Nuevo hijo..." style="width:100%; background:#000; border:1px solid #444; color:#fff; padding:5px;" required autocomplete="off">
                    
                    <div style="display:flex; gap:10px;">
                        <select name="child_type" style="background:#000; color:#fff; border:1px solid #444; padding:5px; border-radius:4px; flex-grow:1;">
                            <option value="LOCATION">üìç Lugar / Regi√≥n</option>
                            <option value="ENTITY">üêâ Criatura / NPC</option>
                        </select>
                        <button type="submit" style="width:auto; padding:5px 15px;">‚ûï</button>
                    </div>
                    
                    <label style="color:#aaa; font-size:0.8em; cursor:pointer; display:flex; align-items:center; gap:5px; margin-top:5px;">
                        <input type="checkbox" name="use_ai"> ‚ú® Generar con IA
                    </label>
                </div>
            </form>
            {% endif %}
            
            <div class="section-title">Historial</div>
            <ul style="padding-left:20px; font-size:0.8em; color:#aaa;">
                {% for h in historial %}
                
                <li style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <span>v{{ h.version_number }}: {{ h.proposed_name }}</span>
                    <a href="{% url 'restaurar_version' h.id %}" onclick="return confirm('¬øCrear una nueva propuesta basada en la v{{ h.version_number }}?')" style="font-size:0.7em; color:#e74c3c; text-decoration:none; border:1px solid #e74c3c; padding:2px 5px; border-radius:4px;">‚Ü∫ Restaurar</a>
                </li>
    
                {% endfor %}
            </ul>
        </div>
    </div>

    {% if not is_preview %}
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2 style="color:#fff; margin-top:0;">Proponer Cambio</h2>
            <form method="POST" action="{% url 'editar_mundo' jid %}" class="edit-form">
                {% csrf_token %}
                <label>Nombre:</label><input type="text" name="name" value="{{ name }}">
                
                <label>Descripci√≥n Conceptual:</label>
                <div style="margin-bottom:5px; padding:5px; background:#2c2c44; border-radius:4px; display:flex; align-items:center; justify-content:space-between;">
                    <span style="font-size:0.8em; color:#aaa;">¬øReescribir con IA?</span>
                    <label style="color:#d633ff; font-size:0.9em; cursor:pointer;">
                        <input type="checkbox" name="use_ai_edit"> ‚ú® S√ç
                    </label>
                </div>
                <textarea name="description" style="height:150px;">{{ description }}</textarea>
                
                <label style="color:#f1c40f;">Raz√≥n del cambio:</label><input type="text" name="reason" required>
                
                <div style="margin-top:20px; text-align:right;">
                    <a href="{% url 'ver_mundo' jid %}" class="btn" style="background:#555;">Cancelar</a>
                    <button type="submit" class="btn" style="background:#d633ff;">üöÄ Enviar Propuesta</button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
</body>
</html>