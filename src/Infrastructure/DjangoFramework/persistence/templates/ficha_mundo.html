{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECLAI v5.0 | {{ name }}</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#0a0a12',
                        card: '#161625',
                        accent: '#d633ff',
                        'accent-hover': '#b02ce0',
                    }
                }
            }
        }
    </script>
    <style>
        /* Scrollbar personalizada */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a12; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #d633ff; }
        /* Ocultar scrollbar en galer√≠a pero permitir scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-dark text-gray-200 font-sans p-4 lg:p-8 min-h-screen">

    {% if messages %}
    <div class="fixed top-5 right-5 z-50 w-80 space-y-2">
        {% for message in messages %}
        <div class="p-4 rounded-lg shadow-lg font-bold text-white {% if message.tags == 'success' %}bg-green-600{% else %}bg-red-600{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="flex justify-between items-center mb-6 bg-gray-900/80 p-4 rounded-xl border border-gray-800 backdrop-blur-md">
        <div class="text-xl font-bold tracking-widest text-white">
            ECLAI <span class="text-xs text-green-400 ml-2 bg-green-900/30 px-2 py-1 rounded border border-green-800">
                {% if user.is_authenticated %}üë§ {{ user.username|upper }}{% else %}üëª AN√ìNIMO{% endif %}
            </span>
        </div>
        <div class="flex gap-2">
            <button onclick="history.back()" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm border border-gray-700 transition">‚¨ÖÔ∏è Atr√°s</button>
            <a href="{% url 'home' %}" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm border border-gray-700 transition">üè† Inicio</a>
        </div>
    </div>

    <div class="bg-card border border-gray-800 rounded-2xl max-w-7xl mx-auto overflow-hidden shadow-2xl grid grid-cols-1 lg:grid-cols-4">
        
        <div class="col-span-1 lg:col-span-4 bg-gradient-to-r from-indigo-950 to-gray-900 p-6 border-b border-indigo-900 flex justify-between items-start">
            <div>
                <div class="flex items-center gap-2 text-xs text-gray-400 mb-2">
                    <a href="{% url 'home' %}" class="hover:text-accent">üè† Universo</a>
                    {% for b in breadcrumbs %}
                        <span>‚Ä∫</span>
                        <a href="{% url 'ver_mundo' b.id %}" class="{% if b.id == jid %}text-accent font-bold{% else %}hover:text-white{% endif %}">{{ b.label }}</a>
                    {% endfor %}
                </div>
                <h1 class="text-3xl lg:text-4xl font-bold text-white mb-2">{{ name }}</h1>
                <div class="text-xs font-mono text-gray-500 bg-black/30 px-2 py-1 rounded inline-block border border-gray-800">
                    J-ID: {{ jid }} <span class="text-gray-600 mx-2">|</span> CODE: <span class="text-accent">{{ public_id }}</span>
                </div>
            </div>
            {% if not is_preview %}
            <div>
                <a href="{% url 'borrar_mundo' jid %}" onclick="return confirm('¬øBorrar mundo?')" class="p-2 bg-red-900/20 hover:bg-red-600 text-red-400 hover:text-white rounded-lg transition border border-red-900/50" title="Borrar">üóëÔ∏è</a>
            </div>
            {% endif %}
        </div>

        <div class="col-span-1 lg:col-span-3 p-6 lg:p-8 border-r border-gray-800">
            
            <div class="flex justify-between items-end mb-4 border-b border-gray-800 pb-2">
                <h3 class="text-accent font-bold tracking-wider text-sm uppercase">Visual Database</h3>
                {% if not is_preview %}
                <div class="flex gap-2">
                    <button onclick="openAiModal()" class="px-3 py-1 bg-accent hover:bg-accent-hover text-white text-xs font-bold rounded transition shadow-lg shadow-purple-900/20">üé® IA GENERATOR</button>
                    <button onclick="document.getElementById('file-upload').click()" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold rounded transition">üìé SUBIR</button>
                    
                    <form id="form-manual-upload" method="POST" action="{% url 'subir_imagen_manual' public_id %}" enctype="multipart/form-data" class="hidden">
                        {% csrf_token %}
                        <input id="file-upload" type="file" name="imagen_manual" accept="image/*" onchange="openUploadModal(this)">
                        <input type="hidden" id="hidden-use-original" name="use_original_name">
                        <input type="hidden" id="hidden-custom-name" name="custom_name">
                    </form>
                </div>
                {% endif %}
            </div>

            <div class="flex gap-4 overflow-x-auto pb-4 mb-8 snap-x">
                {% for img in imagenes %}
                <div class="snap-start shrink-0 relative group w-40 h-56">
                    <div class="w-full h-full rounded-lg overflow-hidden border border-gray-700 cursor-pointer hover:border-accent transition shadow-lg bg-black" onclick="openLightbox('{% static '/persistence/img/'|add:img.url %}', '{{ img.filename }}')">
                        <img src="{% static 'persistence/img/'|add:img.url %}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500 opacity-90 group-hover:opacity-100">
                    </div>
                    {% if not is_preview %}
                    <a href="{% url 'borrar_foto' jid img.filename %}" class="absolute top-1 right-1 bg-red-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition hover:bg-red-500 shadow-lg" onclick="event.stopPropagation(); return confirm('¬øBorrar?')">‚úï</a>
                    {% endif %}
                </div>
                {% empty %}
                <div class="w-full py-12 border-2 border-dashed border-gray-800 rounded-lg text-center text-gray-600 text-sm bg-black/20">
                    üåë Sin registros visuales.
                </div>
                {% endfor %}
            </div>

            {% if metadata_obj %}
            <div class="mb-8">
                <h3 class="text-accent font-bold tracking-wider text-sm uppercase mb-3 border-b border-gray-800 pb-1">Datos Analizados</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    {% for key, value in metadata_obj.items %}
                        {% if key != 'gallery_log' and key != 'cover_image' and key != 'visuals' and key != 'biology' and key != 'stats' %}
                        <div class="bg-gray-950 border border-gray-800 p-3 rounded-lg">
                            <div class="text-xs text-gray-500 uppercase mb-1 font-bold">{{ key }}</div>
                            <div class="text-sm font-mono text-gray-300 truncate">
                                {% if value.append %}
                                    {% for item in value %}
                                        <span class="inline-block bg-black px-2 py-0.5 rounded border border-gray-700 text-xs mr-1">{{ item }}</span>
                                    {% endfor %}
                                {% else %}
                                    {{ value }}
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div>
                <h3 class="text-accent font-bold tracking-wider text-sm uppercase mb-3 border-b border-gray-800 pb-1">Lore</h3>
                <div class="bg-black/30 p-6 rounded-lg border-l-4 border-accent text-gray-300 leading-relaxed whitespace-pre-wrap font-serif text-lg">
                    {{ description|default:"Sin descripci√≥n disponible." }}
                </div>
            </div>
        </div>

        <div class="col-span-1 bg-gray-900/50 p-6 text-sm flex flex-col h-full border-l border-gray-800">
            
            <div class="space-y-3 mb-8">
                <a href="{% url 'mapa_arbol' public_id|default:jid %}" class="block w-full py-3 bg-slate-700 hover:bg-slate-600 text-white font-bold text-center rounded-lg border border-slate-600 shadow transition">
                    üó∫Ô∏è VER MAPA
                </a>
                <a href="{% url 'ver_narrativa_mundo' jid %}" class="block w-full py-3 bg-gray-800 hover:bg-gray-700 text-accent font-bold text-center rounded-lg border border-gray-700 transition">
                    üìö NARRATIVA
                </a>
            </div>

            <div class="mb-6 flex-grow">
                <h4 class="text-gray-500 uppercase text-xs font-bold mb-3">Sub-Niveles ({{ hijos|length }})</h4>
                <div class="space-y-2 max-h-[600px] overflow-y-auto pr-1 custom-scroll">
                    {% for h in hijos %}
                    <a href="{% url 'ver_mundo' h.id %}" class="flex justify-between items-center p-3 bg-gray-950 hover:bg-gray-800 rounded border border-gray-800 hover:border-accent transition group">
                        <span class="font-bold text-gray-300 group-hover:text-white">{{ h.name }}</span>
                        <span class="font-mono text-xs text-gray-600 group-hover:text-accent">#{{ h.short }}</span>
                    </a>
                    {% empty %}
                    <div class="text-center text-gray-600 italic py-4 bg-gray-950 rounded border border-dashed border-gray-800">Vac√≠o</div>
                    {% endfor %}
                </div>
            </div>

            {% if not is_preview %}
            <div class="bg-gray-950 p-4 rounded-lg border border-gray-800 mt-auto">
                <h4 class="text-gray-500 uppercase text-[10px] font-bold mb-2">Crear Nuevo</h4>
                <form method="POST">
                    {% csrf_token %}
                    <input type="text" name="child_name" placeholder="Nombre..." class="w-full bg-black border border-gray-700 rounded p-2 text-sm mb-2 focus:border-accent focus:outline-none text-white placeholder-gray-600">
                    <div class="flex gap-2">
                        <select name="child_type" class="bg-black border border-gray-700 rounded p-2 text-xs text-gray-300 flex-grow focus:border-accent focus:outline-none">
                            <option value="ENTITY">Criatura</option>
                            <option value="LOCATION">Lugar</option>
                        </select>
                        <button type="submit" class="bg-accent hover:bg-accent-hover text-white px-4 rounded font-bold text-lg leading-none flex items-center justify-center shadow-lg shadow-purple-900/30">+</button>
                    </div>
                    <label class="flex items-center gap-2 mt-2 cursor-pointer">
                        <input type="checkbox" name="use_ai" checked class="accent-accent w-3 h-3">
                        <span class="text-[10px] text-gray-400">Generar con IA</span>
                    </label>
                </form>
            </div>
            {% endif %}

        </div>
    </div>

    <div id="aiModal" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center backdrop-blur-sm">
        <div class="bg-card border border-accent/50 rounded-2xl p-8 max-w-md w-full text-center shadow-[0_0_50px_rgba(214,51,255,0.2)]">
            <h2 class="text-2xl font-bold text-white mb-1">Generador Neural</h2>
            <p class="text-xs text-gray-400 mb-6 uppercase tracking-widest">Stable Diffusion + Llama 3</p>
            
            <div id="ai-step-1">
                <p class="text-gray-300 mb-6 text-sm">La IA leer√° la descripci√≥n de este mundo y generar√° una visualizaci√≥n √∫nica.</p>
                <button onclick="generatePreview()" class="w-full py-3 bg-accent hover:bg-accent-hover text-white font-bold rounded-lg mb-3 transition">‚ú® GENERAR AHORA</button>
                <button onclick="closeAiModal()" class="text-gray-500 hover:text-white text-sm underline">Cancelar</button>
            </div>

            <div id="ai-step-loading" class="hidden py-8">
                <div class="text-4xl animate-bounce mb-4">üîÆ</div>
                <p class="text-accent font-bold animate-pulse">So√±ando p√≠xeles...</p>
            </div>

            <div id="ai-step-result" class="hidden">
                <img id="ai-preview-img" class="w-full rounded-lg border border-gray-700 mb-4 shadow-xl">
                <div class="text-left mb-4">
                    <label class="text-xs text-gray-500 uppercase font-bold">T√≠tulo</label>
                    <input type="text" id="ai-img-title" placeholder="Ej: Paisaje Desolado..." class="w-full bg-black border border-gray-700 rounded p-2 mt-1 text-white focus:border-accent focus:outline-none">
                </div>
                <div class="flex gap-3">
                    <button onclick="discardAiImage()" class="flex-1 py-2 bg-gray-800 hover:bg-red-900/50 text-gray-300 hover:text-red-200 rounded-lg border border-gray-700 transition">Descartar</button>
                    <button onclick="saveAiImage()" class="flex-1 py-2 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg shadow-lg shadow-green-900/50 transition">üíæ GUARDAR</button>
                </div>
            </div>
        </div>
    </div>

    <div id="uploadModal" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center backdrop-blur-sm">
        <div class="bg-card border border-gray-700 rounded-2xl p-8 max-w-md w-full text-center">
            <h2 class="text-xl font-bold text-white mb-4">Confirmar Subida</h2>
            <div id="file-info" class="text-xs font-mono text-accent mb-2"></div>
            <img id="preview-img" class="w-full h-48 object-contain bg-black rounded border border-gray-800 mb-4 hidden">
            
            <div class="bg-gray-950 p-4 rounded-lg border border-gray-800 text-left mb-4">
                <label class="flex items-center gap-2 mb-3 cursor-pointer group">
                    <input type="checkbox" id="chk-original-name" onchange="toggleCustomName()" class="accent-accent w-4 h-4">
                    <span class="text-sm text-gray-300 group-hover:text-white transition">Usar nombre original</span>
                </label>
                <input type="text" id="inp-custom-name" placeholder="O escribe un nombre..." class="w-full bg-black border border-gray-700 rounded p-2 text-sm text-white focus:border-accent focus:outline-none transition">
            </div>

            <div id="scan-status" class="text-xs font-bold mb-4 tracking-widest h-4"></div>

            <div class="flex gap-3 justify-center">
                <button onclick="closeUploadModal()" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded text-gray-300">Cancelar</button>
                <button id="btn-confirm-upload" onclick="confirmUpload()" class="px-6 py-2 bg-green-600 hover:bg-green-500 text-white font-bold rounded shadow-lg hidden">üöÄ SUBIR</button>
            </div>
        </div>
    </div>

    <div id="lightbox" class="fixed inset-0 bg-black/95 z-50 hidden items-center justify-center p-4 lg:p-10" onclick="if(event.target === this) closeLightbox()">
        <div class="max-w-5xl w-full bg-gray-900 rounded-xl overflow-hidden border border-gray-800 flex flex-col lg:flex-row shadow-2xl h-[90vh] lg:h-auto">
            <div class="flex-1 bg-black flex items-center justify-center relative p-4">
                <img id="lb-img" class="max-w-full max-h-[80vh] object-contain shadow-2xl">
            </div>
            <div class="w-full lg:w-80 bg-gray-950 p-6 border-l border-gray-800 flex flex-col">
                <div class="mb-6 border-b border-gray-800 pb-4">
                    <div class="text-[10px] text-accent font-bold tracking-widest uppercase mb-1">Ficha de Imagen</div>
                    <div class="flex items-start justify-between gap-2 mb-2 group">
                        <h2 id="lb-title" class="text-xl font-bold text-white leading-tight break-words">Sin T√≠tulo</h2>
                        <button onclick="editImageTitle()" class="text-gray-600 hover:text-white transition p-1" title="Renombrar">‚úèÔ∏è</button>
                    </div>
                    <div class="text-xs text-gray-400 space-y-1">
                        <div class="flex justify-between"><span>Por:</span> <span id="lb-uploader" class="text-green-400 font-bold">-</span></div>
                        <div class="flex justify-between"><span>Fecha:</span> <span id="lb-date">-</span></div>
                    </div>
                </div>
                
                <div class="bg-black p-3 rounded border border-gray-800 text-[10px] font-mono text-gray-600 mb-auto">
                    <div class="flex justify-between"><span>ORIGEN:</span> <span id="lb-meta" class="text-yellow-600">-</span></div>
                    <div class="flex justify-between mt-1 break-all"><span>REF:</span> <span id="lb-name">-</span></div>
                </div>

                <div class="space-y-2 mt-4">
                    <button onclick="setAsCover()" class="w-full py-3 bg-yellow-700/50 hover:bg-yellow-600 text-yellow-100 font-bold rounded transition border border-yellow-900">‚≠ê PORTADA</button>
                    <button onclick="closeLightbox()" class="w-full py-3 bg-gray-800 hover:bg-gray-700 text-white rounded transition border border-gray-700">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const metadataRaw = '{{ metadata|default:"{}"|escapejs }}';
        let allMetadata = {};
        try { allMetadata = JSON.parse(metadataRaw); } catch(e) { console.error(e); }
        const galleryLog = allMetadata.gallery_log || {};
        let currentBase64 = null;
        let nsfwModel = null;

        // INIT
        window.addEventListener('load', async () => {
            try { if(typeof nsfwjs !== 'undefined') nsfwModel = await nsfwjs.load(); } catch(e){}
        });

        // IA LOGIC
        function openAiModal() {
            document.getElementById('aiModal').classList.remove('hidden');
            document.getElementById('aiModal').classList.add('flex');
            document.getElementById('ai-step-1').classList.remove('hidden');
            document.getElementById('ai-step-loading').classList.add('hidden');
            document.getElementById('ai-step-result').classList.add('hidden');
            document.getElementById('ai-img-title').value = "";
        }
        function closeAiModal() {
            document.getElementById('aiModal').classList.add('hidden');
            document.getElementById('aiModal').classList.remove('flex');
        }
        
        function generatePreview() {
            document.getElementById('ai-step-1').classList.add('hidden');
            document.getElementById('ai-step-loading').classList.remove('hidden');
            fetch("{% url 'api_preview_foto' jid %}")
                .then(r => r.json())
                .then(data => {
                    document.getElementById('ai-step-loading').classList.add('hidden');
                    if(data.status === 'ok') {
                        currentBase64 = data.image;
                        document.getElementById('ai-preview-img').src = "data:image/webp;base64," + data.image;
                        document.getElementById('ai-step-result').classList.remove('hidden');
                    } else alert("Error IA: " + data.message);
                }).catch(e => { alert("Error conexi√≥n"); closeAiModal(); });
        }
        
        function saveAiImage() {
            const t = document.getElementById('ai-img-title').value || "Generado por IA";
            if(!currentBase64) return;
            fetch("{% url 'api_save_foto' jid %}", {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
                body: JSON.stringify({ image: currentBase64, title: t })
            }).then(r => r.json()).then(d => {
                if(d.status === 'ok') location.reload();
                else alert("Error: " + d.message);
            });
        }
        function discardAiImage() { if(confirm("¬øDescartar?")) openAiModal(); }

        // UPLOAD LOGIC
        function openUploadModal(input) {
            if(!input.files[0]) return;
            const f = input.files[0];
            const modal = document.getElementById('uploadModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            document.getElementById('preview-img').src = URL.createObjectURL(f);
            document.getElementById('preview-img').classList.remove('hidden');
            document.getElementById('file-info').innerText = f.name;
            
            // Reset
            document.getElementById('chk-original-name').checked = false;
            document.getElementById('inp-custom-name').value = f.name.split('.')[0];
            toggleCustomName();
            
            // Scan fake
            const st = document.getElementById('scan-status');
            const btn = document.getElementById('btn-confirm-upload');
            st.innerText = "‚è≥ ANALIZANDO..."; st.style.color = "#aaa"; btn.classList.add('hidden');
            setTimeout(() => { st.innerText = "‚úÖ SEGURO"; st.style.color = "#4ade80"; btn.classList.remove('hidden'); }, 800);
        }
        
        function closeUploadModal() { 
            const modal = document.getElementById('uploadModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('file-upload').value=""; 
        }
        
        function toggleCustomName() {
            const chk = document.getElementById('chk-original-name');
            const inp = document.getElementById('inp-custom-name');
            inp.disabled = chk.checked;
            inp.style.opacity = chk.checked ? 0.5 : 1;
        }
        
        function confirmUpload() {
            document.getElementById('hidden-use-original').value = document.getElementById('chk-original-name').checked ? 'true' : 'false';
            document.getElementById('hidden-custom-name').value = document.getElementById('inp-custom-name').value;
            document.getElementById('form-manual-upload').submit();
        }

        // LIGHTBOX LOGIC
        function openLightbox(url, fn) {
            const lb = document.getElementById('lightbox');
            lb.classList.remove('hidden');
            lb.classList.add('flex');
            document.getElementById('lb-img').src = url;
            document.getElementById('lb-name').innerText = fn;
            
            const d = galleryLog[fn] || {};
            document.getElementById('lb-title').innerText = d.title || fn;
            document.getElementById('lb-uploader').innerText = d.uploader || "-";
            document.getElementById('lb-date').innerText = d.date || "-";
            document.getElementById('lb-title').dataset.filename = fn;
        }
        
        function closeLightbox() { 
            const lb = document.getElementById('lightbox');
            lb.classList.add('hidden');
            lb.classList.remove('flex');
        }
        
        function editImageTitle() {
            const el = document.getElementById('lb-title');
            const fn = el.dataset.filename;
            const nt = prompt("Nuevo t√≠tulo:", el.innerText);
            if(nt) {
                fetch("{% url 'api_update_image_metadata' jid %}", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
                    body: JSON.stringify({ filename: fn, title: nt })
                })
                .then(r => r.json())
                .then(d => {
                    if(d.status === 'ok') {
                        el.innerText = nt;
                        if(!galleryLog[fn]) galleryLog[fn] = {};
                        galleryLog[fn].title = nt;
                    } else alert(d.message);
                });
            }
        }
        
        function setAsCover() {
            const filename = document.getElementById('lb-name').innerText;
            if(filename !== "-") window.location.href = "{% url 'set_cover_image' jid '123456' %}".replace('123456', encodeURIComponent(filename));
        }
    </script>
</body>
</html>