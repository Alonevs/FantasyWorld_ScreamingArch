{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ECLAI v4.8 | {{ name }}</title>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

    <style>
        body { background-color: #0a0a12; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; padding: 20px 40px; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a12; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #d633ff; }

        /* CABECERA */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid #333; padding-bottom: 15px; background: #0e0e16; padding: 15px 20px; border-radius: 10px; }
        .logo { font-size: 1.5em; font-weight: bold; color: #fff; letter-spacing: 2px; }
        .nav-group { display: flex; gap: 10px; }
        .nav-btn { background: #333; color: #fff; padding: 8px 15px; border-radius: 5px; text-decoration: none; font-size: 0.9em; border: 1px solid #444; cursor: pointer; }
        .nav-btn:hover { background: #555; }
        .nav-btn.special { background: #d633ff; border-color: #d633ff; }
        .nav-btn.special:hover { background: #a569bd; }
        
        /* TARJETA PRINCIPAL */
        .card { background: #161625; border: 1px solid #2a2a40; border-radius: 15px; max-width: 1200px; margin: 0 auto; overflow: hidden; display: grid; grid-template-columns: 3fr 1fr; }
        .card-header { grid-column: 1 / -1; background: linear-gradient(90deg, #2b1a45 0%, #1a1a2e 100%); padding: 20px; border-bottom: 2px solid #4a3b69; display: flex; justify-content: space-between; align-items: flex-start; }
        
        .main-content { padding: 30px; border-right: 1px solid #2a2a40; min-width: 0; }
        .sidebar { padding: 30px; background: #13131f; font-size: 0.9em; min-width: 250px; }
        
        /* BREADCRUMBS & STATUS */
        .breadcrumbs { margin-bottom: 10px; font-size: 0.85em; color: #888; display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }
        .crumb-item { background: #333; padding: 2px 8px; border-radius: 10px; text-decoration: none; color: #ccc; border: 1px solid #444; transition:0.2s; }
        .crumb-item:hover { background: #d633ff; color: #fff; border-color: #d633ff; }
        .crumb-separator { color: #666; }
        .crumb-active { color: #fff; font-weight: bold; border-color: #d633ff; background: rgba(214, 51, 255, 0.1); }

        .status-badge { padding: 4px 12px; border-radius: 4px; font-weight: bold; font-size: 0.8em; letter-spacing: 1px; text-transform: uppercase; display: inline-block; }
        .st-live { background: #2ecc71; color: #000; border: 1px solid #27ae60; }
        .st-draft { background: #f39c12; color: #000; border: 1px solid #d35400; }

        /* BOTONES GEN√âRICOS */
        .actions { display: flex; gap: 10px; }
        .btn { padding: 5px 10px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.8em; text-decoration: none; color:#fff; border:none; display:inline-block; }
        .btn-edit { background: #3498db; } .btn-del { background: #e74c3c; }
        
        /* GALER√çA */
        .gallery { display: flex; gap: 15px; overflow-x: auto; white-space: nowrap; padding-bottom: 15px; margin-bottom: 20px; scrollbar-width: thin; scrollbar-color: #d633ff #0e0e16; }
        .gallery-item { position: relative; display: inline-block; flex: 0 0 auto; width: 160px; height: 220px; }
        .img-wrapper { position: relative; width: 100%; height: 100%; overflow: hidden; border-radius: 8px; border: 2px solid #333; cursor: pointer; }
        .img-wrapper img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
        .gallery-item:hover .img-wrapper img { transform: scale(1.05); }
        .gallery-item:hover .img-wrapper { border-color: #d633ff; }

        /* INSPECTOR DE METADATOS (OVERLAY) */
        .meta-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(0, 0, 0, 0.85); color: #fff;
            padding: 5px 0; text-align: center;
            opacity: 0; transition: 0.2s; pointer-events: none;
            display: flex; flex-direction: column; z-index: 5;
        }
        .gallery-item:hover .meta-overlay { opacity: 1; }
        .res { color: #d633ff; font-weight: bold; font-family: monospace; font-size: 0.8em; }
        .fmt { color: #aaa; font-size: 0.7em; }

        .btn-delete-img { position: absolute; top: 5px; right: 5px; background: rgba(231, 76, 60, 0.9); color: white; width: 24px; height: 24px; border-radius: 50%; text-align: center; line-height: 24px; font-size: 12px; text-decoration: none; cursor: pointer; opacity: 0; transition: 0.2s; z-index: 10; }
        .gallery-item:hover .btn-delete-img { opacity: 1; }

        /* SECCIONES */
        .section-title { color: #a0a0ff; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px; margin-top: 25px; font-size: 1.1em; display: flex; justify-content: space-between; align-items: center; }
        .lore-box { background: #111; padding: 20px; border-left: 4px solid #d633ff; font-style: italic; color: #ccc; white-space: pre-wrap; margin-bottom: 10px; max-height: 300px; overflow-y: auto; }
        
        /* SIDEBAR */
        .children-list { display: grid; gap: 5px; }
        .child-link { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #1f1f33; text-decoration: none; color: #eee; border-radius: 6px; border: 1px solid #333; transition:0.2s; }
        .child-link:hover { border-color: #d633ff; transform: translateX(5px); }
        .child-index { font-family: 'Courier New', monospace; color: #d633ff; background: #000; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; }
        
        .vis-toggle { text-decoration: none; font-weight: bold; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; transition:0.3s; border:1px solid transparent; cursor:pointer; display:inline-block; }
        .vis-public { background: rgba(46, 204, 113, 0.1); color: #2ecc71; border-color: #2ecc71; }
        .vis-private { background: rgba(231, 76, 60, 0.1); color: #e74c3c; border-color: #e74c3c; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-row { display:flex; justify-content:space-between; border-bottom:1px solid #333; padding:5px 0; font-size:0.9em; }
        .label { color: #888; text-transform: uppercase; font-size:0.8em; }
        .value { font-family: 'Courier New', monospace; color: #fff; font-weight: bold; text-align:right; }

        /* TARJETAS METADATA */
        .data-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 10px; }
        .data-card { background: #13131e; border: 1px solid #333; border-radius: 6px; overflow: hidden; }
        .data-card-header { background: #1f1f33; padding: 8px 12px; border-bottom: 1px solid #333; font-weight: bold; color: #d633ff; text-transform: uppercase; font-size: 0.85em; letter-spacing: 1px; }
        .data-card-body { padding: 10px; }
        .data-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #2a2a40; padding: 6px 0; font-size: 0.9em; }
        .data-row:last-child { border-bottom: none; }
        .data-key { color: #888; text-transform: capitalize; }
        .data-val { color: #eee; font-weight: bold; text-align: right; }
        .data-list-item { background: #000; padding: 2px 8px; border-radius: 4px; border: 1px solid #444; font-size: 0.8em; display: inline-block; margin-top: 2px; }

        /* MODALES */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; justify-content: center; align-items: center; }
        .modal:target { display: flex; }
        .modal-content { background: #161625; padding: 30px; border-radius: 10px; width: 600px; border: 1px solid #d633ff; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .edit-form input, .edit-form textarea { width: 100%; background: #0a0a12; border: 1px solid #444; color: #fff; padding: 10px; margin-top: 5px; margin-bottom:15px; box-sizing:border-box; }
        
        .child-form { background: #1f1f33; padding: 15px; border-radius: 8px; margin-top: 20px; display: flex; gap: 10px; }
        .child-form input { background: #0a0a12; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 4px; flex-grow: 1; }
        .child-form button { background: #d633ff; color: #fff; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; }
        .child-form select { background: #000; color: #fff; border: 1px solid #444; padding: 8px; border-radius: 4px; }

        .messages-container { position: fixed; top: 20px; right: 20px; z-index: 9999; width: 300px; }
        .alert { padding: 15px; margin-bottom: 10px; border-radius: 5px; color: #fff; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: opacity 0.5s; }
        .alert-success { background: rgba(39, 174, 96, 0.9); border: 1px solid #2ecc71; }
        .alert-error { background: rgba(192, 57, 43, 0.9); border: 1px solid #e74c3c; }
    </style>
</head>
<body>
    {% if messages %}
    <div class="messages-container">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    </div>
    <script>
        setTimeout(function() {
            document.querySelectorAll('.alert').forEach(a => { a.style.opacity = '0'; setTimeout(() => a.remove(), 500); });
        }, 5000);
    </script>
    {% endif %}

    <div class="top-bar">
        <div class="logo">ECLAI v4.8 // SYSTEM</div>
        <div class="nav-group">
            <button class="nav-btn" onclick="history.back()">‚¨ÖÔ∏è Atr√°s</button>
            <a href="{% url 'home' %}" class="nav-btn">üè† Inicio</a>
            <a href="{% url 'centro_control' %}" class="nav-btn special">üéõÔ∏è Gesti√≥n</a>
        </div>
    </div>

    {% if is_preview %}
    <div style="background:#f39c12; color:#fff; padding:15px; text-align:center; margin-bottom:20px; border-radius:8px; margin: 0 auto 20px auto; max-width: 1000px;">
        <h2>‚ö†Ô∏è MODO INSPECCI√ìN: VERSI√ìN {{ version_live }}</h2>
        <p>Autor: <strong>{{ author }}</strong> | Raz√≥n: <em>{{ change_log }}</em></p>
        <div style="margin-top:10px;">
            <a href="{% url 'aprobar_version' version_id %}" class="btn" style="background:#27ae60;">‚úÖ APROBAR</a>
            <a href="{% url 'rechazar_version' version_id %}}" class="btn" style="background:#c0392b;">‚ùå RECHAZAR</a>
            <a href="{% url 'centro_control' %}" class="btn" style="background:#7f8c8d;">Cancelar</a>
        </div>
    </div>
    {% endif %}

    <div class="card">
        <div class="card-header">
            <div>
                <div class="breadcrumbs">
                    <a href="{% url 'home' %}" class="crumb-item">üè† Universo</a>
                    {% for b in breadcrumbs %}
                        <span class="crumb-separator">‚Ä∫</span>
                        <a href="{% url 'ver_mundo' b.id %}" class="crumb-item {% if b.id == jid %}crumb-active{% endif %}">{{ b.label }}</a>
                    {% endfor %}
                </div>
                
                <h1 style="margin:10px 0 5px 0;">{{ name }}</h1>
                
                <div style="margin-top:5px;">
                    {% if status == 'LIVE' %}
                        <span class="status-badge st-live">üü¢ LIVE v{{ version_live }}</span>
                    {% else %}
                        <span class="status-badge st-draft">‚ö†Ô∏è {{ status|default:"DRAFT" }}</span>
                    {% endif %}
                </div>
            </div>
            
            {% if not is_preview %}
            <div class="actions">
                <a href="#editModal" class="btn btn-edit">‚úèÔ∏è Editar</a>
                <a href="{% url 'borrar_mundo' jid %}" class="btn btn-del" onclick="return confirm('¬øSeguro? Se borrar√°n hijos tambi√©n.')">üóëÔ∏è Borrar</a>
            </div>
            {% endif %}
        </div>

        <div class="main-content">
            {% if propuestas %}
            <div style="background:rgba(241, 196, 15, 0.1); border:1px solid #f1c40f; padding:15px; border-radius:8px; margin-bottom:20px;">
                <strong style="color:#f1c40f;">‚ö†Ô∏è Hay {{ propuestas|length }} revisi√≥n(es) pendiente(s)</strong>
                <div style="margin-top:5px; font-size:0.9em;">
                    <a href="{% url 'centro_control' %}" style="color:#d633ff;">Ir al Centro de Control</a> para aprobar.
                </div>
            </div>
            {% endif %}

            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <div class="section-title" style="margin:0;">Visual Database</div>
                {% if not is_preview %}
                <div style="display:flex; align-items:center;">
                    <a href="{% url 'generar_foto_extra' jid %}" class="btn" style="background:#9b59b6; font-size:0.7em;">üé® + FOTO IA</a>
                    <form id="form-manual-upload" method="POST" action="{% url 'subir_imagen_manual' jid %}" enctype="multipart/form-data" style="display:inline; margin-left:5px;">
                        {% csrf_token %}
                        <label for="file-upload" class="btn" style="background:#555; font-size:0.7em; cursor:pointer;" title="Subir archivo propio">üìé SUBIR</label>
                        <input id="file-upload" type="file" name="imagen_manual" accept="image/*" style="display:none;" onchange="openUploadModal(this)">
                    </form>
                </div>
                {% endif %}
            </div>

            <div class="gallery">
                {% for img in imagenes %} 
                <div class="gallery-item">
                    <div class="img-wrapper">
                        <img src="{% static 'persistence/img/'|add:img.url %}" onclick="openLightbox(this.src, '{{ img.filename }}')" onload="loadMeta(this)">
                        <div class="meta-overlay">
                            <span class="res">...</span>
                            <span class="fmt">WEBP</span>
                        </div>
                    </div>
                    {% if not is_preview %}
                    <a href="{% url 'borrar_foto' jid img.filename %}" class="btn-delete-img" onclick="return confirm('¬øBorrar imagen?')">‚úï</a>
                    {% endif %}
                </div>
                {% empty %} 
                <div style="color:#555; padding:20px; border:1px dashed #444; width:100%; text-align:center; font-size:0.8em;">No hay datos visuales.</div> 
                {% endfor %}
            </div>

            {% if metadata_obj and metadata_obj.fisica or metadata_obj.clima or metadata_obj.biology %}
            <div class="section-title">Datos Analizados (Metadata)</div>
            <div class="data-grid">
                {% for key, value in metadata_obj.items %}
                    {% if key != 'tipo_entidad' and key != 'biology' and key != 'stats' and key != 'visuals' and key != 'gallery_log' and key != 'cover_image' %}
                    <div class="data-card">
                        <div class="data-card-header">{{ key }}</div>
                        <div class="data-card-body">
                            {% if key == 'fisica' or key == 'clima' or key == 'leyes_fundamentales' or key == 'geo_config' or key == 'climate_profile' %}
                                {% for subkey, subval in value.items %}
                                <div class="data-row"><span class="data-key">{{ subkey }}:</span><span class="data-val">{% if subval.append %}{% for item in subval %}<span class="data-list-item">{{ item }}</span> {% endfor %}{% else %}{{ subval }}{% endif %}</span></div>
                                {% endfor %}
                            {% else %}
                                <div style="color:#ccc; font-style:italic;">{{ value }}</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
                
                {% if metadata_obj.biology %}
                <div class="data-card" style="border-color:#2ecc71;">
                    <div class="data-card-header" style="color:#2ecc71;">BIO-SCAN</div>
                    <div class="data-card-body">
                        <div class="data-row"><span class="data-key">Clase:</span><span class="data-val">{{ metadata_obj.biology.taxonomy }}</span></div>
                        <div class="data-row"><span class="data-key">Peligro:</span><span class="data-val" style="color:#e74c3c;">{{ metadata_obj.stats.danger_level }}/10</span></div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <div class="section-title">Descripci√≥n Conceptual</div>
            <div class="lore-box">{{ description|default:"Sin descripci√≥n definida." }}</div>
        </div>

        <div class="sidebar">
            <div class="section-title" style="margin-top:0;">Ficha T√©cnica</div>
            <div class="stats-grid">
                <div class="stat-row"><span class="label">J-ID</span><span class="value">{{ jid }}</span></div>
                <div class="stat-row"><span class="label">CODE</span><span class="value" style="color:#d633ff">{{ code_entity }}</span></div>
                <div class="stat-row"><span class="label">Actualizado</span><span class="value" style="font-size:0.9em;">{{ updated_at|date:"d/m/Y" }}</span></div>
                <div class="stat-row" style="align-items:center;">
                    <span class="label">Visibilidad</span>
                    {% if not is_preview %}
                        <a href="{% url 'toggle_visibilidad' jid %}" class="vis-toggle {% if visible %}is-public{% else %}is-private{% endif %}">{% if visible %}üåé P√öBLICA{% else %}üîí PRIVADA{% endif %}</a>
                    {% else %}
                        <span class="vis-toggle">{% if visible %}üåé P√öBLICA{% else %}üîí PRIVADA{% endif %}</span>
                    {% endif %}
                </div>
            </div>

            <div style="margin: 20px 0; padding: 15px; background: #0f0f15; border: 1px solid #333; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                <div><strong style="color:#d633ff; font-size:1.1em;">üìö Archivo Narrativo</strong></div>
                <a href="{% url 'ver_narrativa_mundo' jid %}" class="btn" style="background:#d633ff; font-weight:bold; padding: 10px 20px;">ABRIR BIBLIOTECA ‚ûî</a>
            </div>

            {% if jid|length == 12 %}
            <div style="margin: 20px 0; padding: 15px; background: rgba(41, 128, 185, 0.1); border: 1px dashed #3498db; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                <div><strong style="color:#3498db;">ü™ê Estructura</strong></div>
                <a href="{% url 'init_hemisferios' jid %}" class="btn" style="background:#2980b9;">üåç DIVIDIR</a>
            </div>
            {% endif %}

            <div class="section-title">Entidades Hijas</div>
            <div class="children-list">
                {% for h in hijos %}
                <a href="{% url 'ver_mundo' h.id %}" class="child-link">
                    <span><strong>{{ h.name }}</strong></span>
                    <span class="child-index">#{{ h.short }}</span>
                </a>
                {% empty %} <div style="color:#555; font-style:italic;">Sin hijos.</div> {% endfor %}
            </div>
            
            {% if not is_preview %}
            <form method="POST" class="child-form">
                {% csrf_token %}
                <div style="display:flex; gap:10px; width:100%; flex-direction:column;">
                    <input type="text" name="child_name" placeholder="Nuevo hijo..." style="width:100%; background:#000; border:1px solid #444; color:#fff; padding:5px;" autocomplete="off">
                    <div style="display:flex; gap:10px;">
                        <select name="child_type" style="background:#000; color:#fff; border:1px solid #444; padding:5px; border-radius:4px; flex-grow:1;">
                            <option value="ENTITY">üêâ Criatura / Fauna</option>
                            <option value="LOCATION">üìç Lugar / Regi√≥n</option>
                        </select>
                        <button type="submit" style="width:auto; padding:5px 15px;">‚ûï</button>
                    </div>
                    <label style="color:#aaa; font-size:0.8em; cursor:pointer; display:flex; align-items:center; gap:5px; margin-top:5px;">
                        <input type="checkbox" name="use_ai" checked> ‚ú® Generar con IA
                    </label>
                </div>
            </form>
            {% endif %}
            
            <div class="section-title">Historial</div>
            <ul style="padding-left:20px; font-size:0.8em; color:#aaa;">
                {% for h in historial %}
                <li style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <span>v{{ h.version_number }}: {{ h.proposed_name }}</span>
                    <a href="{% url 'restaurar_version' h.id %}" onclick="return confirm('¬øRestaurar?')" style="font-size:0.7em; color:#e74c3c; text-decoration:none; border:1px solid #e74c3c; padding:2px 5px; border-radius:4px;">‚Ü∫ Restaurar</a>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <div id="uploadModal" class="modal">
        <div class="modal-content" style="width: 500px; text-align: center;">
            <div class="modal-header"><h2>Revisar Imagen</h2><a href="#" onclick="closeUploadModal()" class="close-btn">‚úï</a></div>
            <div style="margin: 20px 0; background: #000; padding: 10px; border-radius: 8px; border: 1px dashed #444; min-height: 200px; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                <div id="scan-status" style="margin-bottom:10px; font-family:monospace;">‚è≥ PREPARANDO...</div>
                <img id="preview-img" src="" style="max-width: 100%; max-height: 350px; border-radius: 4px; display:none;">
                <div id="file-info" style="margin-top: 10px; color: #888; font-family: monospace; font-size: 0.8em;"></div>
            </div>
            <div style="display:flex; justify-content: space-between; gap: 10px;">
                <button onclick="closeUploadModal()" class="btn" style="background: #e74c3c; flex-grow:1;">‚ùå CANCELAR</button>
                <button id="btn-confirm-upload" onclick="confirmUpload()" class="btn" style="background: #2ecc71; flex-grow:1; display:none;">‚úÖ SUBIR AHORA</button>
            </div>
        </div>
    </div>

    <div id="lightbox" class="modal" onclick="if(event.target === this) closeLightbox()">
        <div class="modal-content" style="width: 800px; max-width:95%; display:flex; gap:20px; text-align:left;">
            <div style="flex:2;">
                <img id="lb-img" src="" style="width:100%; border-radius:4px; border:1px solid #444;">
            </div>
            <div style="flex:1; background:#0a0a0f; padding:15px; border-radius:4px;">
                <h3 style="margin-top:0; color:#d633ff;">Ficha de Imagen</h3>
                <div style="font-size:0.9em; line-height:1.6;">
                    <div style="color:#888;">Archivo:</div>
                    <div id="lb-name" style="color:#fff; word-break:break-all; margin-bottom:10px;">-</div>
                    <div style="color:#888;">Subido por:</div>
                    <div id="lb-uploader" style="color:#2ecc71; font-weight:bold; margin-bottom:10px;">-</div>
                    <div style="color:#888;">Fecha:</div>
                    <div id="lb-date" style="color:#ccc; margin-bottom:10px;">-</div>
                    <div style="color:#888;">Metadatos:</div>
                    <div id="lb-meta" style="color:#f1c40f; font-size:0.8em; margin-bottom:10px;">-</div>
                </div>
                <button onclick="setAsCover()" class="btn" style="background:#f1c40f; width:100%; margin-top:10px; color:#000; font-weight:bold; border:none; cursor:pointer;">‚≠ê ESTABLECER PORTADA</button>
                <button onclick="closeLightbox()" class="btn" style="background:#555; width:100%; margin-top:10px;">CERRAR</button>
            </div>
        </div>
    </div>

    {% if not is_preview %}
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2>Proponer Cambio</h2>
            <form method="POST" action="{% url 'editar_mundo' jid %}" class="edit-form">
                {% csrf_token %}
                <label>Nombre:</label><input type="text" name="name" value="{{ name }}">
                <label>Descripci√≥n Conceptual:</label>
                <textarea name="description" style="height:150px;">{{ description }}</textarea>
                <label style="color:#f1c40f;">Raz√≥n del cambio:</label><input type="text" name="reason" required>
                <div style="margin-top:20px; text-align:right;">
                    <a href="{% url 'ver_mundo' jid %}" class="btn" style="background:#555;">Cancelar</a>
                    <button type="submit" class="btn" style="background:#d633ff;">üöÄ Enviar Propuesta</button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    
    <script>
        // --- GESTOR DE SUBIDA: MODO ROBUSTO (A prueba de AdBlock) ---
        const galleryLog = {{ metadata_obj.gallery_log|default:"{}"|safe }};
        let nsfwModel = null;

        // Intentamos cargar la IA, pero si falla, no lloramos
        window.addEventListener('load', async () => {
            try {
                if (typeof nsfwjs !== 'undefined') {
                    nsfwModel = await nsfwjs.load();
                    console.log("üõ°Ô∏è IA de Seguridad: ACTIVA");
                } else {
                    console.warn("‚ö†Ô∏è IA de Seguridad: BLOQUEADA (Modo Manual activo)");
                }
            } catch (e) {
                console.warn("‚ö†Ô∏è Error cargando IA:", e);
            }
        });

        function openUploadModal(input) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            
            // UI Elements
            const modal = document.getElementById('uploadModal');
            const imgPreview = document.getElementById('preview-img');
            const statusDiv = document.getElementById('scan-status');
            const btnConfirm = document.getElementById('btn-confirm-upload');
            const fileInfo = document.getElementById('file-info');
            
            // Reset UI
            modal.style.display = 'flex';
            imgPreview.style.display = 'none';
            // IMPORTANTE: El bot√≥n empieza oculto pero tenemos un temporizador de seguridad
            btnConfirm.style.display = 'none'; 
            statusDiv.innerHTML = '‚è≥ PREPARANDO...';
            statusDiv.style.color = '#fff';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                imgPreview.src = e.target.result;
                imgPreview.style.display = 'block';
                fileInfo.innerText = file.name + " (" + (file.size/1024).toFixed(1) + " KB)";
                
                // Lanzamos el an√°lisis
                runRobustScan(imgPreview, file, statusDiv, btnConfirm);
            };
            reader.readAsDataURL(file);
        }

        async function runRobustScan(imgElement, file, statusDiv, btnConfirm) {
            let warnings = [];
            let blocked = false;

            // 1. CHEQUEO METADATOS (EXIF) - Suele funcionar siempre
            try {
                if (typeof EXIF !== 'undefined') {
                    statusDiv.innerHTML = 'üîç LEYENDO METADATOS...';
                    await new Promise(r => EXIF.getData(file, r));
                    const tags = JSON.stringify(EXIF.getAllTags(file)).toLowerCase();
                    if (tags.includes('copyright') || tags.includes('getty')) {
                        warnings.push("‚ö†Ô∏è Copyright detectado en metadatos");
                    }
                }
            } catch (e) {
                console.log("Skip EXIF:", e);
            }

            // 2. CHEQUEO IA (NSFW) - Aqu√≠ es donde fallaba
            if (nsfwModel) {
                try {
                    statusDiv.innerHTML = 'ü§ñ LA IA EST√Å MIRANDO...';
                    const predictions = await nsfwModel.classify(imgElement);
                    const porn = predictions.find(p => p.className === 'Porn');
                    
                    if (porn && porn.probability > 0.6) {
                        statusDiv.innerHTML = '‚õî BLOQUEADO: CONTENIDO OBSCENO';
                        statusDiv.style.color = '#e74c3c';
                        blocked = true;
                    }
                } catch (e) {
                    warnings.push("‚ö†Ô∏è Fallo en an√°lisis IA");
                }
            } else {
                warnings.push("‚ÑπÔ∏è Escaneo IA omitido (Librer√≠a no cargada)");
            }

            // 3. RESULTADO FINAL
            if (!blocked) {
                if (warnings.length > 0) {
                    statusDiv.innerHTML = "‚úÖ LISTO (" + warnings[0] + ")";
                    statusDiv.style.color = "#f1c40f"; // Amarillo advertencia
                } else {
                    statusDiv.innerHTML = "‚úÖ VERIFICADO Y SEGURO";
                    statusDiv.style.color = "#2ecc71"; // Verde puro
                }
                // ¬°SIEMPRE MOSTRAMOS EL BOT√ìN SI NO EST√Å BLOQUEADO EXPL√çCITAMENTE!
                btnConfirm.style.display = 'inline-block';
            }
        }

        // --- RED DE SEGURIDAD (TIMEOUT) ---
        // Si por lo que sea el script se cuelga, a los 2 segundos mostramos el bot√≥n igual
        // para que el usuario no se quede atrapado.
        setInterval(() => {
            const modal = document.getElementById('uploadModal');
            const btn = document.getElementById('btn-confirm-upload');
            const status = document.getElementById('scan-status');
            
            if (modal && modal.style.display === 'flex' && btn.style.display === 'none') {
                // Si lleva mucho rato as√≠...
                if (status.innerText.includes('...')) {
                     console.log("Rescate activado: Forzando bot√≥n de subida.");
                     status.innerText = "‚ö†Ô∏è Tiempo agotado. Subida manual habilitada.";
                     status.style.color = "#aaa";
                     btn.style.display = 'inline-block';
                }
            }
        }, 3000); // 3 segundos de gracia

        function closeUploadModal() {
            document.getElementById('uploadModal').style.display = 'none';
            document.getElementById('file-upload').value = "";
        }
        function confirmUpload() { document.getElementById('form-manual-upload').submit(); }

        // Funciones de Galer√≠a (Se mantienen igual)
        function openLightbox(imgUrl, filename) {
            document.getElementById('lightbox').style.display = 'flex';
            document.getElementById('lb-img').src = imgUrl;
            document.getElementById('lb-name').innerText = filename;
            
            const data = galleryLog[filename];
            if (data) {
                document.getElementById('lb-uploader').innerText = data.uploader;
                document.getElementById('lb-date').innerText = data.date;
                document.getElementById('lb-meta').innerText = data.origin || "Manual";
            } else {
                document.getElementById('lb-uploader').innerText = "Sistema / Desconocido";
                document.getElementById('lb-date').innerText = "-";
                document.getElementById('lb-meta').innerText = "Sin registro auditor√≠a";
            }
        }
        function closeLightbox() { document.getElementById('lightbox').style.display = 'none'; }
        
        function setAsCover() {
            const filename = document.getElementById('lb-name').innerText;
            if (!filename || filename === "-") return;
            const baseUrl = "{% url 'set_cover_image' jid '123456' %}";
            window.location.href = baseUrl.replace('123456', encodeURIComponent(filename));
        }

        function loadMeta(imgElement) {
             if (imgElement.naturalWidth) {
                const wrapper = imgElement.parentElement;
                const res = wrapper.querySelector('.res');
                if (res) res.innerText = imgElement.naturalWidth + 'x' + imgElement.naturalHeight + 'px';
            }
        }
    </script>

</body>
</html>