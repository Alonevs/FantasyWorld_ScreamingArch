{% extends "layouts/base.html" %}
{% load static %}
{% load metadata_tags %}

{% block title %}ECLAI v5.0 | {{ name }}{% endblock %}

{% block extra_head %}
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
{% endblock %}

{% block content %}
    <!-- HEADER NAV -->
    <div class="flex justify-between items-center mb-6 bg-gray-900/80 p-4 rounded-xl border border-gray-800 backdrop-blur-md mx-4 mt-4 max-w-[1600px] xl:mx-auto">
        <div class="text-xl font-bold tracking-widest text-white flex items-center gap-3">
            ECLAI 
            <span class="text-xs text-gray-300 bg-gray-900/50 px-3 py-1.5 rounded-full border border-gray-700 flex items-center gap-3 shadow-inner">
                {% if user.is_authenticated %}
                    {% if user.is_superuser %}
                        <span class="text-[10px] bg-yellow-500/20 text-yellow-400 border border-yellow-500/50 px-1.5 py-0.5 rounded font-bold tracking-wider shadow-[0_0_10px_rgba(234,179,8,0.2)]">
                            ğŸ‘‘ ADMIN
                        </span>
                    {% else %}
                        <span class="text-[10px] bg-blue-500/20 text-blue-400 border border-blue-500/50 px-1.5 py-0.5 rounded font-bold tracking-wider">
                            EXPLORER
                        </span>
                    {% endif %}
                    
                    <span class="font-bold tracking-wide">{{ user.username|upper }}</span>
                    
                    <form action="{% url 'logout' %}" method="post" class="inline flex items-center border-l border-gray-600 pl-2">
                        {% csrf_token %}
                        <button type="submit" class="text-red-400 hover:text-red-300 transition hover:scale-110" title="Cerrar SesiÃ³n">â»</button>
                    </form>
                {% else %}
                    <a href="{% url 'login' %}" class="hover:text-white transition flex items-center gap-2">
                        <span class="text-gray-500">ğŸ‘»</span> ANÃ“NIMO <span class="text-[10px] bg-accent/20 text-accent px-1 rounded border border-accent/30">LOGIN</span>
                    </a>
                {% endif %}
            </span>
        </div>
        <div class="flex gap-2">
            <button onclick="history.back()" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm border border-gray-700 transition">â¬…ï¸ AtrÃ¡s</button>
            <a href="{% url 'home' %}" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm border border-gray-700 transition">ğŸ  Inicio</a>
        </div>
    </div>

    <!-- MAIN GRID -->
    <div class="bg-card border border-gray-800 rounded-2xl max-w-[1600px] mx-4 xl:mx-auto overflow-hidden shadow-2xl grid grid-cols-1 lg:grid-cols-4 mb-10">
        
        <!-- HEADER SECTION -->
        <div class="col-span-1 lg:col-span-4 bg-gradient-to-r from-indigo-950 to-gray-900 p-6 border-b border-indigo-900 flex flex-col md:flex-row justify-between items-start gap-4">
            <div>
                <div class="flex items-center flex-wrap gap-2 text-xs text-gray-400 mb-4">
                    <a href="{% url 'home' %}" class="px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded-full text-gray-300 transition border border-gray-700 hover:border-accent">ğŸ </a>
                    {% for b in breadcrumbs %}
                        {% if b.id %}
                        <a href="{% url 'ver_mundo' b.id %}" class="px-3 py-1 rounded-full border transition whitespace-nowrap {% if b.id == jid %}bg-accent/20 border-accent text-accent font-bold{% else %}bg-gray-800 border-gray-700 text-gray-300 hover:bg-gray-700 hover:border-gray-500{% endif %}">
                            {{ b.label }}
                        </a>
                        <!-- Arrow only if not last -->
                        {% else %}
                        <span class="text-gray-600 font-bold">...</span>
                        {% endif %}
                    {% endfor %}
                </div>

                <div class="flex items-center gap-3 mb-2">
                    <h1 class="text-3xl lg:text-4xl font-bold text-white">{{ name }}</h1>
                    
                    {% if user.is_authenticated %}
                        <a href="{% url 'toggle_visibilidad' jid %}" class="text-xs px-2 py-1 rounded border transition {% if visible %}bg-green-900/30 border-green-700 text-green-400{% else %}bg-red-900/30 border-red-700 text-red-400{% endif %}">
                            {% if visible %}ğŸŒ PÃšBLICO{% else %}ğŸ‘» PRIVADO{% endif %}
                        </a>
                        
                        {% if user.is_superuser %}
                        <a href="{% url 'toggle_lock' jid %}" class="text-xs px-2 py-1 rounded border border-gray-600 bg-gray-800 text-gray-400 hover:bg-gray-700">
                            {% if is_locked %}ğŸ”“ Desbloquear{% else %}ğŸ”’ Bloquear{% endif %}
                        </a>
                        <!-- Also allow admin to toggle visibility directly here if needed, or keep it separate -->
                        {% endif %}
                    {% endif %}

                    {% if is_locked %}<span title="Bloqueado" class="text-red-500 text-xl">ğŸ”’</span>{% endif %}
                </div>

                {% if user.is_superuser %}
                <div class="text-xs font-mono text-gray-500 bg-black/30 px-2 py-1 rounded inline-block border border-gray-800">
                    <span class="text-accent font-bold uppercase mr-2">{{ hierarchy_label }}</span>
                    J-ID: {{ jid }} <span class="text-gray-600 mx-2">|</span> CODE: <span class="text-accent">{{ public_id }}</span>
                </div>
                {% endif %}
            </div>
            
            {% if not is_preview %}
            {% if user.is_superuser %}
            <div class="flex gap-2">
                <a href="{% url 'dashboard' %}" class="p-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg transition shadow-md flex items-center gap-2" title="Panel de Control">
                    ğŸš€ <span class="hidden sm:inline text-xs font-bold">DASHBOARD</span>
                </a>
                <button onclick="openEditModal()" class="p-2 bg-blue-900/20 hover:bg-blue-600 text-blue-400 hover:text-white rounded-lg transition border border-blue-900/50" title="Editar">
                    âœï¸
                </button>
                <a href="{% url 'borrar_mundo' jid %}" onclick="return confirm('Â¿Borrar mundo?')" class="p-2 bg-red-900/20 hover:bg-red-600 text-red-400 hover:text-white rounded-lg transition border border-red-900/50" title="Borrar">
                    ğŸ—‘ï¸
                </a>
            </div>
            {% endif %}
            {% endif %}
        </div>

        <!-- CONTENT AREA (Left Column) -->
        <div class="col-span-1 lg:col-span-3 p-6 lg:p-8 border-r border-gray-800">
            
            <!-- CHILD ENTITIES LIST (Single Collapsible) -->
            {% if hijos %}
            <details class="group mb-8" open>
                <summary class="flex justify-between items-center bg-[#1a1a2e] p-4 rounded-t-lg cursor-pointer border border-gray-800 hover:border-gray-600 transition list-none sticky top-0 z-10">
                    <h3 class="text-accent font-bold tracking-wider text-sm uppercase flex items-center gap-2">
                        ğŸŒŒ COSMOLOGÃA & ESTRUCTURA ({{ hijos|length }})
                    </h3>
                    <span class="text-gray-500 transform group-open:rotate-180 transition duration-300">â–¼</span>
                </summary>
                <div class="p-4 border-l border-r border-b border-gray-800 rounded-b-lg bg-black/20 grid grid-cols-1 md:grid-cols-2 gap-4 animate-wave">
                    {% for h in hijos %}
                        {% include "components/_entity_card.html" with entity=h variant="horizontal" %}
                    {% endfor %}
                </div>
            </details>
            {% endif %}

            <!-- VISUAL DATABASE HEADER -->
            <div class="flex justify-between items-end mb-4 border-b border-gray-800 pb-2">
                <h3 class="text-accent font-bold tracking-wider text-sm uppercase">Visual Database</h3>
                {% if not is_preview %}
                {% if user.is_superuser %}
                <div class="flex gap-2">
                    <button onclick="openAiModal()" class="px-3 py-1 bg-accent hover:bg-accent-hover text-white text-xs font-bold rounded transition shadow-lg shadow-purple-900/20">ğŸ¨ IA GENERATOR</button>
                    <button onclick="document.getElementById('file-upload').click()" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold rounded transition">ğŸ“ SUBIR</button>
                    
                    <form id="form-manual-upload" method="POST" action="{% url 'subir_imagen_manual' public_id %}" enctype="multipart/form-data" class="hidden">
                        {% csrf_token %}
                        <input id="file-upload" type="file" name="imagen_manual" accept="image/*" multiple onchange="openUploadModal(this)">
                        <input type="hidden" id="hidden-use-original" name="use_original_name">
                        <input type="hidden" id="hidden-custom-name" name="custom_name">
                    </form>
                </div>
                {% endif %}
                {% endif %}
            </div>

            <!-- GALLERY STRIP -->
            <div class="flex gap-4 overflow-x-auto pb-4 mb-8 snap-x min-h-[140px]">
                {% for img in imagenes %}
                <div class="snap-start shrink-0 relative group w-40 h-56">
                    <div class="w-full h-full rounded-lg overflow-hidden border border-gray-700 cursor-pointer hover:border-accent transition shadow-lg bg-black relative" onclick="openLightbox('{% static '/persistence/img/' %}{{ img.url }}', '{{ img.filename|escapejs }}')">
                        <img src="{% static 'persistence/img/' %}{{ img.url }}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500 opacity-90 group-hover:opacity-100">
                        
                        <!-- Metadata Overlay -->
                        <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black via-black/80 to-transparent p-2 text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
                            <div class="font-bold text-white truncate">{{ img.author|default:"?" }}</div>
                            <div class="text-gray-400 text-[10px]">{{ img.date|default:"-" }}</div>
                        </div>
                    </div>
                    {% if user.is_superuser %}
                    <a href="{% url 'borrar_foto' jid img.filename %}" class="absolute top-1 right-1 bg-red-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition hover:bg-red-500 shadow-lg" onclick="event.stopPropagation(); return confirm('Â¿Borrar?')">âœ•</a>
                    {% endif %}
                </div>
                {% empty %}
                <div class="w-full flex flex-col items-center justify-center text-gray-500 py-4 border border-dashed border-gray-800 rounded-lg min-w-[200px]">
                    <span class="text-2xl mb-2">ğŸ–¼ï¸</span>
                    <p class="text-xs">No hay imÃ¡genes visualizadas.</p>
                </div>
                {% endfor %} 
            </div>

            <!-- DESCRIPTION -->
            <div class="prose prose-invert max-w-none mt-8">
                <h3 class="text-white font-bold mb-2">DescripciÃ³n</h3>
                <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-800 text-gray-300 leading-relaxed whitespace-pre-wrap">{{ description|default:"Sin descripciÃ³n disponible." }}</div>
            </div>
        </div>
        
        <!-- SIDEBAR (Right Column) -->
        <div class="col-span-1 p-6 lg:p-8 bg-gray-900/30">
            <h3 class="text-gray-500 text-xs font-bold uppercase mb-4">InformaciÃ³n</h3>
            <div class="space-y-3 text-sm text-gray-400">
                <div class="flex justify-between border-b border-gray-800 pb-2"><span>Creado:</span> <span class="text-white">{{ created_at|date:"d/m/Y" }}</span></div>
                <div class="flex justify-between border-b border-gray-800 pb-2"><span>VersiÃ³n:</span> <span class="text-green-400 font-mono">LIVE (v{{ version_live }})</span></div>
                <div class="flex justify-between border-b border-gray-800 pb-2"><span>Autor:</span> <span class="text-accent">{{ author_live|default:user.username }}</span></div>
            </div>

            <div class="mt-8 space-y-2">
                <h3 class="text-gray-500 text-xs font-bold uppercase mb-4">Acciones</h3>
                <a href="{% url 'ver_narrativa_mundo' jid %}" class="block w-full px-4 py-2 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded flex items-center gap-2 transition border border-gray-700 text-sm">
                    ğŸ“– Narrativa
                </a>
                
                <a href="{% url 'mapa_arbol' public_id %}" class="block w-full px-4 py-2 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded flex items-center gap-2 transition border border-gray-700 text-sm">
                    ğŸŒ³ Mapa Ãrbol
                </a>
                
                <div class="mt-8 pt-4 border-t border-gray-800">
                    {% if user.is_superuser %}
                    <button onclick="openCreateModal()" class="w-full py-3 bg-gradient-to-r from-accent to-purple-600 hover:from-accent-hover hover:to-purple-500 text-white font-bold rounded-lg shadow-lg shadow-purple-900/30 transition transform hover:scale-[1.02] flex items-center justify-center gap-2">
                        âœ¨ GENERAR ENTORNO
                    </button>
                    {% endif %}

                    <!-- Metadata Viewer (HUD) -->
                    {% include 'partials/_metadata_viewer.html' %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block modals %}
    {% include "partials/_world_modals.html" %}
    {% include "partials/_world_scripts.html" %}
{% endblock %}