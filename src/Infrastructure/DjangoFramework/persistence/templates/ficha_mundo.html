{% extends "layouts/base.html" %}
{% load static %}
{% load metadata_tags %}

{% block title %}ECLAI v5.0 | {{ name }}{% endblock %}

{% block extra_head %}
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
{% endblock %}

{% block content %}
    <div class="mt-8"></div>



    <!-- MAIN GRID -->
    <!-- MAIN GRID -->
    <div class="bg-card border {% if is_period_view %}border-indigo-500/70 shadow-[0_0_40px_-10px_rgba(79,70,229,0.3)]{% else %}border-gray-800{% endif %} rounded-2xl max-w-[1600px] mx-4 xl:mx-auto overflow-hidden shadow-2xl grid grid-cols-1 lg:grid-cols-4 mb-10 transition-all duration-500">
        
        <!-- HEADER SECTION -->
        <div class="col-span-1 lg:col-span-4 bg-linear-to-r from-indigo-950 to-gray-900 p-6 border-b border-indigo-900 flex flex-col md:flex-row justify-between items-start gap-4 relative">
            <div>
                <div class="flex items-center flex-wrap gap-2 text-xs text-gray-400 mb-4">
                    <a href="{% url 'home' %}" class="px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded-full text-gray-300 transition border border-gray-700 hover:border-accent">üè†</a>
                    {% for b in breadcrumbs %}
                        {% if b.id %}
                        <a href="{% url 'ver_mundo' b.id %}" class="px-3 py-1 rounded-full border transition whitespace-nowrap {% if b.id == jid %}bg-accent/20 border-accent text-accent font-bold{% else %}bg-gray-800 border-gray-700 text-gray-300 hover:bg-gray-700 hover:border-gray-500{% endif %}">
                            {{ b.label }}
                        </a>
                        <!-- Arrow only if not last -->
                        {% else %}
                        <span class="text-gray-600 font-bold">...</span>
                        {% endif %}
                    {% endfor %}
                </div>

                <div class="flex items-center gap-3 mb-2">
                    <h1 class="text-3xl lg:text-4xl font-bold text-white flex items-center gap-3">
                        {{ name }}
                        {% if is_period_view %}
                        <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-green-500/20 border border-green-500/50 text-green-300 text-xs font-bold uppercase tracking-wider shadow-lg shadow-green-900/40 backdrop-blur-sm animate-pulse">
                            üìÖ {{ viewing_period.title }}
                        </span>
                        {% endif %}
                    </h1>
                    
                    {% if user.is_authenticated %}
                        <!-- New Status Toggle (Consistent with Card) -->
                        <div class="inline-block">
                            {% if user.is_superuser or user == author_live_user %}
                            <form action="{% url 'toggle_status' public_id %}" method="POST" class="inline-block">
                                {% csrf_token %}
                                <!-- No need for next, view handles referer -->
                                <button type="submit"  
                                    class="text-xs px-2 py-1 rounded border transition font-bold uppercase
                                    {% if status_str == 'LIVE' %}bg-green-900/30 border-green-700 text-green-400 hover:bg-green-900/50
                                    {% else %}bg-red-900/30 border-red-700 text-red-400 hover:bg-red-900/50{% endif %}">
                                    {% if status_str == 'LIVE' %}üåê LIVE{% else %}‚õî OFFLINE{% endif %}
                                </button>
                            </form>
                            {% else %}
                                <!-- Read Only Badge for non-authors -->
                                <span class="text-xs px-2 py-1 rounded border 
                                    {% if status_str == 'LIVE' %}bg-green-900/30 border-green-700 text-green-400
                                    {% else %}bg-red-900/30 border-red-700 text-red-400{% endif %}">
                                    {% if status_str == 'LIVE' %}üåê LIVE{% else %}‚õî OFFLINE{% endif %}
                                </span>
                            {% endif %}
                        </div>

                        <!-- Lock Icon: Clickable for Author/Superuser, Static for others -->
                        {% if user.is_superuser or user == author_live_user %}
                            <a href="{% url 'toggle_lock' public_id %}" class="text-xs px-2 py-1 rounded border border-gray-600 bg-gray-800 text-gray-400 hover:bg-gray-700" title="{% if is_locked %}Desbloquear edici√≥n{% else %}Bloquear edici√≥n para otros usuarios{% endif %}">
                                {% if is_locked %}üîí{% else %}üîì{% endif %}
                            </a>
                        {% elif is_locked %}
                             <!-- Static Lock Status for others -->
                            <span class="text-xs px-2 py-1 rounded border border-gray-600 bg-gray-900 text-red-500 cursor-help" title="Mundo Bloqueado por el Autor">
                                üîí
                            </span>
                        {% endif %}
                    {% endif %}
                </div>

                {% if user.is_superuser %}
                <div class="text-xs font-mono text-gray-500 bg-black/30 px-2 py-1 rounded inline-block border border-gray-800">
                    <span class="text-accent font-bold uppercase mr-2">{{ hierarchy_label }}</span>
                    J-ID: {{ jid }} <span class="text-gray-600 mx-2">|</span> CODE: <span class="text-accent">{{ public_id }}</span>
                </div>
                {% endif %}
            </div>
            
            {% if not is_preview %}
            {% if can_edit %}
            <div class="flex flex-col items-end gap-2">
                <div class="flex gap-2">
                    <a href="{% url 'dashboard' %}" class="p-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg transition shadow-md flex items-center gap-2" title="Panel de Control">
                        üöÄ <span class="hidden sm:inline text-xs font-bold">DASHBOARD</span>
                    </a>
                    
                    {% if is_locked and not is_admin_role and not user.is_superuser %}
                        <!-- LOCKED: Edit Disabled -->
                        <button disabled class="p-2 bg-gray-800 text-gray-600 cursor-not-allowed rounded-lg border border-gray-700 opacity-50" title="Bloqueado por Administraci√≥n">
                            üîí EDITAR BLOQUEADO
                        </button>
                        <button disabled class="p-2 bg-gray-800 text-gray-600 cursor-not-allowed rounded-lg border border-gray-700 opacity-50" title="Bloqueado">
                            üóëÔ∏è
                        </button>
                    {% else %}
                        {% if is_period_view %}
                            <button onclick="openEditPeriodModal()" class="p-1 px-2 bg-indigo-900/20 hover:bg-indigo-600 text-indigo-400 hover:text-white rounded-lg transition border border-indigo-900/50 text-[10px]" title="Editar Per√≠odo: {{ viewing_period.title }}">
                                ‚úèÔ∏è <span class="hidden sm:inline font-bold">EDITAR PER√çODO</span>
                            </button>
                            <form action="{% url 'delete_period' viewing_period.id %}" method="POST" class="inline">
                                {% csrf_token %}
                                <button type="submit" 
                                        data-confirm="¬øEst√°s seguro de solicitar el borrado de este per√≠odo hist√≥rico?"
                                        class="p-1 px-2 bg-red-900/20 hover:bg-red-600 text-red-400 hover:text-white rounded-lg transition border border-red-900/50 flex items-center justify-center text-[10px]" 
                                        title="Borrar Per√≠odo">
                                    üóëÔ∏è
                                </button>
                            </form>
                        {% else %}
                            <button onclick="openEditModal()" class="p-1 px-2 bg-blue-900/20 hover:bg-blue-600 text-blue-400 hover:text-white rounded-lg transition border border-blue-900/50 text-[10px]" title="Editar Mundo">
                                ‚úèÔ∏è <span class="hidden sm:inline font-bold">EDITAR ACTUAL</span>
                            </button>
                            {% if user.is_superuser or is_author or is_admin_role %}
                            <a href="{% url 'borrar_mundo' jid %}" 
                               data-confirm="¬øEst√°s seguro de solicitar el borrado de este mundo? Se enviar√° al Dashboard." 
                               data-title="Solicitar Borrado" 
                               data-destructive="true"
                               class="p-1 px-2 bg-red-900/20 hover:bg-red-600 text-red-400 hover:text-white rounded-lg transition border border-red-900/50 flex items-center justify-center text-[10px]" 
                               title="Borrar Mundo de forma Segura">
                                üóëÔ∏è
                            </a>
                            {% endif %}
                        {% endif %}
                    {% endif %}
                </div>

                {% if is_retouch_mode %}
                    <div class="bg-purple-900/90 text-purple-100 flex items-center gap-2 px-4 py-2 rounded-xl border text-sm font-bold shadow-lg transition-all duration-300 active:scale-95 text-center backdrop-blur w-auto animate-pulse border-accent">
                         <span class="font-bold">‚úèÔ∏è MODO RETOQUE</span>
                    </div>
                {% endif %}
                {% if timeline_periods %}
                <!-- PERIOD SELECTOR (Cards Style) -->
                <div class="flex flex-wrap justify-end gap-2 mt-2 w-full md:w-auto">
                    <!-- Current/Present Button -->
                    <a href="{% url 'ver_mundo' public_id %}" 
                       class="group relative w-16 p-2 rounded-lg border-2 transition-all duration-300 text-center {% if not is_period_view %}bg-green-600 border-green-500 shadow-lg shadow-green-900/50{% else %}bg-gray-800 border-gray-700 hover:border-green-500 hover:bg-gray-700{% endif %}">
                        <div class="text-lg mb-0.5">‚≠ê</div>
                        <div class="text-[9px] font-bold uppercase tracking-wider leading-none {% if not is_period_view %}text-white{% else %}text-gray-400 group-hover:text-green-400{% endif %}">
                            ACTUAL
                        </div>
                    </a>
                    
                    <!-- Historical Periods -->
                    {% for period in timeline_periods %}
                    <a href="?period={{ period.slug }}" 
                       class="group relative w-16 p-2 rounded-lg border-2 transition-all duration-300 text-center {% if is_period_view and viewing_period.slug == period.slug %}bg-indigo-600 border-indigo-500 shadow-lg shadow-indigo-900/50{% else %}bg-gray-800 border-gray-700 hover:border-indigo-500 hover:bg-gray-700{% endif %}">
                        <div class="text-lg mb-0.5">üìú</div>
                        <div class="text-[9px] font-bold uppercase tracking-wider leading-none truncate {% if is_period_view and viewing_period.slug == period.slug %}text-white{% else %}text-gray-400 group-hover:text-indigo-400{% endif %}">
                            {{ period.title }}
                        </div>
                    </a>
                    {% endfor %}
                    
                    <!-- New Period Button -->
                    {% if can_edit %}
                    <button onclick="openCreatePeriodModal()" 
                            class="group relative w-16 p-2 rounded-lg border-2 border-dashed border-gray-600 hover:border-purple-500 transition-all duration-300 text-center bg-gray-900/50 hover:bg-purple-900/20">
                        <div class="text-lg mb-0.5">‚ûï</div>
                        <div class="text-[9px] font-bold text-gray-400 group-hover:text-purple-400 uppercase tracking-wider leading-none">
                            NUEVO
                        </div>
                    </button>
                    {% endif %}
                </div>
                {% endif %}

            </div>
            {% endif %}
            {% endif %}
        </div>

        <!-- CONTENT AREA (Left Column) -->
        <div class="col-span-1 lg:col-span-3 p-6 lg:p-8 border-r border-gray-800">
            
            <!-- CHILD ENTITIES LIST (Single Collapsible) -->
            <!-- CHILDREN LIST -->
            {% if hijos %}
            <details class="group mb-8" open>
                <summary class="flex justify-between items-center bg-[#1a1a2e] p-4 rounded-t-lg cursor-pointer border border-gray-800 hover:border-gray-600 transition list-none sticky top-0 z-10">
                    <h3 class="text-accent font-bold tracking-wider text-sm uppercase flex items-center gap-2">
                        üåå {{ children_label|default:"ENTIDADES HIJAS" }} ({{ hijos|length }})
                    </h3>
                    <span class="text-gray-500 transform group-open:rotate-180 transition duration-300">‚ñº</span>
                </summary>
                <div class="p-4 border-l border-r border-b border-gray-800 rounded-b-lg bg-black/20 grid grid-cols-1 md:grid-cols-2 gap-4 animate-wave">
                    {% for h in hijos %}
                        {% include "components/_entity_card.html" with entity=h variant="horizontal" %}
                    {% endfor %}
                </div>
            </details>
            {% endif %}


            <!-- VISUAL DATABASE HEADER -->
            <div class="flex justify-between items-end mb-4 border-b border-gray-800 pb-2">
                <h3 class="text-accent font-bold tracking-wider text-sm uppercase">Visual Database</h3>
                {% if not is_preview %}
                {% if user.is_superuser or is_admin_role or is_author or allow_proposals %}
                <div class="flex gap-2">
                    {% if user.is_superuser or is_author or is_admin_role %}
                    <button onclick="toggleSelectionMode()" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold rounded transition border border-gray-600 shadow" id="btn-manage-photos" title="Borrar varias fotos">
                        ‚öôÔ∏è GESTIONAR
                    </button>
                    {% endif %}
                    {# Updated: AI Access for Superuser, Author, Admins, AND Authorized SubAdmins (Collaborators) #}
                    {% if user.is_superuser or is_author or is_admin_role or is_subadmin %} <!-- is_subadmin calc in view covers Minion logic -->
                    <button onclick="openAiModal()" class="px-3 py-1 bg-accent hover:bg-accent-hover text-white text-xs font-bold rounded transition shadow-lg shadow-purple-900/20">üé® IA GENERATOR</button>
                    {% endif %}
                    
                    <button onclick="document.getElementById('file-upload').click()" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold rounded transition flex items-center gap-1">
                        üìé <span class="hidden sm:inline">SUBIR</span>
                    </button>
                    
                    <form id="form-manual-upload" method="POST" action="{% url 'subir_imagen_manual' public_id %}" enctype="multipart/form-data" class="hidden">
                        {% csrf_token %}
                        <input id="file-upload" type="file" name="imagen_manual" accept="image/*" multiple onchange="openUploadModal(this)">
                        <input type="hidden" id="hidden-use-original" name="use_original_name">
                        <input type="hidden" id="hidden-custom-name" name="custom_name">
                        <input type="hidden" name="period" value="{{ current_period_slug }}">
                    </form>
                </div>
                {% endif %}
                {% endif %}
            </div>

            <!-- GALLERY STRIP -->
            <div class="flex gap-4 overflow-x-auto pb-4 mb-8 snap-x min-h-[140px]">
                {% for img in imagenes %}
                <div class="snap-start shrink-0 relative group w-40 h-56 img-item transition-all duration-300">
                    <!-- Checkbox Overlay -->
                    <div class="absolute top-2 left-2 z-30 hidden selection-checkbox transform scale-125">
                        <input type="checkbox" class="w-5 h-5 accent-red-600 cursor-pointer shadow-lg" onchange="toggleImageSelection('{{ img.filename|escapejs }}', this)">
                    </div>

                    <div class="w-full h-full rounded-lg overflow-hidden border border-gray-700 cursor-pointer hover:border-accent transition shadow-lg bg-black relative" 
                         data-url="{% static "persistence/img/" %}{{ img.url }}" 
                         data-filename="{{ img.filename|escapejs }}"
                         onclick="if(!selectionMode) openLightbox(this.dataset.url, this.dataset.filename)">
                        
                        {% if img.is_cover %}
                        <!-- Cover Badge -->
                        <div class="absolute top-2 left-2 z-20 px-2 py-0.5 bg-accent text-[10px] font-black text-white rounded shadow-lg border border-white/20 uppercase tracking-tighter">
                            Portada
                        </div>
                        {% endif %}

                        <img src="{% static 'persistence/img/' %}{{ img.url }}" alt="{{ img.filename }}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500 opacity-90 group-hover:opacity-100">
                        
                        <!-- Metadata Overlay -->
                        <div class="absolute inset-x-0 bottom-0 bg-linear-to-t from-black via-black/80 to-transparent p-2 text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
                            <div class="font-bold text-white truncate">{{ img.author|default:"?" }}</div>
                            <div class="text-gray-400 text-[10px]">{{ img.date|default:"-" }}</div>
                        </div>
                    </div>
                    {% if user_role >= 20 or is_author or allow_proposals %}
                    <button data-jid="{{ jid }}" data-filename="{{ img.filename|escapejs }}"
                            onclick="event.stopPropagation(); solicitarBorradoIndividual(this.dataset.jid, this.dataset.filename);" 
                            class="absolute top-1 right-1 bg-red-600/80 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition hover:bg-red-500 shadow-lg backdrop-blur z-20 batch-hide">‚úï</button>
                    {% endif %}
                </div>
                {% empty %}
                <div class="w-full flex flex-col items-center justify-center text-gray-500 py-4 border border-dashed border-gray-800 rounded-lg min-w-[200px]">
                    <span class="text-2xl mb-2">üñºÔ∏è</span>
                    <p class="text-xs">No hay im√°genes visualizadas.</p>
                </div>
                {% endfor %} 
            </div>
            
            <!-- PERIOD SELECTOR (New Timeline System) -->

            <!-- DESCRIPTION -->
            <div class="prose prose-invert max-w-none mt-8">
                <h3 class="text-white font-bold mb-2">Descripci√≥n</h3>
                <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-800 text-gray-300 leading-relaxed whitespace-pre-wrap">{{ description|default:"Sin descripci√≥n disponible." }}</div>
            </div>
        </div>
        
        <!-- SIDEBAR (Right Column) -->
        <div class="col-span-1 p-6 lg:p-8 bg-gray-900/30">
            <h3 class="text-gray-500 text-xs font-bold uppercase mb-4">Informaci√≥n</h3>
            <div class="space-y-3 text-sm text-gray-400">
                <div class="flex justify-between border-b border-gray-800 pb-2"><span>Creado:</span> <span class="text-white">{{ created_at|date:"d/m/Y" }}</span></div>
                <div class="flex justify-between border-b border-gray-800 pb-2"><span>Versi√≥n:</span> <span class="text-green-400 font-mono">LIVE (v{{ version_live }})</span></div>
                <div class="flex justify-between border-b border-gray-800 pb-2"><span>Autor:</span> <span class="text-accent">{{ author_live|default:"Alone" }}</span></div>
            </div>

            <div class="mt-8 space-y-2">
                <h3 class="text-gray-500 text-xs font-bold uppercase mb-4">Acciones</h3>
                <a href="{% url 'ver_narrativa_mundo' public_id %}?period={{ current_period_slug }}" class="w-full px-4 py-2 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded flex items-center gap-2 transition border border-gray-700 text-sm">
                    üìñ Narrativa
                </a>
                
                <a href="{% url 'mapa_arbol' public_id %}" class="w-full px-4 py-2 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded flex items-center gap-2 transition border border-gray-700 text-sm">
                    üå≥ Mapa √Årbol
                </a>
                
                {% if user.is_authenticated %}
                <button onclick="openTimelineModal()" class="w-full px-4 py-2 bg-indigo-900/30 hover:bg-indigo-600 text-indigo-300 hover:text-white rounded flex items-center gap-2 transition border border-indigo-900/50 text-sm font-bold">
                    üìÖ Snapshot Temporal
                </button>
                {% endif %}
                
                <div class="mt-8 pt-4 border-t border-gray-800">
                    {% if user_role >= 20 or user.is_superuser %}
                    <button onclick="openCreateModal()" class="w-full py-3 bg-linear-to-r from-accent to-purple-600 hover:from-accent-hover hover:to-purple-500 text-white font-bold rounded-lg shadow-lg shadow-purple-900/30 transition transform hover:scale-[1.02] flex items-center justify-center gap-2">
                        ‚ú® GENERAR ENTORNO
                    </button>
                    {% endif %}

                    <!-- Metadata Viewer (HUD) -->
                    {% include 'partials/_metadata_viewer.html' %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block modals %}
    {% include "partials/_world_modals.html" %}
    {% include "partials/_world_scripts.html" %}
    
    {% if edit_mode %}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Auto Open Edit Modal
            setTimeout(() => { if(typeof openEditModal === 'function') openEditModal(); }, 300);
            
            // If Retouch Mode, lock navigation
            const isRetouchMode = Boolean(parseInt("{{ is_retouch_mode|yesno:'1,0' }}"));
            if (isRetouchMode) {
                // Disable links in children grid and Images
                const grid = document.querySelector('.animate-wave');
                const gallery = document.querySelector('.snap-x');
                
                if(grid) { grid.style.pointerEvents = 'none'; grid.style.opacity = '0.5'; }
                if(gallery) { gallery.style.pointerEvents = 'none'; gallery.style.opacity = '0.5'; }
                
                // Disable Generator Button
                const genBtn = document.querySelector("button[onclick='openCreateModal()']");
                if(genBtn) {
                    genBtn.disabled = true;
                    genBtn.onclick = null;
                    genBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }
        });
    </script>
    {% endif %}

    <!-- BATCH DELETE UI -->
    <div id="batchDeleteModal" class="hidden fixed inset-0 z-50 items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-gray-900 border border-gray-700 rounded-xl p-6 w-full max-w-md shadow-2xl relative">
            <h3 class="text-xl font-bold text-white mb-2">üóëÔ∏è Borrar Fotos</h3>
            <p class="text-xs text-gray-400 mb-4">Vas a borrar <span id="batch-delete-count" class="text-white font-bold">0</span> im√°genes. Se crear√° una propuesta.</p>
            <textarea id="batch-delete-reason" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-gray-200 text-sm focus:border-red-500 outline-none mb-4 h-24" placeholder="Motivo (Obligatorio)..."></textarea>
            <div class="flex justify-end gap-2">
                <button onclick="closeBatchDeleteModal()" class="text-gray-300 text-sm hover:text-white px-3">Cancelar</button>
                <button onclick="submitBatchDelete()" class="px-4 py-2 bg-red-600 text-white rounded font-bold hover:bg-red-500">Confirmar</button>
            </div>
        </div>
    </div>
    
    <div id="batch-toolbar" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 z-50 bg-gray-900/90 border border-red-500/30 rounded-full px-6 py-2 shadow-xl items-center gap-4 backdrop-blur animate-fade-in-up">
        <span class="text-white text-xs font-bold"><span id="selected-count" class="text-red-400">0</span> seleccionadas</span>
        <button onclick="openBatchDeleteModal()" id="btn-batch-delete" disabled class="text-xs bg-red-600/20 text-red-500 border border-red-900 hover:bg-red-600 hover:text-white px-3 py-1 rounded transition font-bold disabled:opacity-50">üóëÔ∏è BORRAR</button>
        <button onclick="toggleSelectionMode()" class="text-gray-500 hover:text-white ml-2">‚úï</button>
    </div>


    <script>
        function openBatchDeleteModal() {
            const el = document.getElementById('batchDeleteModal');
            el.classList.remove('hidden');
            el.classList.add('flex');
        }
        function closeBatchDeleteModal() {
            const el = document.getElementById('batchDeleteModal');
            el.classList.add('hidden');
            el.classList.remove('flex');
        }
    </script>
    <script>
        let selectionMode = false; let selectedImages = new Set();
        function toggleSelectionMode() {
            selectionMode = !selectionMode;
            const btn = document.getElementById('btn-manage-photos');
            if(btn) btn.classList.toggle('bg-gray-600', selectionMode);
            
            document.querySelectorAll('.selection-checkbox').forEach(el => el.classList.toggle('hidden', !selectionMode));
            document.querySelectorAll('.batch-hide').forEach(el => el.classList.toggle('hidden', selectionMode));
            
            const toolbar = document.getElementById('batch-toolbar');
            toolbar.classList.toggle('hidden', !selectionMode);
            toolbar.classList.toggle('flex', selectionMode);
            
            if(!selectionMode) { selectedImages.clear(); updateSelectionUI(); document.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false); }
        }
        async function toggleImageSelection(fn, cb) {
            if(cb.checked) {
                if(selectedImages.size >= 5) { 
                    cb.checked = false; 
                    await CaosModal.alert("L√≠mite Alcanzado", "M√°ximo 5 im√°genes para borrado en lote."); 
                    return; 
                }
                selectedImages.add(fn);
            } else selectedImages.delete(fn);
            updateSelectionUI();
        }
        function updateSelectionUI() {
            document.getElementById('selected-count').innerText = selectedImages.size;
            document.getElementById('batch-delete-count').innerText = selectedImages.size;
            document.getElementById('btn-batch-delete').disabled = selectedImages.size === 0;
            // Opacity update
            const btn = document.getElementById('btn-batch-delete');
            btn.classList.toggle('opacity-50', selectedImages.size === 0);
        }
        async function submitBatchDelete() {
            const reason = document.getElementById('batch-delete-reason').value;
            if(!reason.trim()) { 
                await CaosModal.alert("Campo Obligatorio", "Debes especificar un motivo para el borrado.");
                return; 
            }
            
            fetch("{% url 'borrar_fotos_batch' jid %}", { 
                method: "POST", 
                headers: { 
                    "Content-Type": "application/json", 
                    "X-CSRFToken": "{{ csrf_token }}" 
                }, 
                body: JSON.stringify({ 
                    filenames: Array.from(selectedImages), 
                    reason: reason,
                    period: '{{ current_period_slug|escapejs }}'
                }) 
            })
            .then(r => r.json())
            .then(async d => { 
                if(d.status === 'ok') location.reload(); 
                else await CaosModal.alert("Error en el Sistema", d.message); 
            });
        }

        async function solicitarBorradoIndividual(jid, filename) {
            const reason = await CaosModal.prompt("üìù Motivo del borrado", "Explica brevemente por qu√© quieres eliminar esta imagen:", "Ej: Imagen duplicada, borrosa...");
            if (reason === null) return;
            
            if (!reason.trim()) { 
                await CaosModal.alert("Motivo Obligatorio", "El motivo del borrado es necesario para procesar la solicitud.");
                return; 
            }
            
            // Construct URL dynamically to avoid linter issues with placeholder strings in django tags if strict
            const baseUrl = "{% url 'borrar_foto' '00000000' 'generic_file' %}"; 
            // Replace placeholders or use a cleaner approach if the view accepts generic args. 
            // Since we can't easily change the Django url pattern here without knowing urls.py, we'll assume the string replacement method specific to this project's pattern:
            // But actually, the safest way is constructing it if we have the view pattern. 
            // Let's stick to the previous method but cleaner:
            const url = `{% url "borrar_foto" "JID_PLACEHOLDER" "FILE_PLACEHOLDER" %}`
                .replace('JID_PLACEHOLDER', jid)
                .replace('FILE_PLACEHOLDER', filename) + "?reason=" + encodeURIComponent(reason);
                
            window.location.href = url;
        }
    </script>
    
    <!-- TIMELINE SNAPSHOT MODAL -->
    <div id="timelineModal" class="hidden fixed inset-0 z-50 items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-gray-900 border border-indigo-900/50 rounded-xl p-6 w-full max-w-2xl shadow-2xl relative max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 sticky top-0 bg-gray-900 pb-2 border-b border-gray-800">
                <h3 class="text-2xl font-bold text-white flex items-center gap-2">
                    üìÖ Proponer Snapshot Temporal
                </h3>
                <button onclick="closeTimelineModal()" class="text-gray-400 hover:text-white text-2xl">‚úï</button>
            </div>
            
            <p class="text-sm text-gray-400 mb-6">
                Crea un snapshot hist√≥rico de esta entidad en un a√±o espec√≠fico. Esto permite documentar c√≥mo era la entidad en diferentes momentos del tiempo.
            </p>
            
            <form id="timelineForm" class="space-y-4">
                <!-- A√±o del Snapshot -->
                <div>
                    <label class="block text-sm font-bold text-gray-300 mb-2">
                        üìÜ A√±o del Snapshot <span class="text-red-400">*</span>
                    </label>
                    <input 
                        type="number" 
                        id="timeline-year" 
                        name="year"
                        min="0" 
                        max="9999" 
                        placeholder="Ej: 1500"
                        class="w-full bg-black/50 border border-gray-700 rounded-lg p-3 text-white focus:border-indigo-500 outline-none"
                        required
                    >
                    <p class="text-xs text-gray-500 mt-1">A√±o en el que ocurre este estado de la entidad</p>
                </div>
                
                <!-- Descripci√≥n del Snapshot -->
                <div>
                    <label class="block text-sm font-bold text-gray-300 mb-2">
                        üìù Descripci√≥n Hist√≥rica <span class="text-red-400">*</span>
                    </label>
                    <textarea 
                        id="timeline-description" 
                        name="description"
                        rows="6"
                        placeholder="Describe c√≥mo era la entidad en este a√±o...&#10;&#10;Ejemplo: En el a√±o 1500, Jade era una pr√≥spera ciudad comercial con una poblaci√≥n de 50,000 habitantes..."
                        class="w-full bg-black/50 border border-gray-700 rounded-lg p-3 text-white focus:border-indigo-500 outline-none resize-none"
                        required
                    ></textarea>
                    <p class="text-xs text-gray-500 mt-1">M√≠nimo 50 caracteres</p>
                </div>
                
                <!-- Metadata del Snapshot -->
                <div>
                    <label class="block text-sm font-bold text-gray-300 mb-2">
                        üèõÔ∏è Metadata del Per√≠odo
                    </label>
                    <div class="space-y-2" id="metadata-fields">
                        <!-- Poblaci√≥n -->
                        <div class="flex gap-2">
                            <input 
                                type="text" 
                                value="poblacion"
                                readonly
                                class="w-1/3 bg-gray-800 border border-gray-700 rounded-lg p-2 text-gray-400 text-sm"
                            >
                            <input 
                                type="text" 
                                id="meta-poblacion"
                                placeholder="Ej: 50000"
                                class="flex-1 bg-black/50 border border-gray-700 rounded-lg p-2 text-white text-sm focus:border-indigo-500 outline-none"
                            >
                        </div>
                        
                        <!-- Gobierno -->
                        <div class="flex gap-2">
                            <input 
                                type="text" 
                                value="gobierno"
                                readonly
                                class="w-1/3 bg-gray-800 border border-gray-700 rounded-lg p-2 text-gray-400 text-sm"
                            >
                            <input 
                                type="text" 
                                id="meta-gobierno"
                                placeholder="Ej: Monarqu√≠a"
                                class="flex-1 bg-black/50 border border-gray-700 rounded-lg p-2 text-white text-sm focus:border-indigo-500 outline-none"
                            >
                        </div>
                        
                        <!-- Estado -->
                        <div class="flex gap-2">
                            <input 
                                type="text" 
                                value="estado"
                                readonly
                                class="w-1/3 bg-gray-800 border border-gray-700 rounded-lg p-2 text-gray-400 text-sm"
                            >
                            <input 
                                type="text" 
                                id="meta-estado"
                                placeholder="Ej: Pr√≥spera"
                                class="flex-1 bg-black/50 border border-gray-700 rounded-lg p-2 text-white text-sm focus:border-indigo-500 outline-none"
                            >
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Propiedades espec√≠ficas de este per√≠odo temporal</p>
                </div>
                
                <!-- Raz√≥n del Cambio -->
                <div>
                    <label class="block text-sm font-bold text-gray-300 mb-2">
                        üí¨ Raz√≥n de la Propuesta
                    </label>
                    <input 
                        type="text" 
                        id="timeline-changelog"
                        name="change_log"
                        placeholder="Ej: A√±adir per√≠odo de expansi√≥n comercial"
                        class="w-full bg-black/50 border border-gray-700 rounded-lg p-3 text-white focus:border-indigo-500 outline-none"
                    >
                </div>
                
                <!-- Botones -->
                <div class="flex justify-end gap-3 pt-4 border-t border-gray-800">
                    <button 
                        type="button"
                        onclick="closeTimelineModal()" 
                        class="px-6 py-2 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg transition"
                    >
                        Cancelar
                    </button>
                    <button 
                        type="submit"
                        class="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg transition shadow-lg"
                    >
                        üì§ Enviar Propuesta
                    </button>
                </div>
            </form>
            
            <!-- Loading State -->
            <div id="timeline-loading" class="hidden absolute inset-0 bg-gray-900/90 flex items-center justify-center rounded-xl">
                <div class="text-center">
                    <div class="animate-spin text-4xl mb-2">‚è≥</div>
                    <p class="text-white font-bold">Enviando propuesta...</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function openTimelineModal() {
            const modal = document.getElementById('timelineModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Reset form
            document.getElementById('timelineForm').reset();
        }
        
        function closeTimelineModal() {
            const modal = document.getElementById('timelineModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        
        // Handle form submission
        document.getElementById('timelineForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form data
            const year = parseInt(document.getElementById('timeline-year').value);
            const description = document.getElementById('timeline-description').value;
            const changeLog = document.getElementById('timeline-changelog').value;
            
            // Validate
            if (!year || year < 0 || year > 9999) {
                await CaosModal.alert("Error", "El a√±o debe estar entre 0 y 9999");
                return;
            }
            
            if (!description || description.length < 50) {
                await CaosModal.alert("Error", "La descripci√≥n debe tener al menos 50 caracteres");
                return;
            }
            
            // Build metadata
            const metadata = {
                datos_nucleo: {}
            };
            
            const poblacion = document.getElementById('meta-poblacion').value;
            const gobierno = document.getElementById('meta-gobierno').value;
            const estado = document.getElementById('meta-estado').value;
            
            if (poblacion) metadata.datos_nucleo.poblacion = poblacion;
            if (gobierno) metadata.datos_nucleo.gobierno = gobierno;
            if (estado) metadata.datos_nucleo.estado = estado;
            
            // Prepare payload
            const payload = {
                year: year,
                description: description,
                metadata: metadata,
                images: [],
                cover_image: null,
                change_log: changeLog || `Snapshot del a√±o ${year}`
            };
            
            // Show loading
            document.getElementById('timeline-loading').classList.remove('hidden');
            
            try {
                const response = await fetch('/api/world/{{ public_id }}/timeline/propose/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                // Hide loading
                document.getElementById('timeline-loading').classList.add('hidden');
                
                if (response.ok && data.success) {
                    await CaosModal.alert(
                        "‚úÖ Propuesta Enviada",
                        `Tu snapshot del a√±o ${year} ha sido enviado para revisi√≥n. ID: ${data.proposal_id}`
                    );
                    closeTimelineModal();
                } else {
                    await CaosModal.alert(
                        "‚ùå Error",
                        data.error || "No se pudo crear la propuesta"
                    );
                }
            } catch (error) {
                document.getElementById('timeline-loading').classList.add('hidden');
                await CaosModal.alert(
                    "‚ùå Error de Conexi√≥n",
                    "No se pudo conectar con el servidor"
                );
            }
        });
        
        // ===================================================================
        // PERIOD MANAGEMENT (New Timeline System)
        // ===================================================================
        
        // Create Period Modal
        function openCreatePeriodModal() {
            CaosModal.custom({
                title: "‚ûï Crear Nuevo Per√≠odo",
                html: `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-300 mb-2">
                                T√≠tulo del Per√≠odo *
                            </label>
                            <input type="text" 
                                   id="period-title" 
                                   placeholder="Ej: Inicios, Expansi√≥n, Guerra Civil..."
                                   class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none"
                                   maxlength="100">
                            <p class="text-xs text-gray-500 mt-1">M√°ximo 100 caracteres</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-bold text-gray-300 mb-2">
                                Descripci√≥n / Lore
                            </label>
                            <textarea id="period-description" 
                                      rows="6"
                                      placeholder="Describe este per√≠odo hist√≥rico..."
                                      class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none resize-none"></textarea>
                        </div>
                        
                        <div id="period-error" class="hidden p-3 bg-red-900/50 border border-red-700 rounded-lg text-red-300 text-sm"></div>
                    </div>
                `,
                confirmText: "‚úÖ Crear Per√≠odo",
                cancelText: "Cancelar",
                onConfirm: async () => {
                    const title = document.getElementById('period-title').value.trim();
                    const description = document.getElementById('period-description').value.trim();
                    
                    // Validation
                    if (!title) {
                        document.getElementById('period-error').textContent = 'El t√≠tulo es obligatorio';
                        document.getElementById('period-error').classList.remove('hidden');
                        return false; // Prevent modal close
                    }
                    
                    try {
                        const response = await fetch(`/api/world/{{ world_id }}/period/create`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({
                                title: title,
                                description: description
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok && data.success) {
                            await CaosModal.alert(
                                "‚úÖ Per√≠odo Creado",
                                `El per√≠odo "${data.period.title}" ha sido creado exitosamente.`
                            );
                            // Reload page to show new period
                            window.location.reload();
                        } else {
                            await CaosModal.alert(
                                "‚ùå Error",
                                data.error || "No se pudo crear el per√≠odo"
                            );
                        }
                    } catch (error) {
                        await CaosModal.alert(
                            "‚ùå Error",
                            "No se pudo conectar con el servidor"
                        );
                    }
                    
                    return true; // Allow modal close
                }
            });
        }
        
        // Edit Period Modal (contextual - edits current viewing period)
        function openEditPeriodModal() {
            const periodTitle = "{{ viewing_period.title|escapejs }}";
            const periodDescription = `{{ viewing_period.description|escapejs }}`;
            const periodId = "{{ viewing_period.id|default:'' }}";
            
            if (!periodId) {
                CaosModal.alert("‚ùå Error", "No se puede editar el per√≠odo ACTUAL desde aqu√≠.");
                return;
            }
            
            CaosModal.custom({
                title: `‚úèÔ∏è Editar: ${periodTitle}`,
                html: `
                    <div class="space-y-4">
                        <div class="p-3 bg-blue-900/30 border border-blue-700/50 rounded-lg text-blue-300 text-sm">
                            üí° Los cambios se enviar√°n como propuesta para revisi√≥n
                        </div>
                        
                        <div>
                            <label class="block text-sm font-bold text-gray-300 mb-2">
                                Nuevo T√≠tulo (opcional)
                            </label>
                            <input type="text" 
                                   id="edit-period-title" 
                                   value="${periodTitle}"
                                   placeholder="Dejar vac√≠o para mantener actual"
                                   class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:border-indigo-500 focus:outline-none"
                                   maxlength="100">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-bold text-gray-300 mb-2">
                                Nueva Descripci√≥n (opcional)
                            </label>
                            <textarea id="edit-period-description" 
                                      rows="8"
                                      placeholder="Dejar vac√≠o para mantener actual"
                                      class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:border-indigo-500 focus:outline-none resize-none">${periodDescription}</textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-bold text-gray-300 mb-2">
                                Raz√≥n del Cambio
                            </label>
                            <input type="text" 
                                   id="edit-change-log" 
                                   placeholder="Ej: Correcci√≥n de fechas, Ampliaci√≥n de lore..."
                                   class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:border-indigo-500 focus:outline-none">
                        </div>

                        <div class="pt-4 border-t border-gray-700">
                            <label class="block text-sm font-bold text-indigo-400 mb-2 uppercase tracking-tighter">
                                üèõÔ∏è Metadatos del Per√≠odo
                            </label>
                            <div id="edit-period-metadata-container" class="space-y-2">
                                <!-- Pre-populated or dynamic metadata here -->
                                <p class="text-xs text-gray-500 italic">Puedes proponer cambios t√©cnicos para esta era.</p>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="text" placeholder="Clave (ej: poblacion)" class="meta-key px-3 py-1 bg-gray-900 border border-gray-700 rounded text-xs text-white">
                                    <input type="text" placeholder="Valor (ej: 10000)" class="meta-val px-3 py-1 bg-gray-900 border border-gray-700 rounded text-xs text-white">
                                </div>
                            </div>
                            <button type="button" onclick="addMetadataRow()" class="mt-2 text-[10px] text-indigo-400 hover:text-white font-bold uppercase">+ A√±adir Propiedad</button>
                        </div>
                    </div>
                `,
                confirmText: "üì§ Enviar Propuesta",
                cancelText: "Cancelar",
                onConfirm: async () => {
                    const newTitle = document.getElementById('edit-period-title').value.trim();
                    const newDescription = document.getElementById('edit-period-description').value.trim();
                    const changeLog = document.getElementById('edit-change-log').value.trim();
                    
                    // Check if anything changed
                    if (newTitle === periodTitle && newDescription === periodDescription) {
                        await CaosModal.alert("‚ö†Ô∏è Sin Cambios", "No has realizado ning√∫n cambio.");
                        return true;
                    }
                    
                    try {
                        // Collect metadata
                        const metaKeys = document.querySelectorAll('.meta-key');
                        const metaVals = document.querySelectorAll('.meta-val');
                        let metadata = {};
                        metaKeys.forEach((k, i) => {
                            if (k.value.trim()) {
                                metadata[k.value.trim()] = metaVals[i].value.trim();
                            }
                        });

                        const response = await fetch(`/api/period/${periodId}/propose`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({
                                title: newTitle !== periodTitle ? newTitle : null,
                                description: newDescription !== periodDescription ? newDescription : null,
                                metadata: metadata,
                                change_log: changeLog
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok && data.success) {
                            await CaosModal.alert(
                                "‚úÖ Propuesta Enviada",
                                `Tu propuesta (v${data.version.version_number}) ha sido enviada para revisi√≥n.`
                            );
                        } else {
                            await CaosModal.alert(
                                "‚ùå Error",
                                data.error || "No se pudo enviar la propuesta"
                            );
                        }
                    } catch (error) {
                        await CaosModal.alert(
                            "‚ùå Error",
                            "No se pudo conectar con el servidor"
                        );
                    }
                    
                    return true;
                }
            });
        }

        function addMetadataRow() {
            const container = document.getElementById('edit-period-metadata-container');
            const div = document.createElement('div');
            div.className = 'grid grid-cols-2 gap-2 mt-2';
            div.innerHTML = `
                <input type="text" placeholder="Clave" class="meta-key px-3 py-1 bg-gray-900 border border-gray-700 rounded text-xs text-white">
                <input type="text" placeholder="Valor" class="meta-val px-3 py-1 bg-gray-900 border border-gray-700 rounded text-xs text-white">
            `;
            container.appendChild(div);
        }
    </script>
{% endblock %}
