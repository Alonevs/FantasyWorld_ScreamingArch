{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ECLAI Universe{% endblock %}</title>
    
    <!-- Shared Tailwind Config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#0a0a12',
                        card: '#161625',
                        accent: '#d633ff',
                        'accent-hover': '#b02ce0',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.6s ease-out forwards',
                    }
                }
            }
        }
    </script>

    <!-- Global Styles -->
    <style>
        [x-cloak] { display: none !important; }
        body { 
            background-color: #05050a; 
            color: #ccc; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }

        /* CAOS DESIGN SYSTEM */
        .caos-card {
            background-color: #0a0a16;
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }

        /* Top Glow Lines */
        .caos-glow-blue::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 2px;
            background: linear-gradient(to right, #3b82f6, #60a5fa, #2563eb);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
            z-index: 10;
        }

        .caos-glow-purple::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 2px;
            background: linear-gradient(to right, #a855f7, #d946ef, #8b5cf6);
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.5);
            z-index: 10;
        }

        /* Tip Box (The light-blue info box in the photo) */
        .caos-tip-box {
            background: rgba(30, 58, 138, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 0.75rem;
            padding: 1rem;
            color: #93c5fd;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.875rem;
        }

        /* Caos Inputs */
        .caos-input {
            background-color: #11111a;
            border: 1px solid #1f2937;
            border-radius: 0.5rem;
            color: white;
            padding: 0.625rem 1rem;
            transition: all 0.3s;
        }
        .caos-input:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.5);
        }

        /* Caos Buttons */
        .caos-button-primary {
            background: linear-gradient(to bottom right, #2563eb, #3b82f6);
            color: white;
            font-weight: 700;
            border-radius: 0.5rem;
            padding: 0.625rem 1.5rem;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .caos-button-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.5);
            filter: brightness(1.1);
        }

        .caos-glow-green::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 2px;
            background: linear-gradient(to right, #22c55e, #4ade80, #16a34a);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.5);
            z-index: 10;
        }

        /* Scrollbar personalizada */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #05050a; }
        ::-webkit-scrollbar-thumb { background: #1f2937; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #374151; }
    </style>
    {% block extra_head %}{% endblock %}
    <!-- Alpine.js -->
    <script src="//unpkg.com/alpinejs" defer></script>
</head>
<body class="bg-dark text-gray-300 min-h-screen pt-20">
    {% include 'components/_admin_bar.html' %}

    <!-- Toast Notifications -->
    <!-- Toast Notifications -->
    {% if messages %}
    <div id="toast-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-[110] w-full max-w-md px-4 pointer-events-none">
        {% for message in messages %}
        <div x-data="{ show: true }" x-show="show" x-init="setTimeout(() => show = false, 4000)" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 -translate-y-2"
             x-transition:enter-end="opacity-100 translate-y-0"
             x-transition:leave="transition ease-in duration-300"
             x-transition:leave-start="opacity-100 translate-y-0"
             x-transition:leave-end="opacity-0 -translate-y-2"
             class="pointer-events-auto mb-3 pl-4 pr-3 py-4 rounded-r-lg border-l-4 text-center shadow-2xl flex items-center justify-center gap-3 relative overflow-hidden
             {% if message.tags == 'success' %}bg-[#0a0f0a] border-l-green-500 border-y border-r border-green-900/30 text-green-400
             {% elif message.tags == 'error' %}bg-[#0f0a0a] border-l-red-500 border-y border-r border-red-900/30 text-red-400
             {% elif message.tags == 'warning' %}bg-[#0f0c0a] border-l-amber-500 border-y border-r border-amber-900/30 text-amber-400
             {% elif message.tags == 'info' %}bg-[#0f0a0a] border-l-blue-500 border-y border-r border-blue-900/30 text-gray-200
             {% else %}bg-[#0a0a10] border-l-gray-500 border-y border-r border-gray-800 text-gray-300{% endif %}">
            
            <div class="flex-1 font-bold text-[10px] uppercase tracking-widest leading-relaxed text-center">{{ message }}</div>
            <button @click="show = false" class="text-white/30 hover:text-white transition p-1 hover:bg-white/10 rounded">‚úï</button>
        </div>
        {% endfor %}
    </div>
    {% endif %}



    <!-- Main Content -->
    {% block content %}
    {% endblock %}

    <!-- Modals Area -->
    {% block modals %}
    {% endblock %}
    
    <!-- Initial Search Modal Overlay -->
    <div x-data="{ 
            open: false, 
            search: '', 
            results: { worlds: [], narratives: [] },
            loading: false,
            fetchResults() {
                if (this.search.length < 2) {
                    this.results = { worlds: [], narratives: [] };
                    return;
                }
                this.loading = true;
                fetch(`/buscar/?q=${this.search}&format=json`)
                    .then(res => res.json())
                    .then(data => {
                        this.results = data;
                        this.loading = false;
                    });
            }
         }" 
         @open-search.window="open = true; $nextTick(() => $refs.searchInput.focus())"
         @keydown.escape.window="open = false">
        
        <!-- Search Modal Overlay -->
        <div id="search-modal" 
             x-show="open" 
             style="display: none;"
         class="fixed inset-0 z-[200] flex items-start justify-center pt-16 px-4 bg-black/95">
            
            <div class="relative w-full max-w-2xl transform transition-all pt-4 caos-card shadow-2xl p-0 overflow-hidden">
                 <!-- Top Glow (Blue for Search) -->
                <div class="absolute top-0 left-0 right-0 h-[2px] bg-linear-to-r from-blue-600 via-cyan-500 to-blue-700 shadow-[0_0_15px_rgba(37,99,235,0.3)]"></div>

                <!-- Search Box -->
                <div class="p-6 border-b border-gray-800 flex items-center gap-4 bg-[#0a0a12]">
                    <span class="text-2xlgrayscale opacity-50">üîç</span>
                    <input x-ref="searchInput" 
                           type="text" 
                           x-model="search" 
                           @input.debounce.300ms="fetchResults()"
                           @keydown.enter="window.location.href = `/buscar/?q=${search}`"
                           placeholder="Buscar en el Nexo (Mundos, Metadatos, Cr√≥nicas...)" 
                           class="w-full bg-[#13151f] border border-gray-800 rounded-lg p-3 text-sm text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500/50 outline-none transition-all placeholder:text-gray-600 font-medium tracking-wide">
                    <button @click="open = false" class="text-[10px] uppercase font-bold text-gray-500 hover:text-white transition-colors border border-gray-800 px-3 py-2 rounded bg-black hover:bg-gray-900">ESC</button>
                </div>

                <!-- Results Area -->
                <div class="max-h-[60vh] overflow-y-auto p-6 space-y-8 custom-scrollbar bg-[#0f111a]">
                    <template x-if="loading">
                        <div class="flex flex-col items-center justify-center py-12 gap-4">
                            <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                            <span class="text-[10px] uppercase tracking-widest text-blue-500 font-bold animate-pulse">Escaneando Nexo...</span>
                        </div>
                    </template>

                    <template x-if="!loading && search.length >= 2">
                        <div class="space-y-8">
                            <!-- Worlds -->
                            <template x-if="results.worlds.length > 0">
                                <div>
                                    <h3 class="text-[10px] font-black text-blue-500 uppercase tracking-[0.2em] mb-4 flex items-center gap-2">
                                        <span class="w-1 h-1 bg-blue-500 rounded-full"></span> Mundos Detectados
                                    </h3>
                                    <div class="grid gap-2">
                                        <template x-for="w in results.worlds" :key="w.id">
                                            <a :href="w.url" class="flex items-center justify-between p-3 bg-[#0a0a10] border border-gray-800 rounded-lg hover:border-blue-500/50 transition-all group">
                                                <div>
                                                    <div class="font-bold text-gray-200 group-hover:text-blue-400 transition-colors uppercase tracking-tight text-sm" x-text="w.name"></div>
                                                    <div class="text-[10px] text-gray-600 font-mono mt-1" x-text="w.match === 'Metadata' ? '>> Match en Metadatos JSONB' : '>> Nombre/Descripci√≥n'"></div>
                                                </div>
                                                <span class="text-gray-700 group-hover:text-blue-500 group-hover:translate-x-1 transition-all text-xs">EXPLORAR ‚Üí</span>
                                            </a>
                                        </template>
                                    </div>
                                </div>
                            </template>

                            <!-- Narratives -->
                            <template x-if="results.narratives.length > 0">
                                <div>
                                    <h3 class="text-[10px] font-black text-purple-500 uppercase tracking-[0.2em] mb-4 flex items-center gap-2">
                                        <span class="w-1 h-1 bg-purple-500 rounded-full"></span> Cr√≥nicas y Lore
                                    </h3>
                                    <div class="grid gap-2">
                                        <template x-for="n in results.narratives" :key="n.id">
                                            <a :href="n.url" class="flex items-center justify-between p-3 bg-[#0a0a10] border border-gray-800 rounded-lg hover:border-purple-500/50 transition-all group">
                                                <div class="font-bold text-gray-200 group-hover:text-purple-400 transition-colors uppercase tracking-tight text-sm" x-text="n.name"></div>
                                                <span class="text-gray-700 group-hover:text-purple-500 group-hover:translate-x-1 transition-all text-xs">LEER ‚Üí</span>
                                            </a>
                                        </template>
                                    </div>
                                </div>
                            </template>

                            <!-- No Results -->
                            <template x-if="results.worlds.length === 0 && results.narratives.length === 0">
                                <div class="py-12 text-center border border-dashed border-gray-800 rounded-lg bg-black/20">
                                    <p class="text-gray-500 font-bold text-sm">No se hallaron coincidencias para "<span x-text="search" class="text-gray-400"></span>"</p>
                                </div>
                            </template>
                        </div>
                    </template>

                    <template x-if="search.length < 2 && !loading">
                        <div class="py-12 text-center opacity-30">
                            <p class="text-[10px] font-bold tracking-widest uppercase">Escribe al menos 2 caracteres para iniciar...</p>
                        </div>
                    </template>
                </div>
                
                <!-- Footer -->
                <div class="p-3 bg-black border-t border-gray-800 flex justify-between items-center text-[9px] text-gray-600 font-bold uppercase tracking-widest">
                    <span class="flex items-center gap-2"><span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Filtro JSONB Activo</span>
                    <span>Presiona <span class="bg-gray-800 px-1 rounded text-gray-400">ENTER</span> para ver todo</span>
                </div>
            </div>
        </div>
    </div>

    <!-- System Modals -->
    {% include 'components/_global_modals.html' %}

    <!-- Global Scripts -->
    <script>
            // Card Slideshow Logic - OVERLAPPING WAVE (SMOOTH RIPPLE)
            const slideshows = document.querySelectorAll('.card-slideshow');
            if (slideshows.length > 0) {
                console.log('Initializing ' + slideshows.length + ' card slideshows with SMOOTH WAVE effect');
                
                // Stagger Time: 1000ms (1s)
                // Creates a clear wave. Transition is 3s, so Card A is 1s into transition when Card B starts.
                const staggerDelay = 1000;
                
                // Fixed Cycle: 25s
                // We ensure the interval is long enough to finish the wave if there are many cards.
                const userInterval = 25000; 
                const intervalDur = Math.max(userInterval, slideshows.length * staggerDelay + 2000); 
                
                console.log(`üåä Wave Config: Stagger ${staggerDelay}ms | Total Interval ${intervalDur}ms`);

                slideshows.forEach((container, index) => {
                    const images = container.querySelectorAll('.slide-img');
                    if (images.length < 2) return;
                    
                    let current = 0;
                    
                    // Initial Delay based on index
                    setTimeout(() => {
                        setInterval(() => {
                            // Fade out current
                            images[current].classList.remove('opacity-100');
                            images[current].classList.add('opacity-0');
                            
                            // Next index
                            current = (current + 1) % images.length;
                            
                            // Fade in next
                            images[current].classList.remove('opacity-0');
                            images[current].classList.add('opacity-100');
                        }, intervalDur);
                    }, index * staggerDelay);
                });
            }
    </script>
    
    {% if user.is_authenticated %}
    <script>
            // Messaging Polling
            function updateUnreadCount() {
                fetch('{% url "unread_count" %}')
                    .then(response => response.json())
                    .then(data => {
                        const count = data.unread_count;
                        const badgeDesktop = document.getElementById('msg-badge-desktop');
                        const badgeMobile = document.getElementById('msg-badge-mobile');
                        
                        if (count > 0) {
                            if (badgeDesktop) badgeDesktop.classList.remove('hidden');
                            if (badgeMobile) {
                                badgeMobile.classList.remove('hidden');
                                badgeMobile.textContent = count;
                            }
                        } else {
                            if (badgeDesktop) badgeDesktop.classList.add('hidden');
                            if (badgeMobile) badgeMobile.classList.add('hidden');
                        }
                    })
                    .catch(error => console.error('Error fetching unread count:', error));
            }
            
            updateUnreadCount();
            setInterval(updateUnreadCount, 30000);
    </script>
    {% endif %}


    <script>
        async function uploadAvatar(input) {
            if (!input.files || !input.files[0]) return;
            
            const formData = new FormData();
            formData.append('avatar', input.files[0]);
            
            try {
                // Initial optimistic feedback
                const notification = document.createElement('div');
                notification.className = 'fixed bottom-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-xl z-[200] flex items-center gap-2 animate-bounce';
                notification.innerHTML = '<span>üîÑ</span> Subiendo avatar...';
                document.body.appendChild(notification);

                const res = await fetch("{% url 'update_avatar' %}", {
                    method: 'POST',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                    body: formData
                });
                
                if(res.ok) {
                    location.reload(); 
                } else {
                    alert("Error al subir imagen");
                    notification.remove();
                }
            } catch(e) {
                console.error(e);
                alert("Error de conexi√≥n");
                if(typeof notification !== 'undefined') notification.remove();
            }
        }
    </script>
</body>
</html>