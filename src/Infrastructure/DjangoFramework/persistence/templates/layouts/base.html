{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ECLAI Universe{% endblock %}</title>
    
    <!-- Shared Tailwind Config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#0a0a12',
                        card: '#161625',
                        accent: '#d633ff',
                        'accent-hover': '#b02ce0',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.6s ease-out forwards',
                    }
                }
            }
        }
    </script>

    <!-- Global Styles -->
    <style>
        body { 
            background-color: #0a0a12; 
            color: #eee; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        /* Scrollbar personalizada */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a12; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
    {% block extra_head %}{% endblock %}
    <!-- Alpine.js -->
    <script src="//unpkg.com/alpinejs" defer></script>
</head>
<body class="bg-dark text-gray-300 min-h-screen pt-20">
    {% include 'components/_admin_bar.html' %}

    <!-- Toast Notifications -->
    <!-- Toast Notifications -->
    {% if messages %}
    <div id="toast-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-[110] w-full max-w-md px-4 pointer-events-none">
        {% for message in messages %}
        <div x-data="{ show: true }" x-show="show" x-init="setTimeout(() => show = false, 4000)" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 -translate-y-2"
             x-transition:enter-end="opacity-100 translate-y-0"
             x-transition:leave="transition ease-in duration-300"
             x-transition:leave-start="opacity-100 translate-y-0"
             x-transition:leave-end="opacity-0 -translate-y-2"
             class="pointer-events-auto mb-3 p-4 rounded-xl border text-center shadow-lg backdrop-blur-md flex items-center justify-between gap-3
             {% if message.tags == 'success' %}bg-green-950/90 border-green-500 text-green-100 shadow-[0_0_15px_rgba(34,197,94,0.3)]
             {% elif message.tags == 'error' %}bg-red-950/90 border-red-500 text-red-100 shadow-[0_0_15px_rgba(239,68,68,0.3)]
             {% elif message.tags == 'warning' %}bg-amber-950/90 border-orange-500 text-orange-100 shadow-[0_0_15px_rgba(249,115,22,0.3)]
             {% else %}bg-gray-800/90 border-gray-500 text-gray-200{% endif %}">
            
            <div class="flex-1 font-bold text-sm">{{ message }}</div>
            <button @click="show = false" class="text-white/50 hover:text-white transition">‚úï</button>
        </div>
        {% endfor %}
    </div>
    {% endif %}



    <!-- Main Content -->
    {% block content %}
    {% endblock %}

    <!-- Modals Area -->
    {% block modals %}
    {% endblock %}
    
    <!-- Initial Search Modal Overlay -->
    <div x-data="{ 
            open: false, 
            search: '', 
            results: { worlds: [], narratives: [] },
            loading: false,
            fetchResults() {
                if (this.search.length < 2) {
                    this.results = { worlds: [], narratives: [] };
                    return;
                }
                this.loading = true;
                fetch(`/buscar/?q=${this.search}&format=json`)
                    .then(res => res.json())
                    .then(data => {
                        this.results = data;
                        this.loading = false;
                    });
            }
         }" 
         @open-search.window="open = true; $nextTick(() => $refs.searchInput.focus())"
         @keydown.escape.window="open = false">
        
        <!-- Search Modal Overlay -->
        <div id="search-modal" 
             x-show="open" 
             style="display: none;"
         class="fixed inset-0 z-[200] flex items-start justify-center pt-16 px-4 bg-black/60 backdrop-blur-sm">
            
            <div class="relative w-full max-w-2xl transform transition-all pt-4">
                <!-- Search Box -->
                <div class="bg-card/40 border border-white/10 rounded-3xl shadow-2xl overflow-hidden backdrop-blur-3xl">
                    <div class="p-6 border-b border-white/5 flex items-center gap-4">
                        <span class="text-2xl">üîç</span>
                        <input x-ref="searchInput" 
                               type="text" 
                               x-model="search" 
                               @input.debounce.300ms="fetchResults()"
                               @keydown.enter="window.location.href = `/buscar/?q=${search}`"
                               placeholder="Buscar en el Nexo (Mundos, Metadatos, Cr√≥nicas...)" 
                               class="w-full bg-transparent text-2xl font-bold text-white placeholder:text-gray-600 focus:outline-none">
                        <button @click="open = false" class="text-gray-500 hover:text-white transition-colors">ESC</button>
                    </div>

                    <!-- Results Area -->
                    <div class="max-h-[60vh] overflow-y-auto p-6 space-y-8 custom-scrollbar">
                        <template x-if="loading">
                            <div class="flex justify-center py-12">
                                <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                            </div>
                        </template>

                        <template x-if="!loading && search.length >= 2">
                            <div class="space-y-8">
                                <!-- Worlds -->
                                <template x-if="results.worlds.length > 0">
                                    <div>
                                        <h3 class="text-[10px] font-black text-gray-500 uppercase tracking-[0.2em] mb-4">Mundos Detectados</h3>
                                        <div class="grid gap-2">
                                            <template x-for="w in results.worlds" :key="w.id">
                                                <a :href="w.url" class="flex items-center justify-between p-4 bg-white/5 border border-white/5 rounded-2xl hover:bg-accent/10 hover:border-accent/30 transition-all group">
                                                    <div>
                                                        <div class="font-bold text-white group-hover:text-accent transition-colors" x-text="w.name"></div>
                                                        <div class="text-[10px] text-gray-500" x-text="w.match === 'Metadata' ? 'Match en Metadatos JSONB' : 'Nombre/Descripci√≥n'"></div>
                                                    </div>
                                                    <span class="text-gray-600 group-hover:text-accent group-hover:translate-x-1 transition-all">‚ûú</span>
                                                </a>
                                            </template>
                                        </div>
                                    </div>
                                </template>

                                <!-- Narratives -->
                                <template x-if="results.narratives.length > 0">
                                    <div>
                                        <h3 class="text-[10px] font-black text-gray-500 uppercase tracking-[0.2em] mb-4">Cr√≥nicas y Lore</h3>
                                        <div class="grid gap-2">
                                            <template x-for="n in results.narratives" :key="n.id">
                                                <a :href="n.url" class="flex items-center justify-between p-4 bg-white/5 border border-white/5 rounded-2xl hover:bg-purple-500/10 hover:border-purple-500/30 transition-all group">
                                                    <div class="font-bold text-white group-hover:text-purple-400 transition-colors" x-text="n.name"></div>
                                                    <span class="text-gray-600 group-hover:text-purple-400 group-hover:translate-x-1 transition-all">‚ûú</span>
                                                </a>
                                            </template>
                                        </div>
                                    </div>
                                </template>

                                <!-- No Results -->
                                <template x-if="results.worlds.length === 0 && results.narratives.length === 0">
                                    <div class="py-12 text-center">
                                        <p class="text-gray-500 font-bold italic">No se hallaron coincidencias para "<span x-text="search" class="text-gray-400"></span>"</p>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <template x-if="search.length < 2 && !loading">
                            <div class="py-12 text-center opacity-30">
                                <p class="text-sm font-bold tracking-widest uppercase">Escribe al menos 2 caracteres...</p>
                            </div>
                        </template>
                    </div>
                    
                    <!-- Footer -->
                    <div class="p-4 bg-black/20 border-t border-white/5 flex justify-between items-center text-[10px] text-gray-500 font-bold uppercase tracking-widest">
                        <span>Filtro JSONB Activo</span>
                        <span>Presiona ENTER para ver todo</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Modals -->
    {% include 'components/_global_modals.html' %}

    <!-- Global Scripts -->
    <script>
            // Card Slideshow Logic - OVERLAPPING WAVE (SMOOTH RIPPLE)
            const slideshows = document.querySelectorAll('.card-slideshow');
            if (slideshows.length > 0) {
                console.log('Initializing ' + slideshows.length + ' card slideshows with SMOOTH WAVE effect');
                
                // Stagger Time: 1000ms (1s)
                // Creates a clear wave. Transition is 3s, so Card A is 1s into transition when Card B starts.
                const staggerDelay = 1000;
                
                // Fixed Cycle: 25s
                // We ensure the interval is long enough to finish the wave if there are many cards.
                const userInterval = 25000; 
                const intervalDur = Math.max(userInterval, slideshows.length * staggerDelay + 2000); 
                
                console.log(`üåä Wave Config: Stagger ${staggerDelay}ms | Total Interval ${intervalDur}ms`);

                slideshows.forEach((container, index) => {
                    const images = container.querySelectorAll('.slide-img');
                    if (images.length < 2) return;
                    
                    let current = 0;
                    
                    // Initial Delay based on index
                    setTimeout(() => {
                        setInterval(() => {
                            // Fade out current
                            images[current].classList.remove('opacity-100');
                            images[current].classList.add('opacity-0');
                            
                            // Next index
                            current = (current + 1) % images.length;
                            
                            // Fade in next
                            images[current].classList.remove('opacity-0');
                            images[current].classList.add('opacity-100');
                        }, intervalDur);
                    }, index * staggerDelay);
                });
            }
    </script>
    
    {% if user.is_authenticated %}
    <script>
            // Messaging Polling
            function updateUnreadCount() {
                fetch('{% url "unread_count" %}')
                    .then(response => response.json())
                    .then(data => {
                        const count = data.unread_count;
                        const badgeDesktop = document.getElementById('msg-badge-desktop');
                        const badgeMobile = document.getElementById('msg-badge-mobile');
                        
                        if (count > 0) {
                            if (badgeDesktop) badgeDesktop.classList.remove('hidden');
                            if (badgeMobile) {
                                badgeMobile.classList.remove('hidden');
                                badgeMobile.textContent = count;
                            }
                        } else {
                            if (badgeDesktop) badgeDesktop.classList.add('hidden');
                            if (badgeMobile) badgeMobile.classList.add('hidden');
                        }
                    })
                    .catch(error => console.error('Error fetching unread count:', error));
            }
            
            updateUnreadCount();
            setInterval(updateUnreadCount, 30000);
    </script>
    {% endif %}


</body>
</html>