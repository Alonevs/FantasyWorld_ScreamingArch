{% extends "layouts/base.html" %}
{% load static %}

{% block title %}{{ narr.titulo }} | Lectura{% endblock %}

{% block extra_head %}
<style>
    /* Estilos espec√≠ficos de modo lectura "Paper" */
    .paper { 
        max-width: 800px; 
        width: 90%;
        margin: 80px auto 40px auto; 
        background: #161620; 
        /* Padding handled by Tailwind (p-8 md:p-12) */
        border-radius: 5px; 
        box-shadow: 0 0 50px rgba(0,0,0,0.5); 
        min-height: 80vh; 
        border: 1px solid #222; 
        font-family: 'Georgia', serif;
        line-height: 1.8;
    }
    .paper h1 {
        font-family: 'Segoe UI', sans-serif;
        color: #d633ff;
        border-bottom: 1px solid #333;
        padding-bottom: 10px;
        margin-bottom: 20px;
        text-align: center;
    }
    .paper-content {
        font-size: 1.15em;
        color: #e0e0e0;
        white-space: pre-wrap;
        text-align: justify;
    }
    .child-card-hover:hover {
        border-left-color: #d633ff;
        background: #1a1a25;
        color: #fff;
        padding-left: 20px;
    }
</style>
{% endblock %}

{% block content %}
    <!-- NAVBAR FLOTANTE -->
    <!-- Ajuste Top: Si hay Admin Bar (Logged in), top-11 (44px). Si no, top-0. -->
    <div class="fixed {% if user.is_authenticated %}top-11{% else %}top-0{% endif %} left-0 w-full bg-[#0e0e16] border-b border-[#333] p-3 px-6 flex justify-between items-center z-40 shadow-lg">
        <div class="font-bold text-[#d633ff] tracking-wide">{{ narr.world.name }}</div>
        <div class="flex gap-2">
            {% if not hide_navigation %}
            <button onclick="history.back()" class="bg-[#333] hover:bg-[#555] text-white px-3 py-1 rounded border border-[#444] transition">‚¨Ö Atr√°s</button>
            <a href="{% url 'ver_narrativa_mundo' narr.world.id %}" class="bg-[#333] hover:bg-[#555] text-white px-3 py-1 rounded border border-[#444] transition">üìú √çndice</a>
            {% endif %}
            
            {% if user.is_superuser or is_admin_role or is_author or allow_proposals %}
                {% if not is_creation_mode and narr.tipo != 'LORE' and not hide_navigation %}
                <a href="{% url 'pre_crear_child' narr.nid 'C' %}" class="bg-[#d633ff] hover:bg-[#b02ce0] text-white px-3 py-1 rounded font-bold transition shadow-lg shadow-purple-900/50">+ CAP√çTULO</a>
                {% endif %}
                
                <button onclick="toggleEdit()" class="bg-[#333] hover:bg-[#555] text-white px-3 py-1 rounded border border-[#444] transition animate-pulse border-accent">‚úèÔ∏è EDITAR</button>
            {% endif %}
        </div>
    </div>

    <!-- DOCUMENTO PRINCIPAL -->
    <div class="paper p-8 md:p-12 mb-20 relative" data-world-id="{{ narr.world.id }}">
        
        <!-- RETOUCH WARNING -->
        {% if is_retouch_mode %}
            <div class="bg-purple-900/90 border border-purple-500 text-purple-100 p-4 rounded mb-8 text-center shadow-[0_0_20px_rgba(168,85,247,0.4)] backdrop-blur">
                <h3 class="font-bold text-lg mb-1">‚úèÔ∏è MODO RETOQUE</h3>
                <p class="text-sm">Est√°s editando una copia visual de tu propuesta rechazada. <br>Realiza las correcciones necesarias y pulsa <strong>Guardar</strong> para enviarla de nuevo.</p>
                <div class="mt-2 text-xs text-purple-300">La navegaci√≥n est√° desactivada para evitar p√©rdidas de datos.</div>
            </div>
        {% endif %}

        <!-- PROPUESTA BANNERS -->
        {% if is_proposal and not is_retouch_mode %}
            <div class="bg-[#d633ff] text-white p-2 rounded mb-6 font-bold text-center shadow">
                üëÅÔ∏è EST√ÅS VIENDO UNA PROPUESTA (v{{ narr.version_id }})
            </div>
        {% endif %}
        
        {% if narr.is_draft and not is_retouch_mode %}
            <div class="bg-orange-500 text-black p-2 rounded mb-6 font-bold text-center shadow">
                üöß PROPUESTA (Pendiente de Aprobaci√≥n)
            </div>
        {% endif %}

        <!-- METADATA HEADER -->
        <div class="flex flex-col md:flex-row justify-center items-center gap-4 text-gray-500 font-mono text-xs mb-8 border-b border-gray-800 pb-6">
            <span class="bg-gray-900/50 px-2 py-1 rounded border border-gray-800">REF: {{ narr.public_id }}</span>
            <span class="bg-gray-900/50 px-2 py-1 rounded border border-gray-800">AUTOR: <span class="text-gray-300">{{ narr.created_by.username|default:"Alone" }}</span></span>
        </div>
        
        <!-- TITLE & CONTENT -->
        <h1 class="text-3xl font-bold break-words">{{ narr.titulo }}</h1>
        
        <div class="paper-content break-words">{{ narr.contenido|default:"(Escribe aqu√≠ tu historia...)" }}</div>
    </div>

    <!-- SECCI√ìN DE HIJOS -->
    <div class="max-w-[800px] mx-auto border-t border-[#333] pt-6 mb-20 animate-fade-in-up">
        {% if published_chapters and narr.tipo != 'LORE' %}
            <h3 class="text-gray-500 font-sans border-b border-[#333] pb-2 mb-4 font-bold tracking-widest text-sm">CONTINUACI√ìN / SUB-CAP√çTULOS</h3>
            
            <div class="space-y-2">
            {% for c in published_chapters %}
                <a href="{% url 'leer_narrativa' c.public_id %}" class="block bg-[#111] p-4 text-gray-400 border-l-[3px] border-[#444] transition-all duration-200 child-card-hover rounded-r">
                    <strong class="text-gray-300">{{ c.titulo }}</strong> <span class="float-right text-xs opacity-50">{{ c.tipo }}</span>
                </a>
            {% endfor %}
            </div>
        {% endif %}

        <!-- Footer Date (As requested: "deja la fecha de nuevo ahi") -->
        <div class="text-right text-gray-600 text-xs mt-8 italic border-t border-gray-900 pt-4">
            √öltima actualizaci√≥n: {{ narr.updated_at|date:"d M Y" }}
        </div>
    </div>

{% endblock %}

{% block modals %}
    {% include "partials/_narrative_editor_modal.html" %}

    <!-- Load Static Logic -->
    <script src="{% static 'js/narrative_editor.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Editor
            const isCreation = {{ is_creation_mode|yesno:"true,false" }};
            const urlParams = new URLSearchParams(window.location.search);
            if(typeof initEditor === 'function') {
                initEditor(isCreation, urlParams.get('edit'));
            } else {
                console.error("narrative_editor.js not loaded properly");
            }
            
            // Cancel button handler
            const cancelBtn = document.getElementById('cancel-btn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    if (isCreation) {
                        history.back();
                    } else {
                        toggleEdit();
                    }
                });
            }
        });

        function toggleEdit() {
            const el = document.getElementById('editor');
            if(el.classList.contains('hidden')) {
                el.classList.remove('hidden');
                el.classList.add('flex');
            } else {
                el.classList.add('hidden');
                el.classList.remove('flex');
            }
        }
    </script>
{% endblock %}