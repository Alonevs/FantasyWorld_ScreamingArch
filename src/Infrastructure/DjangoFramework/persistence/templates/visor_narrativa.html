{% extends "layouts/base.html" %}
{% load static %}

{% block title %}{{ narr.titulo }} | Lectura{% endblock %}

{% block extra_head %}
<style>
    /* Estilos espec√≠ficos de modo lectura "Paper" */
    .paper { 
        max-width: 800px; 
        margin: 80px auto 40px auto; 
        background: #161620; 
        padding: 60px; 
        border-radius: 5px; 
        box-shadow: 0 0 50px rgba(0,0,0,0.5); 
        min-height: 80vh; 
        border: 1px solid #222; 
        font-family: 'Georgia', serif;
        line-height: 1.8;
    }
    .paper h1 {
        font-family: 'Segoe UI', sans-serif;
        color: #d633ff;
        border-bottom: 1px solid #333;
        padding-bottom: 20px;
        margin-bottom: 30px;
    }
    .paper-content {
        font-size: 1.15em;
        color: #e0e0e0;
        white-space: pre-wrap;
    }
    .child-card-hover:hover {
        border-left-color: #d633ff;
        background: #1a1a25;
        color: #fff;
        padding-left: 20px;
    }
</style>
{% endblock %}

{% block content %}
    <!-- NAVBAR FLOTANTE -->
    <div class="fixed top-0 left-0 w-full bg-[#0e0e16] border-b border-[#333] p-3 px-6 flex justify-between items-center z-40 shadow-lg">
        <div class="font-bold text-[#d633ff] tracking-wide">{{ narr.world.name }}</div>
        <div class="flex gap-2">
            <button onclick="history.back()" class="bg-[#333] hover:bg-[#555] text-white px-3 py-1 rounded border border-[#444] transition">‚¨Ö Atr√°s</button>
            <a href="{% url 'ver_narrativa_mundo' narr.world.id %}" class="bg-[#333] hover:bg-[#555] text-white px-3 py-1 rounded border border-[#444] transition">üìú √çndice</a>
            
            {% if not is_creation_mode %}
            <a href="{% url 'pre_crear_child' narr.nid 'C' %}" class="bg-[#d633ff] hover:bg-[#b02ce0] text-white px-3 py-1 rounded font-bold transition shadow-lg shadow-purple-900/50">+ CAP√çTULO</a>
            {% endif %}
            
            <button onclick="toggleEdit()" class="bg-[#333] hover:bg-[#555] text-white px-3 py-1 rounded border border-[#444] transition">‚úèÔ∏è EDITAR</button>
        </div>
    </div>

    <!-- DOCUMENTO PRINCIPAL -->
    <div class="paper" data-world-id="{{ narr.world.id }}">
        {% if is_proposal %}
            <div class="bg-[#d633ff] text-white p-2 rounded mb-6 font-bold text-center shadow">
                üëÅÔ∏è EST√ÅS VIENDO UNA PROPUESTA (v{{ narr.version_id }})
            </div>
        {% endif %}
        
        {% if narr.is_draft %}
            <div class="bg-orange-500 text-black p-2 rounded mb-6 font-bold text-center shadow">
                üöß MODO BORRADOR (Pendiente de Aprobaci√≥n)
            </div>
        {% endif %}

        <div class="flex justify-between text-gray-500 font-mono text-xs mb-8">
            <span>REF: {{ narr.nid }}</span>
            <span>AUTOR: {{ narr.created_by.username|default:"Sistema" }}</span>
        </div>
        
        <h1 class="text-4xl font-bold break-words">{{ narr.titulo }}</h1>
        
        <div class="paper-content break-words">{{ narr.contenido|default:"(Escribe aqu√≠ tu historia...)" }}</div>
    </div>

    <!-- SECCI√ìN DE HIJOS -->
    <div class="max-w-[800px] mx-auto border-t border-[#333] pt-6 mb-20 animate-fade-in-up">
        <h3 class="text-gray-500 font-sans border-b border-[#333] pb-2 mb-4 font-bold tracking-widest text-sm">CONTINUACI√ìN / SUB-CAP√çTULOS</h3>
        
        {% if published_chapters %}
            <div class="space-y-2">
            {% for c in published_chapters %}
                <a href="{% url 'leer_narrativa' c.nid %}" class="block bg-[#111] p-4 text-gray-400 border-l-[3px] border-[#444] transition-all duration-200 child-card-hover rounded-r">
                    <strong class="text-gray-300">{{ c.titulo }}</strong> <span class="float-right text-xs opacity-50">{{ c.tipo }}</span>
                </a>
            {% endfor %}
            </div>
        {% else %}
            <div class="text-center text-gray-600 italic py-8">No hay sub-cap√≠tulos a√∫n.</div>
        {% endif %}
    </div>

{% endblock %}

{% block modals %}
    {% include "partials/_narrative_editor_modal.html" %}

    <!-- Load Static Logic -->
    <script src="{% static 'js/narrative_editor.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Editor
            const isCreation = {{ is_creation_mode|yesno:"true,false" }};
            const urlParams = new URLSearchParams(window.location.search);
            if(typeof initEditor === 'function') {
                initEditor(isCreation, urlParams.get('edit'));
            } else {
                console.error("narrative_editor.js not loaded properly");
            }
            
            // Cancel button handler
            const cancelBtn = document.getElementById('cancel-btn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    if (isCreation) {
                        history.back();
                    } else {
                        toggleEdit();
                    }
                });
            }
        });

        function toggleEdit() {
            const el = document.getElementById('editor');
            if(el.classList.contains('hidden')) {
                el.classList.remove('hidden');
                el.classList.add('flex');
            } else {
                el.classList.add('hidden');
                el.classList.remove('flex');
            }
        }
    </script>
{% endblock %}