
<!-- PERIOD MANAGEMENT (New Timeline System) -->
<script>
    // Create Period Modal
    function openCreatePeriodModal() {
        CaosModal.custom({
            title: "‚ûï Crear Nuevo Per√≠odo",
            html: `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-300 mb-2">
                            T√≠tulo del Per√≠odo *
                        </label>
                        <input type="text" 
                               id="period-title" 
                               placeholder="Ej: Inicios, Expansi√≥n, Guerra Civil..."
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none"
                               maxlength="100">
                        <p class="text-xs text-gray-500 mt-1">M√°ximo 100 caracteres</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-gray-300 mb-2">
                            Descripci√≥n / Lore
                        </label>
                        <textarea id="period-description" 
                                  rows="6"
                                  placeholder="Describe este per√≠odo hist√≥rico..."
                                  class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none resize-none"></textarea>
                    </div>

                    <!-- Future Option -->
                    <div class="flex items-center gap-3 p-3 bg-gray-900 border border-gray-800 rounded-lg">
                        <input type="checkbox" id="period-is-future" class="w-5 h-5 bg-gray-800 border-gray-600 rounded focus:ring-purple-500 text-purple-600">
                        <div>
                            <label for="period-is-future" class="block text-sm font-bold text-white cursor-pointer select-none">
                                üîÆ Marcar como FUTURO / OFFLINE
                            </label>
                            <p class="text-xs text-gray-500">No aparecer√° en la cronolog√≠a p√∫blica hasta que lo actives.</p>
                        </div>
                    </div>
                    
                    <div id="period-error" class="hidden p-3 bg-red-900/50 border border-red-700 rounded-lg text-red-300 text-sm"></div>
                </div>
            `,
            confirmText: "‚úÖ Crear Per√≠odo",
            cancelText: "Cancelar",
            onConfirm: async () => {
                const title = document.getElementById('period-title').value.trim();
                const description = document.getElementById('period-description').value.trim();
                const isFuture = document.getElementById('period-is-future').checked;
                
                // Validation
                if (!title) {
                    document.getElementById('period-error').textContent = 'El t√≠tulo es obligatorio';
                    document.getElementById('period-error').classList.remove('hidden');
                    return false; // Prevent modal close
                }
                
                try {
                    const response = await fetch(`/api/world/{{ public_id }}/period/create`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            title: title,
                            description: description,
                            is_future: isFuture
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        await CaosModal.alert(
                            "‚úÖ Per√≠odo Creado",
                            `El per√≠odo "${data.period.title}" ha sido creado exitosamente.`
                        );
                        // Reload page to show new period
                        window.location.reload();
                    } else {
                        await CaosModal.alert(
                            "‚ùå Error",
                            data.error || "No se pudo crear el per√≠odo"
                        );
                    }
                } catch (error) {
                    await CaosModal.alert(
                        "‚ùå Error",
                        "No se pudo conectar con el servidor"
                    );
                }
                
                return true; // Allow modal close
            }
        });
    }
    
    // Edit Period Modal (contextual - edits current viewing period)
    function openEditPeriodModal() {
        const periodTitle = "{{ viewing_period.title|escapejs }}";
        const periodDescription = `{{ viewing_period.description|escapejs }}`;
        const periodId = "{{ viewing_period.id|default:'' }}";
        const isCurrent = "{{ viewing_period.is_current|yesno:'true,false' }}" === "true";
        
        if (!periodId) {
            CaosModal.alert("‚ùå Error", "No se puede editar el per√≠odo ACTUAL desde aqu√≠.");
            return;
        }
        
        CaosModal.custom({
            title: `‚úèÔ∏è Editar: ${periodTitle}`,
            html: `
                <div class="space-y-4">
                    <div class="p-3 bg-blue-900/30 border border-blue-700/50 rounded-lg text-blue-300 text-sm">
                        üí° Los cambios se enviar√°n como propuesta para revisi√≥n
                    </div>

                    ${!isCurrent ? `
                    <div class="p-4 bg-green-900/20 border border-green-500/30 rounded-lg flex items-center justify-between gap-4">
                        <div>
                            <h4 class="text-green-400 font-bold text-sm uppercase">‚ö° Activar como ACTUAL</h4>
                            <p class="text-xs text-gray-400">Este periodo pasar√° a ser el LIVE. El actual pasar√° a la Historia.</p>
                        </div>
                        <button onclick="activatePeriod('${periodId}')" class="px-3 py-1.5 bg-green-600 hover:bg-green-500 text-white font-bold text-xs rounded shadow-lg transition transform hover:scale-105">
                            ACTIVAR AHORA
                        </button>
                    </div>
                    ` : ''}
                    
                    <div>
                        <label class="block text-sm font-bold text-gray-300 mb-2">
                            Nuevo T√≠tulo (opcional)
                        </label>
                        <input type="text" 
                               id="edit-period-title" 
                               value="${periodTitle}"
                               placeholder="Dejar vac√≠o para mantener actual"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:border-indigo-500 focus:outline-none"
                               maxlength="100">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-gray-300 mb-2">
                            Nueva Descripci√≥n (opcional)
                        </label>
                        <textarea id="edit-period-description" 
                                  rows="8"
                                  placeholder="Dejar vac√≠o para mantener actual"
                                  class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:border-indigo-500 focus:outline-none resize-none">${periodDescription}</textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-gray-300 mb-2">
                            Raz√≥n del Cambio
                        </label>
                        <input type="text" 
                               id="edit-change-log" 
                               placeholder="Ej: Correcci√≥n de fechas, Ampliaci√≥n de lore..."
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:border-indigo-500 focus:outline-none">
                    </div>

                    <div class="pt-4 border-t border-gray-700">
                        <label class="block text-sm font-bold text-indigo-400 mb-2 uppercase tracking-tighter">
                            üèõÔ∏è Metadatos del Per√≠odo
                        </label>
                        <div id="edit-period-metadata-container" class="space-y-2">
                            <!-- Pre-populated or dynamic metadata here -->
                            <p class="text-xs text-gray-500 italic">Puedes proponer cambios t√©cnicos para esta era.</p>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" placeholder="Clave (ej: poblacion)" class="meta-key px-3 py-1 bg-gray-900 border border-gray-700 rounded text-xs text-white">
                                <input type="text" placeholder="Valor (ej: 10000)" class="meta-val px-3 py-1 bg-gray-900 border border-gray-700 rounded text-xs text-white">
                            </div>
                        </div>
                        <button type="button" onclick="addEditMetadataRow()" class="mt-2 text-[10px] text-indigo-400 hover:text-white font-bold uppercase">+ A√±adir Propiedad</button>
                    </div>
                </div>
            `,
            confirmText: "üì§ Enviar Propuesta",
            cancelText: "Cancelar",
            onConfirm: async () => {
                const newTitle = document.getElementById('edit-period-title').value.trim();
                const newDescription = document.getElementById('edit-period-description').value.trim();
                const changeLog = document.getElementById('edit-change-log').value.trim();
                
                // Check if anything changed
                if (newTitle === periodTitle && newDescription === periodDescription) {
                    await CaosModal.alert("‚ö†Ô∏è Sin Cambios", "No has realizado ning√∫n cambio.");
                    return true;
                }
                
                try {
                    // Collect metadata
                    const metaKeys = document.querySelectorAll('.meta-key');
                    const metaVals = document.querySelectorAll('.meta-val');
                    let metadata = {};
                    metaKeys.forEach((k, i) => {
                        if (k.value.trim()) {
                            metadata[k.value.trim()] = metaVals[i].value.trim();
                        }
                    });

                    const response = await fetch(`/api/period/${periodId}/propose`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            title: newTitle !== periodTitle ? newTitle : null,
                            description: newDescription !== periodDescription ? newDescription : null,
                            metadata: metadata,
                            change_log: changeLog
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        await CaosModal.alert(
                            "‚úÖ Propuesta Enviada",
                            `Tu propuesta (v${data.version.version_number}) ha sido enviada para revisi√≥n.`
                        );
                    } else {
                        await CaosModal.alert(
                            "‚ùå Error",
                            data.error || "No se pudo enviar la propuesta"
                        );
                    }
                } catch (error) {
                    await CaosModal.alert(
                        "‚ùå Error",
                        "No se pudo conectar con el servidor"
                    );
                }
                
                return true;
            }
        });
    }

    // Function to Activate Period (Swap Live)
    async function activatePeriod(periodId) {
        if (!confirm("‚ö†Ô∏è ¬øEst√°s seguro? \n\nEsto convertir√° este per√≠odo en el ACTUAL (LIVE). \nEl per√≠odo actual actual pasar√° a ser HIST√ìRICO.")) return;
        
        try {
            const response = await fetch(`/api/period/${periodId}/activate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                await CaosModal.alert("‚úÖ Activado", data.message);
                window.location.href = "{% url 'ver_mundo' public_id %}"; // Redirect to main view
            } else {
                CaosModal.alert("‚ùå Error", data.error || "Fall√≥ la activaci√≥n");
            }
        } catch (error) {
            CaosModal.alert("‚ùå Error", "Error de conexi√≥n");
        }
    }

    // Expose function globally so it can be called from dynamic modal HTML
    window.addEditMetadataRow = function() {
        setTimeout(() => {
            const container = document.getElementById('edit-period-metadata-container');
            if (!container) {
                console.error('Container edit-period-metadata-container not found in DOM');
                return;
            }
            const div = document.createElement('div');
            div.className = 'grid grid-cols-2 gap-2 mt-2';
            div.innerHTML = '<input type="text" placeholder="Clave" class="meta-key px-3 py-1 bg-gray-900 border border-gray-700 rounded text-xs text-white">' +
                            '<input type="text" placeholder="Valor" class="meta-val px-3 py-1 bg-gray-900 border border-gray-700 rounded text-xs text-white">';
            container.appendChild(div);
        }, 50); // Small delay to ensure DOM is ready if called immediately
    };
</script>
