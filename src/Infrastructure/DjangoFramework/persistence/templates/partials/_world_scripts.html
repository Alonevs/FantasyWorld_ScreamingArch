    {{ imagenes|json_script:"imagenes-data" }}
    <script>
        const galleryLog = {};
        const imgsData = JSON.parse(document.getElementById('imagenes-data').textContent);
        
        imgsData.forEach(img => {
            galleryLog[img.filename] = {
                uploader: img.author || '-',
                date: img.date || '-',
                title: img.title || img.filename
            };
        });

        function openEditModal() {
            document.body.style.overflow = 'hidden';
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');
        }
        function closeEditModal() {
            document.body.style.overflow = '';
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
        }

        function openCreateModal() {
            document.body.style.overflow = 'hidden';
            document.getElementById('createModal').classList.remove('hidden');
            document.getElementById('createModal').classList.add('flex');
        }
        function closeCreateModal() {
            document.body.style.overflow = '';
            document.getElementById('createModal').classList.add('hidden');
            document.getElementById('createModal').classList.remove('flex');
        }

        // AI MODAL LOGIC
        let generatedImages = [];

        function openAiModal() {
            document.body.style.overflow = 'hidden';
            document.getElementById('aiModal').classList.remove('hidden');
            document.getElementById('aiModal').classList.add('flex');
            resetAiModal();
        }
        function closeAiModal() {
            document.body.style.overflow = '';
            document.getElementById('aiModal').classList.add('hidden');
            document.getElementById('aiModal').classList.remove('flex');
        }
        
        function resetAiModal() {
            document.getElementById('ai-step-1').classList.remove('hidden');
            document.getElementById('ai-step-loading').classList.add('hidden');
            document.getElementById('ai-step-result').classList.add('hidden');
            generatedImages = [];
            document.getElementById('staging-area').innerHTML = "";
        }

        async function generateBatch() {
            const count = parseInt(document.getElementById('batch-size').value) || 1;
            document.getElementById('ai-step-1').classList.add('hidden');
            document.getElementById('ai-step-loading').classList.remove('hidden');
            
            let errors = [];
            
            for(let i=0; i<count; i++) {
                try {
                    console.log(`üé® Generando imagen ${i+1}/${count}...`);
                    const r = await fetch("{% url 'api_preview_foto' jid %}");
                    
                    if (!r.ok) {
                        console.error(`‚ùå HTTP Error: ${r.status} ${r.statusText}`);
                        errors.push(`Error HTTP ${r.status}: ${r.statusText}`);
                        continue;
                    }
                    
                    const d = await r.json();
                    console.log('üì¶ Respuesta recibida:', d);
                    
                    if(d.status === 'ok' && d.image) {
                        generatedImages.push({ base64: d.image, title: "" });
                        console.log(`‚úÖ Imagen ${i+1} generada correctamente`);
                    } else if (d.status === 'error') {
                        console.error(`‚ùå Error del servidor: ${d.message}`);
                        errors.push(`Error: ${d.message || 'Desconocido'}`);
                    } else {
                        console.error('‚ùå Respuesta inesperada:', d);
                        errors.push('Respuesta inesperada del servidor');
                    }
                } catch(e) { 
                    console.error('‚ùå Exception:', e);
                    errors.push(`Error de red: ${e.message}`);
                }
            }

            document.getElementById('ai-step-loading').classList.add('hidden');
            document.getElementById('ai-step-result').classList.remove('hidden');
            
            // Show errors if any
            if (errors.length > 0 && generatedImages.length === 0) {
                const container = document.getElementById('staging-area');
                container.innerHTML = `
                    <div class="bg-red-900/20 border border-red-500/30 rounded-lg p-4 text-sm">
                        <div class="font-bold text-red-400 mb-2">‚ùå No se pudo generar ninguna imagen</div>
                        <div class="text-red-300 text-xs space-y-1">
                            ${errors.map(e => `<div>‚Ä¢ ${e}</div>`).join('')}
                        </div>
                        <div class="mt-3 text-xs text-gray-400">
                            üí° Verifica la consola del navegador (F12) para m√°s detalles
                        </div>
                    </div>
                `;
            } else {
                renderStagingArea();
            }
        }

        function renderStagingArea() {
            const container = document.getElementById('staging-area');
            container.innerHTML = "";
            
            if(generatedImages.length === 0) {
                container.innerHTML = `<div class="text-gray-500 text-xs italic">No hay im√°genes generadas.</div>`;
                return;
            }

            generatedImages.forEach((img, idx) => {
                const div = document.createElement('div');
                div.className = "relative group border border-gray-700 rounded overflow-hidden";
                div.innerHTML = `
                    <img src="data:image/webp;base64,${img.base64}" class="w-full h-32 object-cover">
                    <button onclick="removeImage(${idx})" class="absolute top-1 right-1 bg-red-600 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition shadow">‚úï</button>
                    <input type="text" placeholder="T√≠tulo..." class="w-full bg-black text-xs text-white p-1 border-t border-gray-700 focus:outline-none" value="${img.title}" onchange="updateTitle(${idx}, this.value)">
                `;
                container.appendChild(div);
            });
            
            document.getElementById('btn-submit-batch').innerText = `üíæ GUARDAR (${generatedImages.length})`;
        }

        function removeImage(idx) {
            generatedImages.splice(idx, 1);
            renderStagingArea();
            if(generatedImages.length === 0) resetAiModal();
        }

        function updateTitle(idx, val) {
            generatedImages[idx].title = val;
        }
        
        async function saveBatch() {
            if(generatedImages.length === 0) return;
            const btn = document.getElementById('btn-submit-batch');
            btn.disabled = true;
            let successCount = 0;
            let total = generatedImages.length;

            for(let i=0; i<total; i++) {
                const img = generatedImages[i];
                btn.innerText = `Enviando ${i+1}/${total}...`;
                try {
                    const t = img.title || "Generado por IA";
                    const response = await fetch("{% url 'api_save_foto' jid %}", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
                        body: JSON.stringify({ 
                            image: img.base64, 
                            title: t,
                            period: '{{ current_period_slug|escapejs }}'
                        })
                    });
                    if (response.ok) successCount++;
                } catch(e) { console.error(e); }
            }
            
            btn.innerText = "Finalizado";
            await CaosModal.alert("Carga Completa", `‚úÖ ${successCount}/${total} im√°genes enviadas a revisi√≥n.`);
            location.reload();
        }
        
        function toggleCustomName() {
            const chk = document.getElementById('chk-original-name');
            const inp = document.getElementById('inp-custom-name');
            inp.disabled = chk.checked;
            inp.style.opacity = chk.checked ? 0.5 : 1;
        }
        
        function confirmUpload() {
            document.getElementById('hidden-use-original').value = document.getElementById('chk-original-name').checked ? 'true' : 'false';
            document.getElementById('hidden-custom-name').value = document.getElementById('inp-custom-name').value;
            document.getElementById('form-manual-upload').submit();
        }
        
        function openUploadModal(input) {
            if (input.files && input.files.length > 0) {
                document.body.style.overflow = 'hidden';
                const modal = document.getElementById('uploadModal');
                const previewContainer = document.getElementById('upload-previews');
                const fileInfo = document.getElementById('file-info');
                const btn = document.getElementById('btn-confirm-upload');
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                btn.classList.remove('hidden');
                
                previewContainer.innerHTML = '';
                fileInfo.innerText = `${input.files.length} archivo(s) seleccionado(s)`;
                
                Array.from(input.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = "w-full h-24 object-cover rounded border border-gray-700";
                        previewContainer.appendChild(img);
                    }
                    reader.readAsDataURL(file);
                });
            }
        }
        
        function closeUploadModal() {
            document.body.style.overflow = '';
            document.getElementById('uploadModal').classList.add('hidden');
            document.getElementById('uploadModal').classList.remove('flex');
            document.getElementById('file-upload').value = "";
        }

        // LIGHTBOX LOGIC
        function openLightbox(url, fn) {
            document.body.style.overflow = 'hidden';
            const lb = document.getElementById('lightbox');
            lb.classList.remove('hidden');
            lb.classList.add('flex');
            document.getElementById('lb-img').src = url;
            document.getElementById('lb-name').innerText = fn;
            const d = galleryLog[fn] || {};
            document.getElementById('lb-title').innerText = d.title || fn;
            document.getElementById('lb-uploader').innerText = d.uploader || "-";
            document.getElementById('lb-date').innerText = d.date || "-";
            document.getElementById('lb-title').dataset.filename = fn;
        }
        
        function closeLightbox() { 
            document.body.style.overflow = '';
            const lb = document.getElementById('lightbox');
            lb.classList.add('hidden');
            lb.classList.remove('flex');
        }
        
        async function editImageTitle() {
            const el = document.getElementById('lb-title');
            const fn = el.dataset.filename;
            // Native prompt -> CaosModal.prompt
            const nt = await CaosModal.prompt("Editar T√≠tulo", "Introduce el nuevo t√≠tulo:", el.innerText);
            
            if(nt) {
                try {
                    const r = await fetch("{% url 'api_update_image_metadata' jid %}", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
                        body: JSON.stringify({ filename: fn, title: nt })
                    });
                    const d = await r.json();
                    
                    if(d.status === 'ok') {
                        el.innerText = nt;
                        if(!galleryLog[fn]) galleryLog[fn] = {};
                        galleryLog[fn].title = nt;
                    } else {
                        await CaosModal.alert("Error", d.message);
                    }
                } catch(e) {
                    await CaosModal.alert("Error de Conexi√≥n", ""+e);
                }
            }
        }
        
        function setAsCover() {
            const filename = document.getElementById('lb-name').innerText;
            if(filename !== "-") window.location.href = "{% url 'set_cover_image' jid '123456' %}".replace('123456', encodeURIComponent(filename));
        }

        async function generateAILore() {
            const btn = document.getElementById('btn-gen-lore');
            const icon = document.getElementById('lore-gen-icon');
            const textarea = document.getElementById('edit-description');
            const originalText = btn.innerHTML;

            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            icon.classList.add('animate-spin');
            btn.innerHTML = 'üïí GENERANDO...';

            try {
                const response = await fetch('/api/ai/generate-lore/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ 
                        world_id: '{{ jid }}',
                        current_description: textarea.value // Send what the user has typed
                    })
                });

                const data = await response.json();
                if (data.success) {
                    textarea.value = data.lore;
                    textarea.classList.add('ring-2', 'ring-accent');
                    setTimeout(() => textarea.classList.remove('ring-2', 'ring-accent'), 2000);
                } else {
                    await CaosModal.alert("Error de IA", data.error || "No se pudo generar el lore.");
                }
            } catch (e) {
                console.error(e);
                await CaosModal.alert("Error de Conexi√≥n", "Aseg√∫rate de que el servidor de IA est√© activo.");
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                icon.classList.remove('animate-spin');
                btn.innerHTML = originalText;
            }
        }
    </script>
