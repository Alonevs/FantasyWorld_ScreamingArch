    {{ imagenes|json_script:"imagenes-data" }}
    <script>
        const galleryLog = {};
        const imgsData = JSON.parse(document.getElementById('imagenes-data').textContent);
        
        imgsData.forEach(img => {
            galleryLog[img.filename] = {
                uploader: img.author || '-',
                date: img.date || '-',
                title: img.title || img.filename
            };
        });

        function openEditModal() {
            document.body.style.overflow = 'hidden';
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');
        }
        function closeEditModal() {
            document.body.style.overflow = '';
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
        }

        function openCreateModal() {
            document.body.style.overflow = 'hidden';
            document.getElementById('createModal').classList.remove('hidden');
            document.getElementById('createModal').classList.add('flex');
        }
        function closeCreateModal() {
            document.body.style.overflow = '';
            document.getElementById('createModal').classList.add('hidden');
            document.getElementById('createModal').classList.remove('flex');
        }

        // AI MODAL LOGIC
        let generatedImages = [];

        function openAiModal() {
            document.body.style.overflow = 'hidden';
            document.getElementById('aiModal').classList.remove('hidden');
            document.getElementById('aiModal').classList.add('flex');
            resetAiModal();
        }
        function closeAiModal() {
            document.body.style.overflow = '';
            document.getElementById('aiModal').classList.add('hidden');
            document.getElementById('aiModal').classList.remove('flex');
        }
        
        function resetAiModal() {
            document.getElementById('ai-step-1').classList.remove('hidden');
            document.getElementById('ai-step-loading').classList.add('hidden');
            document.getElementById('ai-step-result').classList.add('hidden');
            generatedImages = [];
            document.getElementById('staging-area').innerHTML = "";
        }

        async function generateBatch() {
            const count = parseInt(document.getElementById('batch-size').value) || 1;
            document.getElementById('ai-step-1').classList.add('hidden');
            document.getElementById('ai-step-loading').classList.remove('hidden');
            
            for(let i=0; i<count; i++) {
                try {
                    const r = await fetch("{% url 'api_preview_foto' jid %}");
                    const d = await r.json();
                    if(d.status === 'ok') {
                        generatedImages.push({ base64: d.image, title: "" });
                    }
                } catch(e) { console.error(e); }
            }

            document.getElementById('ai-step-loading').classList.add('hidden');
            document.getElementById('ai-step-result').classList.remove('hidden');
            renderStagingArea();
        }

        function renderStagingArea() {
            const container = document.getElementById('staging-area');
            container.innerHTML = "";
            
            if(generatedImages.length === 0) {
                container.innerHTML = `<div class="text-gray-500 text-xs italic">No hay imÃ¡genes generadas.</div>`;
                return;
            }

            generatedImages.forEach((img, idx) => {
                const div = document.createElement('div');
                div.className = "relative group border border-gray-700 rounded overflow-hidden";
                div.innerHTML = `
                    <img src="data:image/webp;base64,${img.base64}" class="w-full h-32 object-cover">
                    <button onclick="removeImage(${idx})" class="absolute top-1 right-1 bg-red-600 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition shadow">âœ•</button>
                    <input type="text" placeholder="TÃ­tulo..." class="w-full bg-black text-xs text-white p-1 border-t border-gray-700 focus:outline-none" value="${img.title}" onchange="updateTitle(${idx}, this.value)">
                `;
                container.appendChild(div);
            });
            
            document.getElementById('btn-submit-batch').innerText = `ðŸ’¾ GUARDAR (${generatedImages.length})`;
        }

        function removeImage(idx) {
            generatedImages.splice(idx, 1);
            renderStagingArea();
            if(generatedImages.length === 0) resetAiModal();
        }

        function updateTitle(idx, val) {
            generatedImages[idx].title = val;
        }
        
        async function saveBatch() {
            if(generatedImages.length === 0) return;
            const btn = document.getElementById('btn-submit-batch');
            btn.disabled = true;
            let successCount = 0;
            let total = generatedImages.length;

            for(let i=0; i<total; i++) {
                const img = generatedImages[i];
                btn.innerText = `Enviando ${i+1}/${total}...`;
                try {
                    const t = img.title || "Generado por IA";
                    const response = await fetch("{% url 'api_save_foto' jid %}", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
                        body: JSON.stringify({ image: img.base64, title: t })
                    });
                    if (response.ok) successCount++;
                } catch(e) { console.error(e); }
            }
            
            btn.innerText = "Finalizado";
            alert(`âœ… ${successCount}/${total} imÃ¡genes enviadas a revisiÃ³n.`);
            location.reload();
        }
        
        function toggleCustomName() {
            const chk = document.getElementById('chk-original-name');
            const inp = document.getElementById('inp-custom-name');
            inp.disabled = chk.checked;
            inp.style.opacity = chk.checked ? 0.5 : 1;
        }
        
        function confirmUpload() {
            document.getElementById('hidden-use-original').value = document.getElementById('chk-original-name').checked ? 'true' : 'false';
            document.getElementById('hidden-custom-name').value = document.getElementById('inp-custom-name').value;
            document.getElementById('form-manual-upload').submit();
        }
        
        function openUploadModal(input) {
            if (input.files && input.files.length > 0) {
                document.body.style.overflow = 'hidden';
                const modal = document.getElementById('uploadModal');
                const previewContainer = document.getElementById('upload-previews');
                const fileInfo = document.getElementById('file-info');
                const btn = document.getElementById('btn-confirm-upload');
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                btn.classList.remove('hidden');
                
                previewContainer.innerHTML = '';
                fileInfo.innerText = `${input.files.length} archivo(s) seleccionado(s)`;
                
                Array.from(input.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = "w-full h-24 object-cover rounded border border-gray-700";
                        previewContainer.appendChild(img);
                    }
                    reader.readAsDataURL(file);
                });
            }
        }
        
        function closeUploadModal() {
            document.body.style.overflow = '';
            document.getElementById('uploadModal').classList.add('hidden');
            document.getElementById('uploadModal').classList.remove('flex');
            document.getElementById('file-upload').value = "";
        }

        // LIGHTBOX LOGIC
        function openLightbox(url, fn) {
            document.body.style.overflow = 'hidden';
            const lb = document.getElementById('lightbox');
            lb.classList.remove('hidden');
            lb.classList.add('flex');
            document.getElementById('lb-img').src = url;
            document.getElementById('lb-name').innerText = fn;
            const d = galleryLog[fn] || {};
            document.getElementById('lb-title').innerText = d.title || fn;
            document.getElementById('lb-uploader').innerText = d.uploader || "-";
            document.getElementById('lb-date').innerText = d.date || "-";
            document.getElementById('lb-title').dataset.filename = fn;
        }
        
        function closeLightbox() { 
            document.body.style.overflow = '';
            const lb = document.getElementById('lightbox');
            lb.classList.add('hidden');
            lb.classList.remove('flex');
        }
        
        function editImageTitle() {
            const el = document.getElementById('lb-title');
            const fn = el.dataset.filename;
            const nt = prompt("Nuevo tÃ­tulo:", el.innerText);
            if(nt) {
                fetch("{% url 'api_update_image_metadata' jid %}", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
                    body: JSON.stringify({ filename: fn, title: nt })
                })
                .then(r => r.json())
                .then(d => {
                    if(d.status === 'ok') {
                        el.innerText = nt;
                        if(!galleryLog[fn]) galleryLog[fn] = {};
                        galleryLog[fn].title = nt;
                    } else alert(d.message);
                });
            }
        }
        
        function setAsCover() {
            const filename = document.getElementById('lb-name').innerText;
            if(filename !== "-") window.location.href = "{% url 'set_cover_image' jid '123456' %}".replace('123456', encodeURIComponent(filename));
        }
    </script>
