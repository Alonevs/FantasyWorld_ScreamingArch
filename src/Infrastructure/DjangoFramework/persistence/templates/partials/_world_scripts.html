    {% load static %}
    {{ imagenes|json_script:"imagenes-data" }}
    <script>
        const galleryLog = {};
        const imgsData = JSON.parse(document.getElementById('imagenes-data').textContent);
        
        imgsData.forEach(img => {
            // FIX: Prepend static path to url for JS usage
            if(img.url && !img.url.startsWith('/static/')) {
                 img.url = "{% static 'persistence/img/' %}" + img.url;
            }

            galleryLog[img.filename] = {
                uploader: img.author || '-',
                date: img.date || '-',
                title: img.title || img.filename
            };
        });

        function openEditModal() {
            document.body.style.overflow = 'hidden';
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');
        }
        function closeEditModal() {
            document.body.style.overflow = '';
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
        }

        function openCreateModal() {
            document.body.style.overflow = 'hidden';
            document.getElementById('createModal').classList.remove('hidden');
            document.getElementById('createModal').classList.add('flex');
        }
        function closeCreateModal() {
            document.body.style.overflow = '';
            document.getElementById('createModal').classList.add('hidden');
            document.getElementById('createModal').classList.remove('flex');
        }

        // AI MODAL LOGIC
        let generatedImages = [];

        function openAiModal() {
            document.body.style.overflow = 'hidden';
            document.getElementById('aiModal').classList.remove('hidden');
            document.getElementById('aiModal').classList.add('flex');
            resetAiModal();
        }
        function closeAiModal() {
            document.body.style.overflow = '';
            document.getElementById('aiModal').classList.add('hidden');
            document.getElementById('aiModal').classList.remove('flex');
        }
        
        function resetAiModal() {
            document.getElementById('ai-step-1').classList.remove('hidden');
            document.getElementById('ai-step-loading').classList.add('hidden');
            document.getElementById('ai-step-result').classList.add('hidden');
            generatedImages = [];
            document.getElementById('staging-area').innerHTML = "";
        }

        async function generateBatch() {
            const count = parseInt(document.getElementById('batch-size').value) || 1;
            document.getElementById('ai-step-1').classList.add('hidden');
            document.getElementById('ai-step-loading').classList.remove('hidden');
            
            let errors = [];
            
            for(let i=0; i<count; i++) {
                try {
                    console.log(`üé® Generando imagen ${i+1}/${count}...`);
                    const r = await fetch("{% url 'api_preview_foto' jid %}");
                    
                    if (!r.ok) {
                        console.error(`‚ùå HTTP Error: ${r.status} ${r.statusText}`);
                        errors.push(`Error HTTP ${r.status}: ${r.statusText}`);
                        continue;
                    }
                    
                    const d = await r.json();
                    console.log('üì¶ Respuesta recibida:', d);
                    
                    if(d.status === 'ok' && d.image) {
                        generatedImages.push({ base64: d.image, title: "" });
                        console.log(`‚úÖ Imagen ${i+1} generada correctamente`);
                    } else if (d.status === 'error') {
                        console.error(`‚ùå Error del servidor: ${d.message}`);
                        errors.push(`Error: ${d.message || 'Desconocido'}`);
                    } else {
                        console.error('‚ùå Respuesta inesperada:', d);
                        errors.push('Respuesta inesperada del servidor');
                    }
                } catch(e) { 
                    console.error('‚ùå Exception:', e);
                    errors.push(`Error de red: ${e.message}`);
                }
            }

            document.getElementById('ai-step-loading').classList.add('hidden');
            document.getElementById('ai-step-result').classList.remove('hidden');
            
            // Show errors if any
            if (errors.length > 0 && generatedImages.length === 0) {
                const container = document.getElementById('staging-area');
                container.innerHTML = `
                    <div class="bg-red-900/20 border border-red-500/30 rounded-lg p-4 text-sm">
                        <div class="font-bold text-red-400 mb-2">‚ùå No se pudo generar ninguna imagen</div>
                        <div class="text-red-300 text-xs space-y-1">
                            ${errors.map(e => `<div>‚Ä¢ ${e}</div>`).join('')}
                        </div>
                        <div class="mt-3 text-xs text-gray-400">
                            üí° Verifica la consola del navegador (F12) para m√°s detalles
                        </div>
                    </div>
                `;
            } else {
                renderStagingArea();
            }
        }

        function renderStagingArea() {
            const container = document.getElementById('staging-area');
            container.innerHTML = "";
            
            if(generatedImages.length === 0) {
                container.innerHTML = `<div class="text-gray-500 text-xs italic">No hay im√°genes generadas.</div>`;
                return;
            }

            generatedImages.forEach((img, idx) => {
                const div = document.createElement('div');
                div.className = "relative group border border-gray-700 rounded overflow-hidden";
                div.innerHTML = `
                    <img src="data:image/webp;base64,${img.base64}" class="w-full h-32 object-cover">
                    <button onclick="removeImage(${idx})" class="absolute top-1 right-1 bg-red-600 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition shadow">‚úï</button>
                    <input type="text" placeholder="T√≠tulo..." class="w-full bg-black text-xs text-white p-1 border-t border-gray-700 focus:outline-none" value="${img.title}" onchange="updateTitle(${idx}, this.value)">
                `;
                container.appendChild(div);
            });
            
            document.getElementById('btn-submit-batch').innerText = `üíæ GUARDAR (${generatedImages.length})`;
        }

        function removeImage(idx) {
            generatedImages.splice(idx, 1);
            renderStagingArea();
            if(generatedImages.length === 0) resetAiModal();
        }

        function updateTitle(idx, val) {
            generatedImages[idx].title = val;
        }
        
        async function saveBatch() {
            if(generatedImages.length === 0) return;
            const btn = document.getElementById('btn-submit-batch');
            btn.disabled = true;
            let successCount = 0;
            let total = generatedImages.length;

            for(let i=0; i<total; i++) {
                const img = generatedImages[i];
                btn.innerText = `Enviando ${i+1}/${total}...`;
                try {
                    const t = img.title || "Generado por IA";
                    const response = await fetch("{% url 'api_save_foto' jid %}", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
                        body: JSON.stringify({ 
                            image: img.base64, 
                            title: t,
                            period: '{{ current_period_slug|escapejs }}'
                        })
                    });
                    if (response.ok) successCount++;
                } catch(e) { console.error(e); }
            }
            
            btn.innerText = "Finalizado";
            await CaosModal.alert("Carga Completa", `‚úÖ ${successCount}/${total} im√°genes enviadas a revisi√≥n.`);
            location.reload();
        }
        
        function toggleCustomName() {
            const chk = document.getElementById('chk-original-name');
            const inp = document.getElementById('inp-custom-name');
            inp.disabled = chk.checked;
            inp.style.opacity = chk.checked ? 0.5 : 1;
        }
        
        function confirmUpload() {
            document.getElementById('hidden-use-original').value = document.getElementById('chk-original-name').checked ? 'true' : 'false';
            document.getElementById('hidden-custom-name').value = document.getElementById('inp-custom-name').value;
            document.getElementById('form-manual-upload').submit();
        }
        
        function openUploadModal(input) {
            if (input.files && input.files.length > 0) {
                document.body.style.overflow = 'hidden';
                const modal = document.getElementById('uploadModal');
                const previewContainer = document.getElementById('upload-previews');
                const fileInfo = document.getElementById('file-info');
                const btn = document.getElementById('btn-confirm-upload');
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                btn.classList.remove('hidden');
                
                previewContainer.innerHTML = '';
                fileInfo.innerText = `${input.files.length} archivo(s) seleccionado(s)`;
                
                Array.from(input.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = "w-full h-24 object-cover rounded border border-gray-700";
                        previewContainer.appendChild(img);
                    }
                    reader.readAsDataURL(file);
                });
            }
        }
        
        function closeUploadModal() {
            document.body.style.overflow = '';
            document.getElementById('uploadModal').classList.add('hidden');
            document.getElementById('uploadModal').classList.remove('flex');
            document.getElementById('file-upload').value = "";
        }

        // LIGHTBOX LOGIC
        let currentImageIndex = 0;

        function openLightbox(url, fn) {
            document.body.style.overflow = 'hidden';
            const lb = document.getElementById('lightbox');
            lb.classList.remove('hidden');
            lb.classList.add('flex');
            
            // Find index
            const idx = imgsData.findIndex(img => img.filename === fn);
            if(idx !== -1) currentImageIndex = idx;
            
            updateLightboxContent(url, fn);
        }
        
        function updateLightboxContent(url, fn) {
            document.getElementById('lb-img').src = url;
            document.getElementById('lb-name').innerText = fn;
            const d = galleryLog[fn] || {};
            document.getElementById('lb-title').innerText = d.title || fn;
            document.getElementById('lb-uploader').innerText = d.uploader || "-";
            document.getElementById('lb-date').innerText = d.date || "-";
            document.getElementById('lb-title').dataset.filename = fn;
            
            // Update Likes
            updateLikeStatus(fn.trim());
            // Update Comments Count
            updateCommentStatus(fn.trim());
        }

        async function updateCommentStatus(filename) {
            const uniqueId = `IMG_${filename.trim()}`; 
            const badge = document.getElementById('lb-comment-count-badge');
            // badge.innerText = "..."; // Optional: show loading state
            
            try {
                const res = await fetch(`{% url 'get_comments' %}?entity_key=${encodeURIComponent(uniqueId)}`);
                const data = await res.json();
                badge.innerText = data.comments.length;
            } catch(e) {
                console.error(e);
                badge.innerText = "-";
            }
        }

        // --- LIKES SYSTEM ---
        async function updateLikeStatus(filename) {
            const uniqueId = `IMG_${filename}`; 
            const star = document.getElementById('lb-star-icon');
            const counter = document.getElementById('lb-like-count');
            
            // Reset UI first (Default: Gray, turns Yellow on Hover)
            star.className = "text-xl text-gray-600 group-hover:text-yellow-400 transition-colors";
            counter.innerText = "...";

            try {
                const res = await fetch(`{% url 'get_like_status' %}?entity_key=${encodeURIComponent(uniqueId)}`);
                const data = await res.json();
                
                counter.innerText = data.count;
                if(data.liked) {
                    // Liked State: Persistent Yellow + Glow
                    star.className = "text-xl text-yellow-400 drop-shadow-[0_0_8px_rgba(250,204,21,0.6)] transition-colors";
                }
                
            } catch(e) {
                console.error("Like Error:", e);
                counter.innerText = "-";
            }
        }

        async function toggleImageLike() {
            const filename = document.getElementById('lb-name').textContent.trim();
            const uniqueId = `IMG_${filename}`;
            console.log("Toggling Like for:", uniqueId);
            const star = document.getElementById('lb-star-icon');
            const counter = document.getElementById('lb-like-count');

            // Optimistic Update
            let currentCount = parseInt(counter.innerText) || 0;
            const isLiked = star.classList.contains('text-yellow-400');
            
            if(isLiked) {
                // Revert to Unliked
                star.className = "text-2xl text-gray-600 group-hover:text-yellow-400 transition-all scale-90 group-hover:scale-110 duration-300";
                counter.innerText = Math.max(0, currentCount - 1);
            } else {
                // Set to Liked
                star.className = "text-2xl text-yellow-400 drop-shadow-[0_0_8px_rgba(250,204,21,0.6)] transition-all scale-110 group-hover:scale-125 group-hover:drop-shadow-[0_0_12px_rgba(250,204,21,0.8)] duration-300";
                counter.innerText = currentCount + 1;
            }

            try {
                const res = await fetch("{% url 'toggle_like' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ entity_key: uniqueId })
                });
                const data = await res.json();
                
                // Re-sync with server truth
                counter.innerText = data.count;
                if(data.liked) {
                    star.className = "text-2xl text-yellow-400 drop-shadow-[0_0_8px_rgba(250,204,21,0.6)] transition-all scale-110 group-hover:scale-125 group-hover:drop-shadow-[0_0_12px_rgba(250,204,21,0.8)] duration-300";
                } else {
                    star.className = "text-2xl text-gray-600 group-hover:text-yellow-400 transition-all scale-90 group-hover:scale-110 duration-300";
                }

            } catch(e) {
                console.error("Like Toggle Error:", e);
            }
        }

        function nextImage() {
            if (imgsData.length === 0) return;
            currentImageIndex = (currentImageIndex + 1) % imgsData.length;
            const img = imgsData[currentImageIndex];
            updateLightboxContent(img.url, img.filename);
        }

        function prevImage() {
            if (imgsData.length === 0) return;
            currentImageIndex = (currentImageIndex - 1 + imgsData.length) % imgsData.length;
            const img = imgsData[currentImageIndex];
            updateLightboxContent(img.url, img.filename);
        }
        
        // Keyboard Nav
        document.addEventListener('keydown', function(event) {
            const lb = document.getElementById('lightbox');
            if (!lb.classList.contains('hidden')) {
                if (event.key === "ArrowRight") nextImage();
                if (event.key === "ArrowLeft") prevImage();
                if (event.key === "Escape") closeLightbox();
            }
        });
        
        function closeLightbox() { 
            document.body.style.overflow = '';
            const lb = document.getElementById('lightbox');
            lb.classList.add('hidden');
            lb.classList.remove('flex');
        }
        
        async function editImageTitle() {
            const el = document.getElementById('lb-title');
            const fn = el.dataset.filename;
            // Native prompt -> CaosModal.prompt
            const nt = await CaosModal.prompt("Editar T√≠tulo", "Introduce el nuevo t√≠tulo:", el.innerText);
            
            if(nt) {
                try {
                    const r = await fetch("{% url 'api_update_image_metadata' jid %}", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
                        body: JSON.stringify({ filename: fn, title: nt })
                    });
                    const d = await r.json();
                    
                    if(d.status === 'ok') {
                        el.innerText = nt;
                        if(!galleryLog[fn]) galleryLog[fn] = {};
                        galleryLog[fn].title = nt;
                    } else {
                        await CaosModal.alert("Error", d.message);
                    }
                } catch(e) {
                    await CaosModal.alert("Error de Conexi√≥n", ""+e);
                }
            }
        }
        
        function setAsCover() {
            const filename = document.getElementById('lb-name').innerText;
            if(filename !== "-") window.location.href = "{% url 'set_cover_image' jid '123456' %}".replace('123456', encodeURIComponent(filename));
        }

        async function generateAILore() {
            const btn = document.getElementById('btn-gen-lore');
            const icon = document.getElementById('lore-gen-icon');
            const textarea = document.getElementById('edit-description');
            const originalText = btn.innerHTML;

            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            icon.classList.add('animate-spin');
            btn.innerHTML = 'üïí GENERANDO...';

            try {
                const response = await fetch('/api/ai/generate-lore/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ 
                        world_id: '{{ jid }}',
                        current_description: textarea.value // Send what the user has typed
                    })
                });

                const data = await response.json();
                if (data.success) {
                    textarea.value = data.lore;
                    textarea.classList.add('ring-2', 'ring-accent');
                    setTimeout(() => textarea.classList.remove('ring-2', 'ring-accent'), 2000);
                } else {
                    await CaosModal.alert("Error de IA", data.error || "No se pudo generar el lore.");
                }
            } catch (e) {
                console.error(e);
                await CaosModal.alert("Error de Conexi√≥n", "Aseg√∫rate de que el servidor de IA est√© activo.");
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                icon.classList.remove('animate-spin');
                btn.innerHTML = originalText;
            }
        }
        async function shareImage() {
            const filename = document.getElementById('lb-name').textContent.trim();
            // Construct absolute URL (assuming current protocol/host)
            // Ideally this would be a permalink to the image view, but for now we link to the file or the world page
            const shareUrl = window.location.origin + document.getElementById('lb-img').getAttribute('src');
            const title = document.getElementById('lb-title').innerText;

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: `Mira esta imagen: ${title}`,
                        text: `Echa un vistazo a "${title}" en El Nexo.`,
                        url: shareUrl
                    });
                } catch (err) {
                    console.log('Share canceled', err);
                }
            } else {
                // Fallback: Copy to clipboard
                try {
                    await navigator.clipboard.writeText(shareUrl);
                    await CaosModal.alert("Enlace Copiado", "El enlace a la imagen se ha copiado al portapapeles.");
                } catch (err) {
                    await CaosModal.alert("Error", "No se pudo copiar el enlace.");
                }
            }
        }


        // --- COMMENTS SYSTEM (Reels Style) ---
        function toggleComments() {
            const overlay = document.getElementById('lb-comments-overlay');
            const isOpen = !overlay.classList.contains('hidden');
            
            if(isOpen) {
                overlay.classList.add('hidden');
            } else {
                overlay.classList.remove('hidden');
                // Load comments for current image
                const filename = document.getElementById('lb-title').dataset.filename;
                
                if(filename) {
                    loadComments(filename);
                }
            }
        }

        async function loadComments(filename) {
            if(!filename) return;
            const uniqueId = `IMG_${filename.trim()}`;
            const container = document.getElementById('lb-comments-list');
            const countSpan = document.getElementById('lb-overlay-count');
            
            container.innerHTML = '<div class="flex justify-center py-10"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div></div>';
            
            try {
                const res = await fetch(`{% url 'get_comments' %}?entity_key=${encodeURIComponent(uniqueId)}`);
                const data = await res.json();
                
                container.innerHTML = '';
                countSpan.innerText = data.comments.length;
                
                // Sync the main badge too
                const mainBadge = document.getElementById('lb-comment-count-badge');
                if(mainBadge) mainBadge.innerText = data.comments.length;

                if(data.comments.length === 0) {
                     container.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-center py-10 opacity-50">
                            <div class="text-4xl mb-2">üí¨</div>
                            <p class="text-sm font-bold text-white">A√∫n no hay comentarios</p>
                            <p class="text-xs text-gray-400">S√© el primero en comenzar la conversaci√≥n.</p>
                        </div>
                     `;
                     return;
                }

                data.comments.forEach(c => {
                    // Random System Avatar Fallback
                    const systemAvatars = [
                        '/static/persistence/img/01/Caos_prime_v1.webp',
                        '/static/persistence/img/0101/Abismos_Prime_v1.webp',
                        '/static/persistence/img/010101/Realidades_v1.webp',
                        '/static/persistence/img/01010101/Galaxia_prime_v2.webp',
                        '/static/persistence/img/0101010101/sistema_prime_v1.png'
                    ];
                    // Hash username to pick consistent random avatar
                    let hash = 0;
                    for (let i = 0; i < c.user.length; i++) hash = c.user.charCodeAt(i) + ((hash << 5) - hash);
                    const avatarIdx = Math.abs(hash) % systemAvatars.length;
                    
                    const fallback = systemAvatars[avatarIdx];
                    
                    const html = `
                        <div class="flex gap-3 items-start animate-fade-in group/item">
                            <img src="${c.pic}" onerror="this.src='${fallback}'" class="w-8 h-8 rounded-full bg-gray-800 object-cover shrink-0 select-none border border-gray-700">
                            <div class="flex flex-col gap-0.5 max-w-[85%]">
                                <div class="flex items-baseline gap-2">
                                    <span class="text-xs font-bold text-gray-300 hover:text-white cursor-pointer transition">${c.user}</span>
                                    <span class="text-[10px] text-gray-500">${c.date}</span>
                                    ${c.can_delete ? `
                                    <button onclick="deleteComment(${c.id})" class="text-gray-600 hover:text-red-500 opacity-0 group-hover/item:opacity-100 transition px-1" title="Borrar comentario">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                    </button>
                                    ` : ''}
                                </div>
                                <p class="text-sm text-gray-200 leading-snug break-words whitespace-pre-wrap">${c.content}</p>
                            </div>
                        </div>
                    `;
                    container.innerHTML += html;
                });
                
                // Scroll to bottom
                container.scrollTop = container.scrollHeight;
                
            } catch(e) {
                console.error(e);
                container.innerHTML = '<div class="text-red-500 text-xs text-center py-4">Error al cargar comentarios.</div>';
            }
        }

        async function deleteComment(id) {
            if(!confirm("¬øBorrar comentario?")) return;
            
            try {
                const res = await fetch("{% url 'delete_comment' %}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                    body: JSON.stringify({ comment_id: id })
                });
                
                if(res.ok) {
                    const filename = document.getElementById('lb-title').dataset.filename;
                    loadComments(filename);
                } else {
                    alert("Error al borrar");
                }
            } catch(e) {
                console.error(e);
            }
        }
        
        // Check for deep link to image
        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const imgToOpen = params.get('open_image');
            if(imgToOpen) {
                // Wait for imgsData to be populated (usually immediate in template)
                // We retry a few times just in case
                let attempts = 0;
                const interval = setInterval(() => {
                    attempts++;
                    if(typeof imgsData !== 'undefined' && imgsData.length > 0) {
                        clearInterval(interval);
                        // Find the image URL from the filename
                        const img = imgsData.find(i => i.filename === imgToOpen);
                        if(img) {
                             openLightbox(img.url, img.filename);
                             // Optional: Open comments immediately
                             toggleComments();
                        }
                    } else if (attempts > 10) {
                        clearInterval(interval);
                    }
                }, 200);
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', checkUrlParams);

        async function postComment() {
            const input = document.getElementById('lb-comment-input');
            const content = input.value.trim();
            if(!content) return;
            
            const filename = document.getElementById('lb-name').innerText.trim();
            const uniqueId = `IMG_${filename}`;
            
            input.disabled = true;
            input.parentElement.classList.add('opacity-50');
            
            try {
                const res = await fetch("{% url 'post_comment' %}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                    body: JSON.stringify({ entity_key: uniqueId, content: content })
                });
                
                if(res.ok) {
                    input.value = '';
                    loadComments(filename); // Reload
                } else {
                    CaosModal.alert("Error", "No se pudo enviar el comentario.");
                }
            } catch(e) {
                console.error(e);
            } finally {
                input.disabled = false;
                input.parentElement.classList.remove('opacity-50');
                input.focus();
            }
        }
    </script>
