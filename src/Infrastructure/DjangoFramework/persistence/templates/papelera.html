{% extends "layouts/base.html" %}

{% block title %}Papelera de Reciclaje | ECLAI{% endblock %}

{% block content %}
<div x-data="{ selectionCount: 0, showModal: false, activeImg: '', activeId: 0 }" @change="selectionCount = document.querySelectorAll('.trash-check:checked').length" class="min-h-screen">

    <!-- HEADER -->
    <div class="max-w-7xl mx-auto px-4 mb-8 mt-12 flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
        <div>
            <h1 class="text-5xl font-black text-white tracking-tighter flex items-center gap-4 mb-2">
                <span>üóëÔ∏è <span class="bg-clip-text text-transparent bg-linear-to-r from-red-500 to-orange-500">PAPELERA</span></span>
            </h1>
            <p class="text-gray-500 text-sm font-medium tracking-wide border-l-2 border-red-500/30 pl-4 uppercase">Centro de Reciclaje y Borrado Definitivo</p>
        </div>

        <!-- NEW PREMIUM FILTERS & ACTIONS BAR -->
        <div class="w-full lg:w-auto flex flex-col sm:flex-row gap-4 items-stretch sm:items-center">
            
            <!-- ALPINE USER SEARCH DROPDOWN (Combobox) -->
            <div x-data="{ 
                open: false, 
                search: '', 
                selectedName: '{% if current_user %}{% for u in users %}{% if u.id == current_user %}{{ u.username }}{% endif %}{% endfor %}{% else %}Todos los Usuarios{% endif %}',
                users: [
                    { id: '', name: 'Todos los Usuarios' },
                    {% for u in users %}{ id: '{{ u.id }}', name: '{{ u.username }}' },{% endfor %}
                ],
                get filteredUsers() {
                    return this.users.filter(u => u.name.toLowerCase().includes(this.search.toLowerCase()))
                }
            }" class="relative min-w-[220px]">
                <label class="block text-[10px] font-black text-gray-500 mb-1.5 uppercase tracking-widest ml-1">üë§ Filtrar Autor</label>
                <div @click="open = !open" class="bg-black/40 backdrop-blur-xl border border-white/10 rounded-xl px-4 py-2.5 flex items-center justify-between cursor-pointer hover:border-red-500/30 transition group shadow-lg">
                    <span class="text-sm font-bold text-gray-300 group-hover:text-white" x-text="selectedName"></span>
                    <span class="text-gray-600 group-hover:text-red-400 transition text-[10px]">‚ñº</span>
                </div>

                <!-- Dropdown Menu -->
                <div x-show="open" @click.away="open = false" 
                     class="absolute top-all mt-2 w-full bg-[#0f111a] border border-gray-800 rounded-xl shadow-2xl z-100 overflow-hidden backdrop-blur-2xl"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0 scale-95"
                     x-transition:enter-end="opacity-100 scale-100">
                    
                    <div class="p-2 border-b border-gray-800">
                        <input type="text" x-model="search" placeholder="Buscar usuario..." 
                               class="w-full bg-black/40 border border-gray-700 rounded-lg px-3 py-1.5 text-xs text-white outline-none focus:border-red-500/50 transition">
                    </div>

                    <div class="max-h-60 overflow-y-auto custom-scrollbar">
                        <template x-for="u in filteredUsers" :key="u.id">
                            <div @click="
                                    $refs.userInput.value = u.id; 
                                    selectedName = u.name; 
                                    open = false; 
                                    $refs.filterForm.submit();"
                                 class="px-4 py-2.5 text-sm text-gray-400 hover:bg-red-500/10 hover:text-white cursor-pointer transition flex items-center justify-between">
                                <span x-text="u.name" :class="u.id == $refs.userInput.value ? 'text-red-400 font-bold' : ''"></span>
                                <span x-show="u.id == $refs.userInput.value" class="text-red-500">‚úì</span>
                            </div>
                        </template>
                    </div>
                </div>

                <form x-ref="filterForm" method="get" class="hidden">
                    <input type="hidden" name="user" x-ref="userInput" value="{{ current_user|default:'' }}">
                </form>
            </div>

            <div class="hidden sm:block h-10 w-px bg-white/5 mx-2"></div>

            <!-- BULK ACTIONS (Grouped) -->
            <div class="flex flex-col gap-1.5">
                <label class="block text-[10px] font-black text-gray-500 mb-1 uppercase tracking-widest ml-1">üóëÔ∏è Acciones Masivas</label>
                <div class="flex gap-2">
                    <button type="submit" form="bulk-trash-form" name="action" value="review"
                            class="flex-1 sm:flex-none px-6 py-2.5 bg-gray-800/80 hover:bg-gray-700 text-gray-300 hover:text-white rounded-xl border border-gray-700 hover:border-blue-500/50 transition flex items-center justify-center gap-2 shadow-xl font-bold text-sm"
                            :disabled="selectionCount === 0">
                        <span>üìã</span> Borrado m√∫ltiple (<span x-text="selectionCount"></span>)
                    </button>

                    <button type="submit" form="bulk-trash-form" name="action" value="hard_delete"
                            class="flex-1 sm:flex-none px-6 py-2.5 bg-red-600/20 hover:bg-red-600 text-red-500 hover:text-white rounded-xl border border-red-900/50 hover:border-red-500/50 transition flex items-center justify-center gap-2 shadow-xl font-black text-sm"
                            :disabled="selectionCount === 0"
                            data-confirm="üíÄ ¬øDeseas eliminar PERMANENTEMENTE todos los elementos seleccionados? Esta acci√≥n es irreversible."
                            data-destructive="true">
                        <span>üíÄ</span> Borrar Permanente
                    </button>
                    
                    {% if current_user %}
                    <a href="{% url 'ver_papelera' %}" class="w-10 h-10 bg-white/5 hover:bg-white/10 text-gray-500 hover:text-white rounded-xl border border-white/5 flex items-center justify-center transition" title="Limpiar Filtros">‚úï</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto pb-24 px-4">
        
        <form id="bulk-trash-form" method="post" action="{% url 'manage_trash_bulk' %}">
            {% csrf_token %}
            
            {% if trash_by_type %}
                <div class="flex flex-col gap-8">
                    
                    {% for type, items in trash_by_type.items %}
                        {% if items %}
                        <div class="bg-card/30 border border-gray-800 rounded-2xl overflow-hidden p-6 relative backdrop-blur-md">
                            
                            <!-- Type Header -->
                            <div class="flex items-center gap-3 mb-6 border-b border-gray-800/50 pb-3">
                                <span class="text-3xl">
                                    {% if type == 'Mundos' %}üåç{% elif type == 'Narrativas' %}üìú{% elif type == 'Imagenes' %}üñºÔ∏è{% elif type == 'Metadatos' %}üß¨{% endif %}
                                </span>
                                <div class="flex flex-col">
                                    <h2 class="text-xl font-bold text-white tracking-wide">{{ type }}</h2>
                                    <span class="text-[10px] text-gray-500 uppercase tracking-widest font-mono">{{ items|length }} elementos archivados</span>
                                </div>
                            </div>

                            <!-- ITEMS LIST -->
                            <div class="grid gap-4">
                                {% for item in items %}
                                    <div class="bg-gray-900/40 border border-gray-800 p-4 rounded-xl flex items-center gap-4 group hover:border-red-500/30 hover:bg-red-950/5 transition duration-300">
                                        
                                        <!-- Selection Checkbox -->
                                        {% if request.user.profile.rank == 'ADMIN' or request.user.is_superuser or request.user == item.author or request.user == item.created_by %}
                                        <input type="checkbox" name="selected_trash_ids" value="{{ item.prefixed_id }}" class="trash-check w-5 h-5 rounded border-gray-700 bg-gray-800 text-red-500 focus:ring-red-500/50 cursor-pointer shadow-inner">
                                        {% endif %}

                                        <!-- Content Info -->
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center gap-2 mb-1">
                                                <span class="text-[9px] font-bold text-gray-600 uppercase border border-gray-800 px-1.5 rounded">{{ item.type_label }}</span>
                                                <h4 class="font-bold text-gray-200 truncate group-hover:text-white transition-colors">
                                                    {% if item.name %}{{ item.name }}{% elif item.titulo %}{{ item.titulo }}{% elif item.target_filename %}{{ item.target_filename }}{% else %}{{ item.id }}{% endif %}
                                                </h4>
                                            </div>
                                            
                                            <div class="text-[10px] text-gray-400 flex flex-wrap gap-2 items-center opacity-70 group-hover:opacity-100 transition-opacity">
                                                <span class="text-red-400/80 font-mono">{{ item.deleted_at|date:"d/m/Y" }}</span>
                                                <span class="text-gray-700">|</span>
                                                <span class="flex items-center gap-1">üë§ <span class="text-gray-300">{% firstof item.author.username item.created_by.username "Alone" %}</span></span>
                                                
                                                {% if item.nice_location or item.nice_level %}
                                                <span class="text-gray-700">|</span>
                                                <span class="text-blue-400/60 font-medium">{% firstof item.nice_location item.nice_level %}</span>
                                                {% endif %}
                                                
                                                {% if item.short_desc %}
                                                <span class="text-gray-700">|</span>
                                                <span class="italic text-gray-500 truncate max-w-xs" title="{{ item.short_desc }}">{{ item.short_desc }}</span>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <!-- Action Buttons (Single row for speed) -->
                                        <div class="flex items-center gap-3 opacity-0 group-hover:opacity-100 transition-all transform translate-x-2 group-hover:translate-x-0">
                                            {% if type == 'Imagenes' %}
                                            <button type="button" 
                                                    @click.prevent="activeImg='{{ item.trash_path }}'; activeId={{ item.id }}; showModal=true;" 
                                                    class="p-2 text-gray-500 hover:text-white hover:bg-gray-800 rounded-lg transition" 
                                                    title="Previsualizar">üëÅÔ∏è</button>
                                            {% endif %}

                                            {% if 'Live' in item.type_label %}
                                                <a href="{% if type == 'Mundos' %}{% url 'restaurar_entidad_fisica' item.id %}{% else %}{% url 'restaurar_narrativa' item.nid %}{% endif %}" 
                                                   class="p-2 text-green-500 hover:bg-green-600 hover:text-white rounded-lg transition" title="Restaurar a Sistema">‚ôªÔ∏è</a>
                                            {% else %}
                                                <!-- Proposals use the version restoration flow -->
                                                <form method="post" action="{% url 'restaurar_version' item.id %}?next={{ request.get_full_path|urlencode }}">
                                                    {% csrf_token %}
                                                    <button type="submit" class="p-2 text-blue-500 hover:bg-blue-600 hover:text-white rounded-lg transition" title="Restaurar a Pendientes">üîÑ</button>
                                                </form>
                                            {% endif %}

                                            <form method="post" action="{% if item.trash_type == 'WORLD_LIVE' %}{% url 'borrar_mundo_definitivo' item.id %}{% elif item.trash_type == 'WORLD_PROP' or item.trash_type == 'METADATA' %}{% url 'borrar_propuesta' item.id %}{% elif item.trash_type == 'NARRATIVE_LIVE' %}{% url 'borrar_narrativa_definitivo' item.nid %}{% elif item.trash_type == 'NARRATIVE_PROP' %}{% url 'borrar_narrativa_version' item.id %}{% else %}{% url 'borrar_imagen_definitivo' item.id %}{% endif %}?next={{ request.get_full_path|urlencode }}">
                                                {% csrf_token %}
                                                <button type="submit" class="p-2 text-red-500 hover:bg-red-600 hover:text-white rounded-lg transition" title="Borrar Permanente" data-confirm="üíÄ ¬øEliminar definitivamente de la base de datos?" data-destructive="true">üíÄ</button>
                                            </form>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-20 bg-card border border-dashed border-gray-800 rounded-xl">
                    <div class="text-6xl mb-4 text-gray-700">üóëÔ∏è</div>
                    <h3 class="text-xl font-bold text-white mb-2">Papelera Vac√≠a</h3>
                    <p class="text-gray-500">No hay elementos eliminados recientemente.</p>
                    <div class="mt-6">
                        <a href="{% url 'dashboard' %}" class="text-blue-400 hover:underline">Ir al Dashboard</a>
                    </div>
                </div>
            {% endif %}
        </form>
        
        <!-- INFO BOX at bottom -->
        <div class="mt-12 p-4 bg-gray-900/50 rounded-xl border border-gray-800 text-center text-sm text-gray-500">
             <p>üí° Tip: Para eliminar im√°genes, puedes seleccionar hasta 5 a la vez para su revisi√≥n final de seguridad.</p>
        </div>
    </div>

    <!-- IMAGE PREVIEW MODAL -->
    <div x-show="showModal" class="fixed inset-0 z-100 flex items-center justify-center bg-black/90 backdrop-blur-sm" style="display: none;"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0">
        
        <div class="relative bg-[#0f111a] p-4 rounded-xl border border-gray-700 max-w-4xl w-full mx-4 shadow-2xl flex flex-col gap-4" @click.away="showModal = false">
            <button @click="showModal = false" class="absolute top-2 right-2 text-gray-500 hover:text-white z-10 text-xl">‚úï</button>
            
            <div class="relative w-full h-[60vh] bg-black rounded-lg overflow-hidden flex items-center justify-center border border-gray-800">
                <img :src="activeImg" class="max-w-full max-h-full object-contain">
            </div>
            
            <div class="flex justify-between items-center bg-black/40 p-3 rounded-lg border border-gray-800">
                <div class="text-gray-400 text-sm font-mono">ID: <span x-text="activeId"></span></div>
                
                <div class="flex gap-4">
                    <!-- Dynamic Links using JS replacement is tricky with Django tags. 
                         Solution: Use a base JS variable or just string concat since we know the URL pattern. -->
                    
                    <a :href="'/papelera/restaurar_imagen/' + activeId + '/'" 
                       class="px-4 py-2 bg-green-600 hover:bg-green-500 text-white font-bold rounded flex items-center gap-2 transition">
                        ‚ôªÔ∏è Restaurar
                    </a>
                    
                    <a :href="'/imagen/propuesta/' + activeId + '/borrar/'" 
                       class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white font-bold rounded flex items-center gap-2 transition">
                        üíÄ Eliminar
                    </a>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}
