{% load static %}
{% load metadata_tags %}
<!-- Component: Proposal Card -->
<!-- Args: item, variant (pending|approved|rejected|archived), target_url_prefix (optional) -->
<!-- Styling Variants -->

<div class="bg-card p-6 rounded-xl shadow-lg flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 relative group transition-all duration-300
    {% if variant == 'rejected' %}grayscale hover:grayscale-0 opacity-60 hover:opacity-100 border border-red-900/20
    {% elif variant == 'archived' %}opacity-50 hover:opacity-100 border border-gray-800
    {% elif item.action == 'DELETE' or item.cambios.action == 'DELETE' %}border border-red-600 bg-red-900/10
    {% elif item.cambios.action == 'SET_COVER' %}border border-yellow-600 bg-yellow-900/10
    {% elif variant == 'approved' %}border border-green-900/30 opacity-75 hover:opacity-100
    {% elif item.type == 'WORLD' %}border border-blue-900/30
    {% else %}border border-purple-900/30
    {% endif %}">

    <!-- Status Badges (Absolute) -->
    {% if item.action == 'DELETE' or item.cambios.action == 'DELETE' %}
        <div class="absolute -top-3 left-6 bg-red-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg z-20">
            ğŸ—‘ï¸ SOLICITUD DE ELIMINACIÃ“N
        </div>
    {% elif item.cambios.action == 'SET_COVER' %}
        <div class="absolute -top-3 left-6 bg-yellow-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg z-20">
            ğŸ“¸ PROPUESTA DE PORTADA
        </div>
    {% elif item.cambios.action == 'TOGGLE_VISIBILITY' %}
        <div class="absolute -top-3 left-6 bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg z-20">
            ğŸ‘ï¸ CAMBIO VISIBILIDAD
        </div>
    {% elif item.cambios.properties %}
         <div class="absolute -top-3 left-6 {% if variant == 'approved' %}bg-green-600{% else %}bg-purple-600{% endif %} text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg z-20">
            ğŸ§¬ PROPUESTA DE METADATOS
        </div>
    {% elif item.cambios.action == 'RESTORE' %}
         <div class="absolute -top-3 left-6 bg-green-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg z-20">
            â™»ï¸ SOLICITUD DE RESTAURACIÃ“N
        </div>
    {% endif %}

    <!-- Checkbox -->
    <div class="absolute top-4 right-4 lg:static lg:mr-2">
        <input type="checkbox" aria-label="Seleccionar propuesta {{ item.target_name }}" name="{% if item.type == 'WORLD' %}selected_ids{% else %}selected_narr_ids{% endif %}" value="{{ item.id }}" class="w-5 h-5 accent-red-600 cursor-pointer item-checkbox" onchange="updateFloatingBar()">
    </div>

    <!-- Main Content -->
    <div class="grow min-w-0">
        <div class="flex items-center gap-3 mb-1 flex-wrap">
            <span class="{% if variant == 'approved' %}bg-green-900/30 text-green-500 border-green-800
                         {% elif variant == 'rejected' %}text-red-500
                         {% elif variant == 'archived' %}bg-gray-800 text-gray-400 border-gray-700
                         {% else %}bg-yellow-900/30 text-yellow-500 border-yellow-800{% endif %} 
                         text-xs font-bold px-2 py-1 rounded border">v{{ item.version_number }}</span>
            
            {% if item.parent_context %}
                <span class="bg-indigo-900/30 text-indigo-300 text-xs font-mono px-2 py-1 rounded border border-indigo-800 flex items-center gap-1">
                    ğŸ“ {{ item.parent_context }}
                </span>
            {% endif %}
            
            <h2 class="text-xl font-bold {% if variant == 'archived' or variant == 'rejected' %}text-gray-300{% else %}text-white{% endif %} break-all">{{ item.target_name }}</h2>
            
            {% if item.type == 'WORLD' %}
                <span class="text-gray-500 text-sm">para <a href="{% url 'ver_mundo' item.target_link %}" class="text-accent hover:underline">{{ item.world.name }}</a></span>
                <span class="text-xs bg-blue-900/30 text-blue-400 px-2 py-0.5 rounded border border-blue-800">{{ item.type_label }}</span>
            {% else %}
                <span class="text-gray-500 text-sm">en <a href="{% url 'ver_mundo' item.narrative.world.public_id|default:item.narrative.world.id %}" class="text-accent hover:underline">{{ item.narrative.world.name }}</a></span>
                <span class="text-xs bg-purple-900/30 text-purple-400 px-2 py-0.5 rounded border border-purple-800">{{ item.type_label }}</span>
            {% endif %}
        </div>
        
        <p class="text-gray-400 text-sm mb-2 line-clamp-2 wrap-break-word">{{ item.target_desc|striptags|truncatewords:20 }}</p>
        
        <div class="flex gap-4 text-xs text-gray-500 font-mono">
            <span>ğŸ‘¤ {{ item.author.username|default:"Sistema" }}</span>
            <span>ğŸ“… {{ item.created_at|date:"d/m/Y H:i" }}</span>
            {% if variant == 'rejected' %}<span>âŒ Rechazado el {{ item.created_at|date:"d/m/Y" }}</span>{% endif %}
            {% if variant == 'archived' %}<span>ğŸ“¦ Archivado el {{ item.created_at|date:"d/m/Y" }}</span>{% endif %}
        </div>

        <!-- Metadata Changes -->
        {% if item.cambios.properties %}
        {% diff_metadata item.world.metadata item.cambios.properties as diff_props %}
        
        <div class="mt-3 bg-opacity-10 border rounded p-3 {% if variant == 'approved' %}bg-purple-900 border-green-500/20{% else %}bg-purple-900 border-purple-500/20{% endif %}">
            <h4 class="text-[10px] {% if variant == 'approved' %}text-green-400{% else %}text-purple-400{% endif %} font-bold uppercase tracking-widest mb-2">ğŸ§¬ Cambios Detectados</h4>
            <div class="flex flex-wrap gap-x-4 gap-y-2 text-xs font-mono text-gray-300">
                {% for prop in diff_props %}
                <div class="flex gap-1 items-center px-1 rounded
                    {% if prop.status == 'added' %}text-green-400
                    {% elif prop.status == 'modified' %}text-yellow-400
                    {% elif prop.status == 'deleted' %}text-red-500 line-through bg-red-900/20
                    {% endif %}">
                    <span class="opacity-60">{{ prop.key }}:</span>
                    <span class="font-bold ml-1">{{ prop.value }}</span>
                    {% if prop.status == 'added' %} <span class="text-[10px] ml-1 opacity-50">(+)</span>{% endif %}
                    {% if prop.status == 'modified' %} <span class="text-[10px] ml-1 opacity-50">(Edit)</span>{% endif %}
                </div>
                {% empty %}
                <!-- Fallback if diff is empty but properties exist (shouldn't happen) -->
                 {% for prop in item.cambios.properties %}
                    <span class="text-gray-400">{{ prop.key }}: {{ prop.value }}</span>
                 {% endfor %}
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if item.change_log %}
        <div class="mt-2 text-sm {% if variant == 'rejected' %}text-gray-400 bg-gray-900/30{% else %}text-gray-300 bg-gray-900/50{% endif %} p-2 rounded border border-gray-700">
            <span class="text-xs text-gray-500 font-bold uppercase block mb-1">RazÃ³n:</span>
            "{{ item.change_log }}"
        </div>
        {% endif %}
    </div>

    <!-- Actions Buttons -->
    <div class="flex gap-3 shrink-0">
        <!-- VIEW BUTTON -->
        {% if item.type == 'WORLD' %}
            <a href="{% url 'revisar_version' item.id %}" class="px-4 py-2 bg-blue-900/20 hover:bg-blue-600 text-blue-400 hover:text-white rounded-lg border border-blue-900/50 transition font-bold text-sm">ğŸ‘ï¸ {% if variant == 'pending' %}Revisar{% else %}Ver{% endif %}</a>
        {% else %}
            <a href="{% url 'revisar_narrativa_version' item.id %}" class="px-4 py-2 bg-blue-900/20 hover:bg-blue-600 text-blue-400 hover:text-white rounded-lg border border-blue-900/50 transition font-bold text-sm">ğŸ‘ï¸ {% if variant == 'pending' %}Ver{% else %}Ver{% endif %}</a>
        {% endif %}

        <!-- CONTEXTUAL BUTTONS -->
        {% if variant == 'pending' %}
            {% if item.type == 'WORLD' %}
                <a href="{% url 'aprobar_propuesta' item.id %}" class="px-4 py-2 bg-green-900/20 hover:bg-green-600 text-green-400 hover:text-white rounded-lg border border-green-900/50 transition font-bold shadow-lg shadow-green-900/20" data-confirm="Â¿Aprobar esta propuesta?">âœ… Aprobar</a>
                <a href="{% url 'rechazar_propuesta' item.id %}" class="px-4 py-2 bg-red-900/20 hover:bg-red-600 text-red-400 hover:text-white rounded-lg border border-red-900/50 transition font-bold" data-confirm="Â¿Rechazar esta propuesta?" data-destructive="true">âœ• Rechazar</a>
            {% else %}
                <a href="{% url 'aprobar_narrativa' item.id %}" class="px-4 py-2 bg-green-900/20 hover:bg-green-600 text-green-400 hover:text-white rounded-lg border border-green-900/50 transition font-bold shadow-lg shadow-green-900/20" data-confirm="Â¿Aprobar esta narrativa?">âœ… Aprobar</a>
                <a href="{% url 'rechazar_narrativa' item.id %}" class="px-4 py-2 bg-red-900/20 hover:bg-red-600 text-red-400 hover:text-white rounded-lg border border-red-900/50 transition font-bold" data-confirm="Â¿Rechazar esta narrativa?" data-destructive="true">âœ• Rechazar</a>
            {% endif %}
        
        {% elif variant == 'approved' %}
             {% if item.type == 'WORLD' %}
                <a href="{% url 'publicar_version' item.id %}" class="px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg shadow-lg shadow-green-900/50 transition font-bold flex items-center gap-2" data-confirm="Â¿PUBLICAR esta versiÃ³n a LIVE? Esto sobreescribirÃ¡ los datos actuales.">
                    ğŸš€ PUBLICAR
                </a>
            {% else %}
                <a href="{% url 'publicar_narrativa' item.id %}" class="px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg shadow-lg shadow-green-900/50 transition font-bold flex items-center gap-2" data-confirm="Â¿PUBLICAR esta narrativa a LIVE?">
                    ğŸš€ PUBLICAR
                </a>
            {% endif %}

        {% elif variant == 'archived' %}
            {% if item.type == 'WORLD' %}
                <a href="{% url 'restaurar_version' item.id %}" class="px-3 py-1 bg-yellow-900/20 hover:bg-yellow-600 text-yellow-500 hover:text-white rounded border border-yellow-900/50 text-xs font-bold transition" data-confirm="Â¿RESTAURAR esta versiÃ³n? Se crearÃ¡ una nueva propuesta basada en ella.">
                    ğŸ”„ Restaurar
                </a>
            {% else %}
                 <a href="{% url 'restaurar_narrativa' item.id %}" class="px-3 py-1 bg-yellow-900/20 hover:bg-yellow-600 text-yellow-500 hover:text-white rounded border border-yellow-900/50 text-xs font-bold transition" data-confirm="Â¿RESTAURAR esta versiÃ³n? Se crearÃ¡ una nueva propuesta basada en ella.">
                    ğŸ”„ Restaurar
                </a>
            {% endif %}
        {% endif %}

        <!-- DELETE ALWAYS AVAILABLE -->
        {% if item.type == 'WORLD' %}
            <a href="{% url 'borrar_propuesta' item.id %}" class="px-4 py-2 bg-gray-800 hover:bg-red-600 text-gray-400 hover:text-white rounded-lg border border-gray-700 transition font-bold" data-confirm="âš ï¸ Â¿BORRAR DEFINITIVAMENTE? No se podrÃ¡ recuperar." data-destructive="true">ğŸ—‘ï¸</a>
        {% else %}
             <a href="{% url 'borrar_narrativa_version' item.id %}" class="px-4 py-2 bg-gray-800 hover:bg-red-600 text-gray-400 hover:text-white rounded-lg border border-gray-700 transition font-bold" data-confirm="âš ï¸ Â¿BORRAR DEFINITIVAMENTE? No se podrÃ¡ recuperar." data-destructive="true">ğŸ—‘ï¸</a>
        {% endif %}
    </div>

</div>
